<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>simba_plus.model_prox API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../simba_plus.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;simba_plus</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#LightningProxModel">LightningProxModel</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LightningProxModel.__init__">LightningProxModel</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.nonneg">nonneg</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.data">data</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.learning_rate">learning_rate</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.encoder">encoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.decoder">decoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.hsic">hsic</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.n_no_kl">n_no_kl</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.n_count_nodes">n_count_nodes</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.n_kl_warmup">n_kl_warmup</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.nll_scale">nll_scale</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.val_nll_scale">val_nll_scale</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.num_nodes_dict">num_nodes_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.train_data_dict">train_data_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.reweight_rarecell">reweight_rarecell</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.edgetype_loss_weight_dict">edgetype_loss_weight_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.node_weights_dict">node_weights_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.bias_dict">bias_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.scale_dict">scale_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.std_dict">std_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.num_neg_samples_fold">num_neg_samples_fold</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.validation_step_outputs">validation_step_outputs</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_train_start">on_train_start</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.encode">encode</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.reparametrize">reparametrize</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.project">project</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.relational_recon_loss">relational_recon_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.relational_kl_divergence">relational_kl_divergence</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.kl_div_loss">kl_div_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.nll_loss">nll_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.training_step">training_step</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.validation_step">validation_step</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.mean_cell_neighbor_distance">mean_cell_neighbor_distance</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_train_epoch_start">on_train_epoch_start</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.configure_optimizers">configure_optimizers</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.lr_scheduler_step">lr_scheduler_step</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_save_checkpoint">on_save_checkpoint</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../simba_plus.html">simba_plus</a><wbr>.model_prox    </h1>

                
                        <input id="mod-model_prox-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-model_prox-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.optim.lr_scheduler</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReduceLROnPlateau</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">L</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.distributions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Distribution</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">HeteroData</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">EdgeType</span><span class="p">,</span> <span class="n">NodeType</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.encoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransEncoder</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="c1"># from simba_plus.utils import negative_sampling</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">negative_sampling</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.losses</span><span class="w"> </span><span class="kn">import</span> <span class="n">bernoulli_kl_loss</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.decoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">RelationalEdgeDistributionDecoder</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus._utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>    <span class="n">add_cov_to_latent</span><span class="p">,</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>    <span class="n">make_key</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="n">update_lr</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="p">)</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.evaluation_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>    <span class="n">compute_reconstruction_gene_metrics</span><span class="p">,</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>    <span class="n">compute_classification_metrics</span><span class="p">,</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>    <span class="n">plot_nll_distributions</span><span class="p">,</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LightningProxModel</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>        <span class="n">encoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">TransEncoder</span><span class="p">,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="n">n_hidden_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>        <span class="n">n_latent_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>        <span class="n">decoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">RelationalEdgeDistributionDecoder</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="n">num_neg_samples_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>        <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="n">project_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>        <span class="n">edgetype_specific_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>        <span class="n">edgetype_specific_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>        <span class="n">edgetype_specific_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>        <span class="n">edge_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="n">hsic</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>        <span class="n">n_no_kl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>        <span class="n">n_count_nodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>        <span class="n">n_kl_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>        <span class="n">nll_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>        <span class="n">val_nll_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="n">node_weights_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="n">nonneg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="n">reweight_rarecell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="n">reweight_rarecell_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>        <span class="n">positive_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="n">train_data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="n">val_data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>    <span class="p">):</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_hyperparameters</span><span class="p">()</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="n">data</span><span class="o">.</span><span class="n">generate_ids</span><span class="p">()</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nonneg</span> <span class="o">=</span> <span class="n">nonneg</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder_class</span><span class="p">(</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>            <span class="n">n_hidden_dims</span><span class="p">,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>            <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>            <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="p">)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder_class</span><span class="p">(</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="n">project</span><span class="o">=</span><span class="n">project_decoder</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>            <span class="n">edgetype_specific_bias</span><span class="o">=</span><span class="n">edgetype_specific_bias</span><span class="p">,</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>            <span class="n">edgetype_specific_scale</span><span class="o">=</span><span class="n">edgetype_specific_scale</span><span class="p">,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>            <span class="n">edgetype_specific_std</span><span class="o">=</span><span class="n">edgetype_specific_std</span><span class="p">,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            <span class="n">positive_scale</span><span class="o">=</span><span class="n">positive_scale</span><span class="p">,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="o">=</span> <span class="n">hsic</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>            <span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span> <span class="o">=</span> <span class="n">n_no_kl</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_count_nodes</span> <span class="o">=</span> <span class="n">n_count_nodes</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">=</span> <span class="n">n_kl_warmup</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span> <span class="o">=</span> <span class="n">nll_scale</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span> <span class="o">=</span> <span class="n">val_nll_scale</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>            <span class="n">node_type</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">node_type</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">x_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="p">}</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_data_dict</span> <span class="o">=</span> <span class="n">train_data_dict</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="k">if</span> <span class="n">train_data_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_subgraph</span><span class="p">(</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>                <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">train_data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="n">train_val_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">train_data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>                <span class="n">train_val_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">train_data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">val_data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_val_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_subgraph</span><span class="p">(</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>                <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">train_val_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span> <span class="o">=</span> <span class="n">reweight_rarecell</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="k">if</span> <span class="n">reweight_rarecell_neighbors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>                <span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="n">reweight_rarecell_neighbors</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="n">edge_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">edge_types</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>            <span class="n">edgetype</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">num_edges</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">)</span>  <span class="c1"># mean $ edges</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">edgetype</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>            <span class="k">for</span> <span class="n">edgetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="p">}</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="n">node_weights_dict</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="c1"># Batch correction for RNA-seq data</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">:</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>            <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="k">if</span> <span class="n">edgetype_specific_bias</span><span class="p">:</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>                <span class="n">src_bias_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>                <span class="n">dst_bias_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>                <span class="n">src_bias_key</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>                <span class="n">dst_bias_key</span> <span class="o">=</span> <span class="n">dst</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>            <span class="k">if</span> <span class="n">edgetype_specific_scale</span><span class="p">:</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>                <span class="n">src_scale_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>                <span class="n">dst_scale_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>                <span class="n">src_scale_key</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>                <span class="n">dst_scale_key</span> <span class="o">=</span> <span class="n">dst</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>            <span class="k">if</span> <span class="n">edgetype_specific_std</span><span class="p">:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>                <span class="n">src_std_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>                <span class="n">dst_std_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>                <span class="n">src_std_key</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>                <span class="n">dst_std_key</span> <span class="o">=</span> <span class="n">dst</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                <span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                <span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">src_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>                <span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">dst_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>                <span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_std_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>                <span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_std_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                <span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">):</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>                <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>                <span class="n">batch_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;peak&quot;</span><span class="p">]</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>                <span class="k">for</span> <span class="n">batch_feature</span> <span class="ow">in</span> <span class="n">batch_features</span><span class="p">:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>                    <span class="k">if</span> <span class="n">batch_feature</span> <span class="o">==</span> <span class="n">src</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">src_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>                            <span class="p">)</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>                        <span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">batch_feature</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                            <span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                        <span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">batch_feature</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>                            <span class="p">)</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>                        <span class="p">)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>                    <span class="k">if</span> <span class="n">batch_feature</span> <span class="o">==</span> <span class="n">dst</span><span class="p">:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">dst_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                            <span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                        <span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                            <span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                        <span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                            <span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>                        <span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span> <span class="o">=</span> <span class="n">num_neg_samples_fold</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="p">}</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="n">update_lr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Runs the encoder and computes node-wise latent variables.&quot;&quot;&quot;</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparametrize</span><span class="p">(</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate random z from mu, logstd&quot;&quot;&quot;</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="k">assert</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">logstd_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                    <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                <span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonneg</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="n">transf</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>            <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">transf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="k">return</span> <span class="n">out_dict</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span> <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">edge_type</span><span class="p">:</span> <span class="n">EdgeType</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Projects all node in z_dict of edge_type to edge-type-specific space.&quot;&quot;&quot;</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="n">src_z</span> <span class="o">=</span> <span class="n">z_dict</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="n">dst_z</span> <span class="o">=</span> <span class="n">z_dict</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="k">if</span> <span class="n">src_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">add_covariate</span><span class="p">:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">src_z</span> <span class="o">=</span> <span class="n">add_cov_to_latent</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">src_type</span><span class="p">],</span> <span class="n">src_z</span><span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="n">dst_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">add_covariate</span><span class="p">:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="n">dst_z</span> <span class="o">=</span> <span class="n">add_cov_to_latent</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dst_type</span><span class="p">],</span> <span class="n">dst_z</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">src_z</span><span class="p">,</span> <span class="n">dst_z</span><span class="p">,</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_recon_loss</span><span class="p">(</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate reconstruction loss by maximizing log_prob of observing edge weight in pos_edge_index_dict and 0 weight in neg_edge_index_dict</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        Args</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        z_dict: encoded vector</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        pos_edge_index_dict: Dictionary of Tensors with shape (2, n_pos_edges)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">        pos_edge_weight_dict: Dictionary of Tensors with shape (n_pos_edges,) encoding the weight of each edges.</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">        neg_edge_index_dict: Dictionary of Tensors with shape (2, n_neg_edges) to be used as negative edges</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">        num_neg_samples: If neg_edge_index is None and</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="sd">            num_neg_samples is None, This number of negative edges are sampled. Otherwise, the same number as the positive edges are sample.</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="c1"># import pdb; pdb.set_trace()</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="n">pos_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>            <span class="n">scale_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">,</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>            <span class="n">bias_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">,</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="n">std_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">,</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>            <span class="k">if</span> <span class="n">neg_edge_index_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                    <span class="n">pos_idx_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                    <span class="n">pos_idx_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_val_data</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>                <span class="n">neg_edge_index_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">pos_edge_index</span> <span class="ow">in</span> <span class="n">pos_edge_index_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_edge_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>                        <span class="k">continue</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>                    <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>                    <span class="p">(</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                        <span class="n">neg_src_idx</span><span class="p">,</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                        <span class="n">neg_dst_idx</span><span class="p">,</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                    <span class="p">)</span> <span class="o">=</span> <span class="n">negative_sampling</span><span class="p">(</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>                        <span class="n">pos_idx_data</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">],</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>                        <span class="n">num_nodes</span><span class="o">=</span><span class="p">(</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>                            <span class="n">pos_idx_data</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                            <span class="n">pos_idx_data</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                        <span class="p">),</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                        <span class="c1"># num_neg_samples_fold=self.num_neg_samples_fold,</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>                        <span class="n">num_neg_samples</span><span class="o">=</span><span class="n">pos_edge_index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                        <span class="c1"># method=&quot;dense&quot;,</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                    <span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                    <span class="c1"># if (neg_src_idx &gt; batch[src_type].num_nodes).any():  # pragma: no cover</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                    <span class="c1">#     raise ValueError(</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                    <span class="c1">#         f&quot;Negative sampling produced indices larger than the number of nodes in {src_type}. &quot;</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                    <span class="c1">#         f&quot;Please check your data and the negative sampling parameters.&quot;</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                    <span class="c1">#     )</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                    <span class="n">neg_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                        <span class="p">[</span><span class="n">neg_src_idx</span><span class="p">,</span> <span class="n">neg_dst_idx</span><span class="p">]</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                    <span class="p">)</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="n">neg_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                <span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                <span class="n">scale_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">,</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                <span class="n">bias_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">,</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                <span class="n">std_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">,</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>            <span class="p">)</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">pos_dist</span> <span class="ow">in</span> <span class="n">pos_dist_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            <span class="n">pos_edge_weights</span> <span class="o">=</span> <span class="n">pos_edge_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="n">pos_log_probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">pos_edge_weights</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                <span class="n">neg_log_probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">neg_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                    <span class="k">if</span> <span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_dist</span> <span class="o">!=</span> <span class="s2">&quot;Beta&quot;</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                    <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                <span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span> <span class="ow">and</span> <span class="n">src_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                <span class="n">pos_log_probs</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">]</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>                <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                    <span class="n">neg_log_probs</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span><span class="p">[</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                        <span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">neg_src_idx</span><span class="p">]</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                    <span class="p">]</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="n">pos_loss</span> <span class="o">=</span> <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                <span class="n">neg_loss</span> <span class="o">=</span> <span class="n">neg_log_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_loss</span> <span class="o">+</span> <span class="n">neg_loss</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_loss</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>            <span class="k">if</span> <span class="n">get_metric</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                <span class="k">if</span> <span class="n">edge_type</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="s2">&quot;expresses&quot;</span><span class="p">,</span> <span class="s2">&quot;gene&quot;</span><span class="p">):</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                    <span class="c1"># import pdb; pdb.set_trace()</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                    <span class="n">metric_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_reconstruction_gene_metrics</span><span class="p">(</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                        <span class="n">pos_edge_weights</span><span class="p">,</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                        <span class="n">pos_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                        <span class="n">pos_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">stddev</span><span class="p">,</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                        <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                    <span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                    <span class="c1"># plot the pos, neg and overall log p distribution</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                        <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                            <span class="n">plot_nll_distributions</span><span class="p">(</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                                <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                                <span class="n">neg_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cell_express_gene&quot;</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                            <span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                            <span class="n">plot_nll_distributions</span><span class="p">(</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                                <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cell_express_gene&quot;</span><span class="p">,</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                            <span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                <span class="k">elif</span> <span class="n">edge_type</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="s2">&quot;has_accessible&quot;</span><span class="p">,</span> <span class="s2">&quot;peak&quot;</span><span class="p">):</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                    <span class="c1"># import pdb; pdb.set_trace()</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                    <span class="k">if</span> <span class="n">get_metric</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                        <span class="n">neg_size</span> <span class="o">=</span> <span class="n">neg_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                        <span class="n">ground_truth</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                                <span class="p">[</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                                    <span class="n">pos_edge_weights</span><span class="p">,</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                                        <span class="n">neg_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                                    <span class="p">),</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                                <span class="p">],</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                            <span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                            <span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                            <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                        <span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                        <span class="n">pred</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                                <span class="p">[</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                                    <span class="n">pos_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                                    <span class="n">neg_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                                <span class="p">],</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                            <span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                            <span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                            <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                        <span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                        <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                        <span class="n">metric_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_classification_metrics</span><span class="p">(</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                            <span class="n">ground_truth</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                        <span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                        <span class="n">plot_nll_distributions</span><span class="p">(</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                            <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                            <span class="n">neg_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cell_has_peak&quot;</span><span class="p">,</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>                        <span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="k">return</span> <span class="n">loss_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_kl_loss</span><span class="p">(</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="n">mu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="n">logstd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="n">weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes the KL loss, either for the passed arguments :obj:`mu`</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a><span class="sd">        and :obj:`logstd`, or based on latent variables from last encoding.</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a><span class="sd">        Args:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="sd">            mu (Tensor, optional): The latent space for :math:`\mu`. If set to</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="sd">                :obj:`None`, uses the last computation of :math:`mu`.</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="sd">                (default: :obj:`None`)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">            logstd (Tensor, optional): The latent space for</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">                :math:`\log\sigma`.  If set to :obj:`None`, uses the last</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">                computation of :math:`\log\sigma^2`.(default: :obj:`None`)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">            weight (Tensor, optional): The latent space for</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">                :math:`\log\sigma`.  If set to :obj:`None`, uses the last</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">                computation of :math:`\log\sigma^2`.(default: :obj:`None`)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">weighted_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>            <span class="c1"># if not w.any():</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>            <span class="c1">#     return 0</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># / w.long().sum()</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mu__</span> <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mu</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="n">logstd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__logstd__</span> <span class="k">if</span> <span class="n">logstd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logstd</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="n">kls</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">logstd</span> <span class="o">-</span> <span class="n">mu</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">logstd</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">weighted_sum</span><span class="p">(</span><span class="n">kls</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_kl_divergence</span><span class="p">(</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sums KL divergence across relations.</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">        Args</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="sd">            z_dict: encoded vector</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="k">if</span> <span class="n">node_weights_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                <span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                <span class="n">weight</span> <span class="o">=</span> <span class="n">node_weights_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="n">node_index_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]]</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="n">loss_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kl_loss</span><span class="p">(</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>                <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">weight</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>            <span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="k">return</span> <span class="n">loss_dict</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">kl_div_loss</span><span class="p">(</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>        <span class="n">nodetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a><span class="sd">        Args</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="sd">        mu_dict: mu of encoded batch</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="sd">        logstd_dict: logstd of encoded batch</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="sd">        node_index_dict: node index of the batch</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">        node_counts_dict: For entire dataset, counts how many times each node is used for KL div calculation. If None, assume no node has been used for the calculation.</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="n">kl_div_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_kl_divergence</span><span class="p">(</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>            <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">,</span> <span class="n">node_index_dict</span><span class="p">,</span> <span class="n">node_weights_dict</span><span class="o">=</span><span class="n">node_weights_dict</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>        <span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="k">for</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">kl_div</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>            <span class="k">if</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">:</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>                <span class="n">nodetype_weight</span> <span class="o">=</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>                <span class="n">nodetype_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">kl_div</span> <span class="o">*</span> <span class="n">nodetype_weight</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">,</span> <span class="s2">&quot;variant_emb_locs&quot;</span><span class="p">):</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kl_loss</span><span class="p">(</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">variant_emb_locs</span><span class="p">,</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">variant_emb_logstd</span><span class="p">,</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">bernoulli_kl_loss</span><span class="p">(</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">variant_emb_mask_logitp</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        <span class="k">return</span> <span class="n">l</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nll_loss</span><span class="p">(</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="c1"># num_neg_samples_fold: Optional[int] = 1,</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="n">edgetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>    <span class="p">):</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>        <span class="n">nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_recon_loss</span><span class="p">(</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>            <span class="n">pos_edge_weight_dict</span><span class="p">,</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="c1"># num_neg_samples_fold,</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="n">get_metric</span><span class="o">=</span><span class="n">get_metric</span><span class="p">,</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            <span class="k">if</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>                <span class="n">edgetype_weight</span> <span class="o">=</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                <span class="n">edgetype_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">nll</span> <span class="o">*</span> <span class="n">edgetype_weight</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>        <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>        <span class="n">edge_attr_type</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="n">edge_attr_type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">edge_attr_type</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>        <span class="n">batch</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_type_subgraph</span><span class="p">([</span><span class="n">edge_attr_type</span><span class="p">])</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>            <span class="o">.</span><span class="n">edge_subgraph</span><span class="p">({</span><span class="n">edge_attr_type</span><span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)})</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>        <span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>            <span class="p">)</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">*=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>            <span class="s2">&quot;nll_loss&quot;</span><span class="p">,</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span><span class="p">,</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>        <span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>        <span class="c1"># Log per-batch (step) NLL in addition to per-epoch aggregation</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>            <span class="s2">&quot;nll_loss_step&quot;</span><span class="p">,</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span><span class="p">,</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>        <span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>            <span class="s2">&quot;kl_div_loss&quot;</span><span class="p">,</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>            <span class="n">batch_kl_div_loss</span><span class="p">,</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>        <span class="p">)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span> <span class="o">+</span> <span class="n">batch_kl_div_loss</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>            <span class="s2">&quot;loss&quot;</span><span class="p">,</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>            <span class="n">loss</span><span class="p">,</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        <span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="n">edge_attr_type</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>        <span class="n">edge_attr_type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">edge_attr_type</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="n">batch</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_type_subgraph</span><span class="p">([</span><span class="n">edge_attr_type</span><span class="p">])</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>            <span class="o">.</span><span class="n">edge_subgraph</span><span class="p">({</span><span class="n">edge_attr_type</span><span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)})</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>            <span class="n">get_metric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span><span class="p">:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>            <span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span> <span class="o">+</span> <span class="n">batch_kl_div_loss</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>            <span class="s2">&quot;val_nll_loss&quot;</span><span class="p">,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span><span class="p">,</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>        <span class="p">)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        <span class="c1"># Also log per-validation-step NLL (so we can monitor batch-level val NLL)</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>            <span class="s2">&quot;val_nll_loss_step&quot;</span><span class="p">,</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span><span class="p">,</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="p">)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>            <span class="s2">&quot;val_nll_loss_monitored&quot;</span><span class="p">,</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>            <span class="o">+</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="p">)</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>            <span class="s2">&quot;val_kl_div_loss&quot;</span><span class="p">,</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="n">batch_kl_div_loss</span><span class="p">,</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>        <span class="p">)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>            <span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>            <span class="n">loss</span><span class="p">,</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>        <span class="p">)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mean_cell_neighbor_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a><span class="sd">        Calculates the mean distance between each cell node and its k nearest neighbors.</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="sd">        Returns a tensor of mean distances for each cell.</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>        <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># (num_cells, latent_dim)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>        <span class="c1"># Compute pairwise Euclidean distances</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="n">cell_mu</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (num_cells, num_cells)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>        <span class="c1"># Exclude self-distance by setting diagonal to infinity</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="n">dist_matrix</span><span class="o">.</span><span class="n">fill_diagonal_</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>        <span class="c1"># Find k nearest neighbors for each cell</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>        <span class="n">knn_distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>        <span class="c1"># Mean distance to k nearest neighbors for each cell</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="n">mean_distances</span> <span class="o">=</span> <span class="n">knn_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">mean_distances</span> <span class="o">/</span> <span class="n">mean_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>        <span class="k">return</span> <span class="n">weights</span>  <span class="c1"># shape: (num_cells,)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">is_last_batch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>            <span class="n">hsic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">custom_train</span><span class="p">(</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>            <span class="p">)</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;hsic_loss&quot;</span><span class="p">,</span> <span class="n">hsic_loss</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>                <span class="s2">&quot;hsic_lr&quot;</span><span class="p">,</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>                <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>            <span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_cell_neighbor_distance</span><span class="p">(</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>            <span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>            <span class="n">optimizer</span><span class="p">,</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>            <span class="n">patience</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        <span class="p">)</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>        <span class="c1"># scheduler = CyclicLR(</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>        <span class="c1">#     optimizer,</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>        <span class="c1">#     self.learning_rate / 2,</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>        <span class="c1">#     self.learning_rate * 2,</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>        <span class="c1">#     step_size_up=10,</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>        <span class="c1">#     mode=&quot;triangular2&quot;,</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>        <span class="c1"># )</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">optimizer</span><span class="p">],</span> <span class="p">[</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>            <span class="p">{</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>                <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">scheduler</span><span class="p">,</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>                <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>                <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>                <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="s2">&quot;val_nll_loss&quot;</span><span class="p">,</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>                <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>            <span class="p">}</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>        <span class="p">]</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">lr_scheduler_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>            <span class="n">update_lr</span><span class="p">(</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">lr_scheduler_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>                    <span class="mi">0</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>                <span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>            <span class="p">)</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>        <span class="c1"># Remove the argument from the checkpoint before it is saved</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>        <span class="n">checkpoint</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;train_data_dict&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="LightningProxModel">
                            <input id="LightningProxModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LightningProxModel</span><wbr>(<span class="base">lightning.pytorch.core.module.LightningModule</span>):

                <label class="view-source-button" for="LightningProxModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel-30"><a href="#LightningProxModel-30"><span class="linenos"> 30</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LightningProxModel</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
</span><span id="LightningProxModel-31"><a href="#LightningProxModel-31"><span class="linenos"> 31</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="LightningProxModel-32"><a href="#LightningProxModel-32"><span class="linenos"> 32</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-33"><a href="#LightningProxModel-33"><span class="linenos"> 33</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel-34"><a href="#LightningProxModel-34"><span class="linenos"> 34</span></a>        <span class="n">encoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">TransEncoder</span><span class="p">,</span>
</span><span id="LightningProxModel-35"><a href="#LightningProxModel-35"><span class="linenos"> 35</span></a>        <span class="n">n_hidden_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
</span><span id="LightningProxModel-36"><a href="#LightningProxModel-36"><span class="linenos"> 36</span></a>        <span class="n">n_latent_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel-37"><a href="#LightningProxModel-37"><span class="linenos"> 37</span></a>        <span class="n">decoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">RelationalEdgeDistributionDecoder</span><span class="p">,</span>
</span><span id="LightningProxModel-38"><a href="#LightningProxModel-38"><span class="linenos"> 38</span></a>        <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-39"><a href="#LightningProxModel-39"><span class="linenos"> 39</span></a>        <span class="n">num_neg_samples_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel-40"><a href="#LightningProxModel-40"><span class="linenos"> 40</span></a>        <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel-41"><a href="#LightningProxModel-41"><span class="linenos"> 41</span></a>        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel-42"><a href="#LightningProxModel-42"><span class="linenos"> 42</span></a>        <span class="n">project_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-43"><a href="#LightningProxModel-43"><span class="linenos"> 43</span></a>        <span class="n">edgetype_specific_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-44"><a href="#LightningProxModel-44"><span class="linenos"> 44</span></a>        <span class="n">edgetype_specific_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-45"><a href="#LightningProxModel-45"><span class="linenos"> 45</span></a>        <span class="n">edgetype_specific_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-46"><a href="#LightningProxModel-46"><span class="linenos"> 46</span></a>        <span class="n">edge_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-47"><a href="#LightningProxModel-47"><span class="linenos"> 47</span></a>        <span class="n">hsic</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-48"><a href="#LightningProxModel-48"><span class="linenos"> 48</span></a>        <span class="n">n_no_kl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel-49"><a href="#LightningProxModel-49"><span class="linenos"> 49</span></a>        <span class="n">n_count_nodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="LightningProxModel-50"><a href="#LightningProxModel-50"><span class="linenos"> 50</span></a>        <span class="n">n_kl_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel-51"><a href="#LightningProxModel-51"><span class="linenos"> 51</span></a>        <span class="n">nll_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="LightningProxModel-52"><a href="#LightningProxModel-52"><span class="linenos"> 52</span></a>        <span class="n">val_nll_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="LightningProxModel-53"><a href="#LightningProxModel-53"><span class="linenos"> 53</span></a>        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
</span><span id="LightningProxModel-54"><a href="#LightningProxModel-54"><span class="linenos"> 54</span></a>        <span class="n">node_weights_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-55"><a href="#LightningProxModel-55"><span class="linenos"> 55</span></a>        <span class="n">nonneg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-56"><a href="#LightningProxModel-56"><span class="linenos"> 56</span></a>        <span class="n">reweight_rarecell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-57"><a href="#LightningProxModel-57"><span class="linenos"> 57</span></a>        <span class="n">reweight_rarecell_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-58"><a href="#LightningProxModel-58"><span class="linenos"> 58</span></a>        <span class="n">positive_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-59"><a href="#LightningProxModel-59"><span class="linenos"> 59</span></a>        <span class="n">train_data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-60"><a href="#LightningProxModel-60"><span class="linenos"> 60</span></a>        <span class="n">val_data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-61"><a href="#LightningProxModel-61"><span class="linenos"> 61</span></a>    <span class="p">):</span>
</span><span id="LightningProxModel-62"><a href="#LightningProxModel-62"><span class="linenos"> 62</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="LightningProxModel-63"><a href="#LightningProxModel-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_hyperparameters</span><span class="p">()</span>
</span><span id="LightningProxModel-64"><a href="#LightningProxModel-64"><span class="linenos"> 64</span></a>        <span class="n">data</span><span class="o">.</span><span class="n">generate_ids</span><span class="p">()</span>
</span><span id="LightningProxModel-65"><a href="#LightningProxModel-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nonneg</span> <span class="o">=</span> <span class="n">nonneg</span>
</span><span id="LightningProxModel-66"><a href="#LightningProxModel-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="LightningProxModel-67"><a href="#LightningProxModel-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
</span><span id="LightningProxModel-68"><a href="#LightningProxModel-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder_class</span><span class="p">(</span>
</span><span id="LightningProxModel-69"><a href="#LightningProxModel-69"><span class="linenos"> 69</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="LightningProxModel-70"><a href="#LightningProxModel-70"><span class="linenos"> 70</span></a>            <span class="n">n_hidden_dims</span><span class="p">,</span>
</span><span id="LightningProxModel-71"><a href="#LightningProxModel-71"><span class="linenos"> 71</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="LightningProxModel-72"><a href="#LightningProxModel-72"><span class="linenos"> 72</span></a>            <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
</span><span id="LightningProxModel-73"><a href="#LightningProxModel-73"><span class="linenos"> 73</span></a>            <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
</span><span id="LightningProxModel-74"><a href="#LightningProxModel-74"><span class="linenos"> 74</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-75"><a href="#LightningProxModel-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder_class</span><span class="p">(</span>
</span><span id="LightningProxModel-76"><a href="#LightningProxModel-76"><span class="linenos"> 76</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="LightningProxModel-77"><a href="#LightningProxModel-77"><span class="linenos"> 77</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="LightningProxModel-78"><a href="#LightningProxModel-78"><span class="linenos"> 78</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="LightningProxModel-79"><a href="#LightningProxModel-79"><span class="linenos"> 79</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="LightningProxModel-80"><a href="#LightningProxModel-80"><span class="linenos"> 80</span></a>            <span class="n">project</span><span class="o">=</span><span class="n">project_decoder</span><span class="p">,</span>
</span><span id="LightningProxModel-81"><a href="#LightningProxModel-81"><span class="linenos"> 81</span></a>            <span class="n">edgetype_specific_bias</span><span class="o">=</span><span class="n">edgetype_specific_bias</span><span class="p">,</span>
</span><span id="LightningProxModel-82"><a href="#LightningProxModel-82"><span class="linenos"> 82</span></a>            <span class="n">edgetype_specific_scale</span><span class="o">=</span><span class="n">edgetype_specific_scale</span><span class="p">,</span>
</span><span id="LightningProxModel-83"><a href="#LightningProxModel-83"><span class="linenos"> 83</span></a>            <span class="n">edgetype_specific_std</span><span class="o">=</span><span class="n">edgetype_specific_std</span><span class="p">,</span>
</span><span id="LightningProxModel-84"><a href="#LightningProxModel-84"><span class="linenos"> 84</span></a>            <span class="n">positive_scale</span><span class="o">=</span><span class="n">positive_scale</span><span class="p">,</span>
</span><span id="LightningProxModel-85"><a href="#LightningProxModel-85"><span class="linenos"> 85</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-86"><a href="#LightningProxModel-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="o">=</span> <span class="n">hsic</span>
</span><span id="LightningProxModel-87"><a href="#LightningProxModel-87"><span class="linenos"> 87</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-88"><a href="#LightningProxModel-88"><span class="linenos"> 88</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="LightningProxModel-89"><a href="#LightningProxModel-89"><span class="linenos"> 89</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="LightningProxModel-90"><a href="#LightningProxModel-90"><span class="linenos"> 90</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-91"><a href="#LightningProxModel-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span> <span class="o">=</span> <span class="n">n_no_kl</span>
</span><span id="LightningProxModel-92"><a href="#LightningProxModel-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_count_nodes</span> <span class="o">=</span> <span class="n">n_count_nodes</span>
</span><span id="LightningProxModel-93"><a href="#LightningProxModel-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">=</span> <span class="n">n_kl_warmup</span>
</span><span id="LightningProxModel-94"><a href="#LightningProxModel-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span> <span class="o">=</span> <span class="n">nll_scale</span>
</span><span id="LightningProxModel-95"><a href="#LightningProxModel-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span> <span class="o">=</span> <span class="n">val_nll_scale</span>
</span><span id="LightningProxModel-96"><a href="#LightningProxModel-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightningProxModel-97"><a href="#LightningProxModel-97"><span class="linenos"> 97</span></a>            <span class="n">node_type</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">node_type</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">x_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="LightningProxModel-98"><a href="#LightningProxModel-98"><span class="linenos"> 98</span></a>        <span class="p">}</span>
</span><span id="LightningProxModel-99"><a href="#LightningProxModel-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_data_dict</span> <span class="o">=</span> <span class="n">train_data_dict</span>
</span><span id="LightningProxModel-100"><a href="#LightningProxModel-100"><span class="linenos">100</span></a>        <span class="k">if</span> <span class="n">train_data_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-101"><a href="#LightningProxModel-101"><span class="linenos">101</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_subgraph</span><span class="p">(</span>
</span><span id="LightningProxModel-102"><a href="#LightningProxModel-102"><span class="linenos">102</span></a>                <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">train_data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="LightningProxModel-103"><a href="#LightningProxModel-103"><span class="linenos">103</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-104"><a href="#LightningProxModel-104"><span class="linenos">104</span></a>            <span class="n">train_val_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-105"><a href="#LightningProxModel-105"><span class="linenos">105</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">train_data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel-106"><a href="#LightningProxModel-106"><span class="linenos">106</span></a>                <span class="n">train_val_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">train_data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">val_data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
</span><span id="LightningProxModel-107"><a href="#LightningProxModel-107"><span class="linenos">107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_val_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_subgraph</span><span class="p">(</span>
</span><span id="LightningProxModel-108"><a href="#LightningProxModel-108"><span class="linenos">108</span></a>                <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">train_val_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="LightningProxModel-109"><a href="#LightningProxModel-109"><span class="linenos">109</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-110"><a href="#LightningProxModel-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span> <span class="o">=</span> <span class="n">reweight_rarecell</span>
</span><span id="LightningProxModel-111"><a href="#LightningProxModel-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span>
</span><span id="LightningProxModel-112"><a href="#LightningProxModel-112"><span class="linenos">112</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-113"><a href="#LightningProxModel-113"><span class="linenos">113</span></a>            <span class="k">if</span> <span class="n">reweight_rarecell_neighbors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-114"><a href="#LightningProxModel-114"><span class="linenos">114</span></a>                <span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="LightningProxModel-115"><a href="#LightningProxModel-115"><span class="linenos">115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="n">reweight_rarecell_neighbors</span>
</span><span id="LightningProxModel-116"><a href="#LightningProxModel-116"><span class="linenos">116</span></a>        <span class="k">if</span> <span class="n">edge_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-117"><a href="#LightningProxModel-117"><span class="linenos">117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="LightningProxModel-118"><a href="#LightningProxModel-118"><span class="linenos">118</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-119"><a href="#LightningProxModel-119"><span class="linenos">119</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">edge_types</span>
</span><span id="LightningProxModel-120"><a href="#LightningProxModel-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightningProxModel-121"><a href="#LightningProxModel-121"><span class="linenos">121</span></a>            <span class="n">edgetype</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">num_edges</span>
</span><span id="LightningProxModel-122"><a href="#LightningProxModel-122"><span class="linenos">122</span></a>            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">)</span>  <span class="c1"># mean $ edges</span>
</span><span id="LightningProxModel-123"><a href="#LightningProxModel-123"><span class="linenos">123</span></a>            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">edgetype</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="LightningProxModel-124"><a href="#LightningProxModel-124"><span class="linenos">124</span></a>            <span class="k">for</span> <span class="n">edgetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="LightningProxModel-125"><a href="#LightningProxModel-125"><span class="linenos">125</span></a>        <span class="p">}</span>
</span><span id="LightningProxModel-126"><a href="#LightningProxModel-126"><span class="linenos">126</span></a>
</span><span id="LightningProxModel-127"><a href="#LightningProxModel-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="n">node_weights_dict</span>
</span><span id="LightningProxModel-128"><a href="#LightningProxModel-128"><span class="linenos">128</span></a>
</span><span id="LightningProxModel-129"><a href="#LightningProxModel-129"><span class="linenos">129</span></a>        <span class="c1"># Batch correction for RNA-seq data</span>
</span><span id="LightningProxModel-130"><a href="#LightningProxModel-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="LightningProxModel-131"><a href="#LightningProxModel-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="LightningProxModel-132"><a href="#LightningProxModel-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="LightningProxModel-133"><a href="#LightningProxModel-133"><span class="linenos">133</span></a>        <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">:</span>
</span><span id="LightningProxModel-134"><a href="#LightningProxModel-134"><span class="linenos">134</span></a>            <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel-135"><a href="#LightningProxModel-135"><span class="linenos">135</span></a>            <span class="k">if</span> <span class="n">edgetype_specific_bias</span><span class="p">:</span>
</span><span id="LightningProxModel-136"><a href="#LightningProxModel-136"><span class="linenos">136</span></a>                <span class="n">src_bias_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-137"><a href="#LightningProxModel-137"><span class="linenos">137</span></a>                <span class="n">dst_bias_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-138"><a href="#LightningProxModel-138"><span class="linenos">138</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-139"><a href="#LightningProxModel-139"><span class="linenos">139</span></a>                <span class="n">src_bias_key</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="LightningProxModel-140"><a href="#LightningProxModel-140"><span class="linenos">140</span></a>                <span class="n">dst_bias_key</span> <span class="o">=</span> <span class="n">dst</span>
</span><span id="LightningProxModel-141"><a href="#LightningProxModel-141"><span class="linenos">141</span></a>            <span class="k">if</span> <span class="n">edgetype_specific_scale</span><span class="p">:</span>
</span><span id="LightningProxModel-142"><a href="#LightningProxModel-142"><span class="linenos">142</span></a>                <span class="n">src_scale_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-143"><a href="#LightningProxModel-143"><span class="linenos">143</span></a>                <span class="n">dst_scale_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-144"><a href="#LightningProxModel-144"><span class="linenos">144</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-145"><a href="#LightningProxModel-145"><span class="linenos">145</span></a>                <span class="n">src_scale_key</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="LightningProxModel-146"><a href="#LightningProxModel-146"><span class="linenos">146</span></a>                <span class="n">dst_scale_key</span> <span class="o">=</span> <span class="n">dst</span>
</span><span id="LightningProxModel-147"><a href="#LightningProxModel-147"><span class="linenos">147</span></a>            <span class="k">if</span> <span class="n">edgetype_specific_std</span><span class="p">:</span>
</span><span id="LightningProxModel-148"><a href="#LightningProxModel-148"><span class="linenos">148</span></a>                <span class="n">src_std_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-149"><a href="#LightningProxModel-149"><span class="linenos">149</span></a>                <span class="n">dst_std_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-150"><a href="#LightningProxModel-150"><span class="linenos">150</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-151"><a href="#LightningProxModel-151"><span class="linenos">151</span></a>                <span class="n">src_std_key</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="LightningProxModel-152"><a href="#LightningProxModel-152"><span class="linenos">152</span></a>                <span class="n">dst_std_key</span> <span class="o">=</span> <span class="n">dst</span>
</span><span id="LightningProxModel-153"><a href="#LightningProxModel-153"><span class="linenos">153</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-154"><a href="#LightningProxModel-154"><span class="linenos">154</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel-155"><a href="#LightningProxModel-155"><span class="linenos">155</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-156"><a href="#LightningProxModel-156"><span class="linenos">156</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-157"><a href="#LightningProxModel-157"><span class="linenos">157</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-158"><a href="#LightningProxModel-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-159"><a href="#LightningProxModel-159"><span class="linenos">159</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel-160"><a href="#LightningProxModel-160"><span class="linenos">160</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-161"><a href="#LightningProxModel-161"><span class="linenos">161</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-162"><a href="#LightningProxModel-162"><span class="linenos">162</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-163"><a href="#LightningProxModel-163"><span class="linenos">163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">src_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-164"><a href="#LightningProxModel-164"><span class="linenos">164</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel-165"><a href="#LightningProxModel-165"><span class="linenos">165</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-166"><a href="#LightningProxModel-166"><span class="linenos">166</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-167"><a href="#LightningProxModel-167"><span class="linenos">167</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-168"><a href="#LightningProxModel-168"><span class="linenos">168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">dst_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-169"><a href="#LightningProxModel-169"><span class="linenos">169</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel-170"><a href="#LightningProxModel-170"><span class="linenos">170</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-171"><a href="#LightningProxModel-171"><span class="linenos">171</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-172"><a href="#LightningProxModel-172"><span class="linenos">172</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-173"><a href="#LightningProxModel-173"><span class="linenos">173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_std_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-174"><a href="#LightningProxModel-174"><span class="linenos">174</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel-175"><a href="#LightningProxModel-175"><span class="linenos">175</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-176"><a href="#LightningProxModel-176"><span class="linenos">176</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-177"><a href="#LightningProxModel-177"><span class="linenos">177</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-178"><a href="#LightningProxModel-178"><span class="linenos">178</span></a>
</span><span id="LightningProxModel-179"><a href="#LightningProxModel-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_std_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-180"><a href="#LightningProxModel-180"><span class="linenos">180</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel-181"><a href="#LightningProxModel-181"><span class="linenos">181</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-182"><a href="#LightningProxModel-182"><span class="linenos">182</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-183"><a href="#LightningProxModel-183"><span class="linenos">183</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-184"><a href="#LightningProxModel-184"><span class="linenos">184</span></a>
</span><span id="LightningProxModel-185"><a href="#LightningProxModel-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-186"><a href="#LightningProxModel-186"><span class="linenos">186</span></a>                <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="LightningProxModel-187"><a href="#LightningProxModel-187"><span class="linenos">187</span></a>                <span class="n">batch_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;peak&quot;</span><span class="p">]</span>
</span><span id="LightningProxModel-188"><a href="#LightningProxModel-188"><span class="linenos">188</span></a>                <span class="k">for</span> <span class="n">batch_feature</span> <span class="ow">in</span> <span class="n">batch_features</span><span class="p">:</span>
</span><span id="LightningProxModel-189"><a href="#LightningProxModel-189"><span class="linenos">189</span></a>                    <span class="k">if</span> <span class="n">batch_feature</span> <span class="o">==</span> <span class="n">src</span><span class="p">:</span>
</span><span id="LightningProxModel-190"><a href="#LightningProxModel-190"><span class="linenos">190</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">src_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-191"><a href="#LightningProxModel-191"><span class="linenos">191</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel-192"><a href="#LightningProxModel-192"><span class="linenos">192</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel-193"><a href="#LightningProxModel-193"><span class="linenos">193</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-194"><a href="#LightningProxModel-194"><span class="linenos">194</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-195"><a href="#LightningProxModel-195"><span class="linenos">195</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-196"><a href="#LightningProxModel-196"><span class="linenos">196</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel-197"><a href="#LightningProxModel-197"><span class="linenos">197</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">batch_feature</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel-198"><a href="#LightningProxModel-198"><span class="linenos">198</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel-199"><a href="#LightningProxModel-199"><span class="linenos">199</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-200"><a href="#LightningProxModel-200"><span class="linenos">200</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-201"><a href="#LightningProxModel-201"><span class="linenos">201</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-202"><a href="#LightningProxModel-202"><span class="linenos">202</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel-203"><a href="#LightningProxModel-203"><span class="linenos">203</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">batch_feature</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel-204"><a href="#LightningProxModel-204"><span class="linenos">204</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel-205"><a href="#LightningProxModel-205"><span class="linenos">205</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-206"><a href="#LightningProxModel-206"><span class="linenos">206</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-207"><a href="#LightningProxModel-207"><span class="linenos">207</span></a>                    <span class="k">if</span> <span class="n">batch_feature</span> <span class="o">==</span> <span class="n">dst</span><span class="p">:</span>
</span><span id="LightningProxModel-208"><a href="#LightningProxModel-208"><span class="linenos">208</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">dst_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-209"><a href="#LightningProxModel-209"><span class="linenos">209</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel-210"><a href="#LightningProxModel-210"><span class="linenos">210</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel-211"><a href="#LightningProxModel-211"><span class="linenos">211</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel-212"><a href="#LightningProxModel-212"><span class="linenos">212</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-213"><a href="#LightningProxModel-213"><span class="linenos">213</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-214"><a href="#LightningProxModel-214"><span class="linenos">214</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-215"><a href="#LightningProxModel-215"><span class="linenos">215</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel-216"><a href="#LightningProxModel-216"><span class="linenos">216</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel-217"><a href="#LightningProxModel-217"><span class="linenos">217</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel-218"><a href="#LightningProxModel-218"><span class="linenos">218</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-219"><a href="#LightningProxModel-219"><span class="linenos">219</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-220"><a href="#LightningProxModel-220"><span class="linenos">220</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel-221"><a href="#LightningProxModel-221"><span class="linenos">221</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel-222"><a href="#LightningProxModel-222"><span class="linenos">222</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel-223"><a href="#LightningProxModel-223"><span class="linenos">223</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel-224"><a href="#LightningProxModel-224"><span class="linenos">224</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-225"><a href="#LightningProxModel-225"><span class="linenos">225</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-226"><a href="#LightningProxModel-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span> <span class="o">=</span> <span class="n">num_neg_samples_fold</span>
</span><span id="LightningProxModel-227"><a href="#LightningProxModel-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightningProxModel-228"><a href="#LightningProxModel-228"><span class="linenos">228</span></a>
</span><span id="LightningProxModel-229"><a href="#LightningProxModel-229"><span class="linenos">229</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-230"><a href="#LightningProxModel-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightningProxModel-231"><a href="#LightningProxModel-231"><span class="linenos">231</span></a>            <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="LightningProxModel-232"><a href="#LightningProxModel-232"><span class="linenos">232</span></a>        <span class="p">}</span>
</span><span id="LightningProxModel-233"><a href="#LightningProxModel-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-234"><a href="#LightningProxModel-234"><span class="linenos">234</span></a>            <span class="n">update_lr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</span><span id="LightningProxModel-235"><a href="#LightningProxModel-235"><span class="linenos">235</span></a>
</span><span id="LightningProxModel-236"><a href="#LightningProxModel-236"><span class="linenos">236</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel-237"><a href="#LightningProxModel-237"><span class="linenos">237</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Runs the encoder and computes node-wise latent variables.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-238"><a href="#LightningProxModel-238"><span class="linenos">238</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="LightningProxModel-239"><a href="#LightningProxModel-239"><span class="linenos">239</span></a>
</span><span id="LightningProxModel-240"><a href="#LightningProxModel-240"><span class="linenos">240</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparametrize</span><span class="p">(</span>
</span><span id="LightningProxModel-241"><a href="#LightningProxModel-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-242"><a href="#LightningProxModel-242"><span class="linenos">242</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-243"><a href="#LightningProxModel-243"><span class="linenos">243</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-244"><a href="#LightningProxModel-244"><span class="linenos">244</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel-245"><a href="#LightningProxModel-245"><span class="linenos">245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate random z from mu, logstd&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-246"><a href="#LightningProxModel-246"><span class="linenos">246</span></a>        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-247"><a href="#LightningProxModel-247"><span class="linenos">247</span></a>        <span class="k">assert</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">logstd_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="LightningProxModel-248"><a href="#LightningProxModel-248"><span class="linenos">248</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel-249"><a href="#LightningProxModel-249"><span class="linenos">249</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="LightningProxModel-250"><a href="#LightningProxModel-250"><span class="linenos">250</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span>
</span><span id="LightningProxModel-251"><a href="#LightningProxModel-251"><span class="linenos">251</span></a>                    <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel-252"><a href="#LightningProxModel-252"><span class="linenos">252</span></a>                <span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span>
</span><span id="LightningProxModel-253"><a href="#LightningProxModel-253"><span class="linenos">253</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-254"><a href="#LightningProxModel-254"><span class="linenos">254</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel-255"><a href="#LightningProxModel-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonneg</span><span class="p">:</span>
</span><span id="LightningProxModel-256"><a href="#LightningProxModel-256"><span class="linenos">256</span></a>            <span class="n">transf</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="LightningProxModel-257"><a href="#LightningProxModel-257"><span class="linenos">257</span></a>            <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">transf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="LightningProxModel-258"><a href="#LightningProxModel-258"><span class="linenos">258</span></a>        <span class="k">return</span> <span class="n">out_dict</span>
</span><span id="LightningProxModel-259"><a href="#LightningProxModel-259"><span class="linenos">259</span></a>
</span><span id="LightningProxModel-260"><a href="#LightningProxModel-260"><span class="linenos">260</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span>
</span><span id="LightningProxModel-261"><a href="#LightningProxModel-261"><span class="linenos">261</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span> <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">edge_type</span><span class="p">:</span> <span class="n">EdgeType</span>
</span><span id="LightningProxModel-262"><a href="#LightningProxModel-262"><span class="linenos">262</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel-263"><a href="#LightningProxModel-263"><span class="linenos">263</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Projects all node in z_dict of edge_type to edge-type-specific space.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-264"><a href="#LightningProxModel-264"><span class="linenos">264</span></a>        <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel-265"><a href="#LightningProxModel-265"><span class="linenos">265</span></a>        <span class="n">src_z</span> <span class="o">=</span> <span class="n">z_dict</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span>
</span><span id="LightningProxModel-266"><a href="#LightningProxModel-266"><span class="linenos">266</span></a>        <span class="n">dst_z</span> <span class="o">=</span> <span class="n">z_dict</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span>
</span><span id="LightningProxModel-267"><a href="#LightningProxModel-267"><span class="linenos">267</span></a>        <span class="k">if</span> <span class="n">src_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">add_covariate</span><span class="p">:</span>
</span><span id="LightningProxModel-268"><a href="#LightningProxModel-268"><span class="linenos">268</span></a>            <span class="n">src_z</span> <span class="o">=</span> <span class="n">add_cov_to_latent</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">src_type</span><span class="p">],</span> <span class="n">src_z</span><span class="p">)</span>
</span><span id="LightningProxModel-269"><a href="#LightningProxModel-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">dst_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">add_covariate</span><span class="p">:</span>
</span><span id="LightningProxModel-270"><a href="#LightningProxModel-270"><span class="linenos">270</span></a>            <span class="n">dst_z</span> <span class="o">=</span> <span class="n">add_cov_to_latent</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dst_type</span><span class="p">],</span> <span class="n">dst_z</span><span class="p">)</span>
</span><span id="LightningProxModel-271"><a href="#LightningProxModel-271"><span class="linenos">271</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">src_z</span><span class="p">,</span> <span class="n">dst_z</span><span class="p">,</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">)</span>
</span><span id="LightningProxModel-272"><a href="#LightningProxModel-272"><span class="linenos">272</span></a>
</span><span id="LightningProxModel-273"><a href="#LightningProxModel-273"><span class="linenos">273</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_recon_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-274"><a href="#LightningProxModel-274"><span class="linenos">274</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-275"><a href="#LightningProxModel-275"><span class="linenos">275</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel-276"><a href="#LightningProxModel-276"><span class="linenos">276</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-277"><a href="#LightningProxModel-277"><span class="linenos">277</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-278"><a href="#LightningProxModel-278"><span class="linenos">278</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-279"><a href="#LightningProxModel-279"><span class="linenos">279</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-280"><a href="#LightningProxModel-280"><span class="linenos">280</span></a>        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-281"><a href="#LightningProxModel-281"><span class="linenos">281</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-282"><a href="#LightningProxModel-282"><span class="linenos">282</span></a>        <span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-283"><a href="#LightningProxModel-283"><span class="linenos">283</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="LightningProxModel-284"><a href="#LightningProxModel-284"><span class="linenos">284</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate reconstruction loss by maximizing log_prob of observing edge weight in pos_edge_index_dict and 0 weight in neg_edge_index_dict</span>
</span><span id="LightningProxModel-285"><a href="#LightningProxModel-285"><span class="linenos">285</span></a>
</span><span id="LightningProxModel-286"><a href="#LightningProxModel-286"><span class="linenos">286</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel-287"><a href="#LightningProxModel-287"><span class="linenos">287</span></a><span class="sd">        z_dict: encoded vector</span>
</span><span id="LightningProxModel-288"><a href="#LightningProxModel-288"><span class="linenos">288</span></a><span class="sd">        pos_edge_index_dict: Dictionary of Tensors with shape (2, n_pos_edges)</span>
</span><span id="LightningProxModel-289"><a href="#LightningProxModel-289"><span class="linenos">289</span></a><span class="sd">        pos_edge_weight_dict: Dictionary of Tensors with shape (n_pos_edges,) encoding the weight of each edges.</span>
</span><span id="LightningProxModel-290"><a href="#LightningProxModel-290"><span class="linenos">290</span></a><span class="sd">        neg_edge_index_dict: Dictionary of Tensors with shape (2, n_neg_edges) to be used as negative edges</span>
</span><span id="LightningProxModel-291"><a href="#LightningProxModel-291"><span class="linenos">291</span></a><span class="sd">        num_neg_samples: If neg_edge_index is None and</span>
</span><span id="LightningProxModel-292"><a href="#LightningProxModel-292"><span class="linenos">292</span></a><span class="sd">            num_neg_samples is None, This number of negative edges are sampled. Otherwise, the same number as the positive edges are sample.</span>
</span><span id="LightningProxModel-293"><a href="#LightningProxModel-293"><span class="linenos">293</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-294"><a href="#LightningProxModel-294"><span class="linenos">294</span></a>        <span class="c1"># import pdb; pdb.set_trace()</span>
</span><span id="LightningProxModel-295"><a href="#LightningProxModel-295"><span class="linenos">295</span></a>        <span class="n">pos_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="LightningProxModel-296"><a href="#LightningProxModel-296"><span class="linenos">296</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-297"><a href="#LightningProxModel-297"><span class="linenos">297</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-298"><a href="#LightningProxModel-298"><span class="linenos">298</span></a>            <span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-299"><a href="#LightningProxModel-299"><span class="linenos">299</span></a>            <span class="n">scale_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-300"><a href="#LightningProxModel-300"><span class="linenos">300</span></a>            <span class="n">bias_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-301"><a href="#LightningProxModel-301"><span class="linenos">301</span></a>            <span class="n">std_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-302"><a href="#LightningProxModel-302"><span class="linenos">302</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-303"><a href="#LightningProxModel-303"><span class="linenos">303</span></a>        <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel-304"><a href="#LightningProxModel-304"><span class="linenos">304</span></a>            <span class="k">if</span> <span class="n">neg_edge_index_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-305"><a href="#LightningProxModel-305"><span class="linenos">305</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="LightningProxModel-306"><a href="#LightningProxModel-306"><span class="linenos">306</span></a>                    <span class="n">pos_idx_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span>
</span><span id="LightningProxModel-307"><a href="#LightningProxModel-307"><span class="linenos">307</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-308"><a href="#LightningProxModel-308"><span class="linenos">308</span></a>                    <span class="n">pos_idx_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_val_data</span>
</span><span id="LightningProxModel-309"><a href="#LightningProxModel-309"><span class="linenos">309</span></a>                <span class="n">neg_edge_index_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-310"><a href="#LightningProxModel-310"><span class="linenos">310</span></a>
</span><span id="LightningProxModel-311"><a href="#LightningProxModel-311"><span class="linenos">311</span></a>                <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">pos_edge_index</span> <span class="ow">in</span> <span class="n">pos_edge_index_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-312"><a href="#LightningProxModel-312"><span class="linenos">312</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_edge_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-313"><a href="#LightningProxModel-313"><span class="linenos">313</span></a>                        <span class="k">continue</span>
</span><span id="LightningProxModel-314"><a href="#LightningProxModel-314"><span class="linenos">314</span></a>                    <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel-315"><a href="#LightningProxModel-315"><span class="linenos">315</span></a>                    <span class="p">(</span>
</span><span id="LightningProxModel-316"><a href="#LightningProxModel-316"><span class="linenos">316</span></a>                        <span class="n">neg_src_idx</span><span class="p">,</span>
</span><span id="LightningProxModel-317"><a href="#LightningProxModel-317"><span class="linenos">317</span></a>                        <span class="n">neg_dst_idx</span><span class="p">,</span>
</span><span id="LightningProxModel-318"><a href="#LightningProxModel-318"><span class="linenos">318</span></a>                    <span class="p">)</span> <span class="o">=</span> <span class="n">negative_sampling</span><span class="p">(</span>
</span><span id="LightningProxModel-319"><a href="#LightningProxModel-319"><span class="linenos">319</span></a>                        <span class="n">pos_idx_data</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">],</span>
</span><span id="LightningProxModel-320"><a href="#LightningProxModel-320"><span class="linenos">320</span></a>                        <span class="n">num_nodes</span><span class="o">=</span><span class="p">(</span>
</span><span id="LightningProxModel-321"><a href="#LightningProxModel-321"><span class="linenos">321</span></a>                            <span class="n">pos_idx_data</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-322"><a href="#LightningProxModel-322"><span class="linenos">322</span></a>                            <span class="n">pos_idx_data</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-323"><a href="#LightningProxModel-323"><span class="linenos">323</span></a>                        <span class="p">),</span>
</span><span id="LightningProxModel-324"><a href="#LightningProxModel-324"><span class="linenos">324</span></a>                        <span class="c1"># num_neg_samples_fold=self.num_neg_samples_fold,</span>
</span><span id="LightningProxModel-325"><a href="#LightningProxModel-325"><span class="linenos">325</span></a>                        <span class="n">num_neg_samples</span><span class="o">=</span><span class="n">pos_edge_index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LightningProxModel-326"><a href="#LightningProxModel-326"><span class="linenos">326</span></a>                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span>
</span><span id="LightningProxModel-327"><a href="#LightningProxModel-327"><span class="linenos">327</span></a>                        <span class="c1"># method=&quot;dense&quot;,</span>
</span><span id="LightningProxModel-328"><a href="#LightningProxModel-328"><span class="linenos">328</span></a>                    <span class="p">)</span>
</span><span id="LightningProxModel-329"><a href="#LightningProxModel-329"><span class="linenos">329</span></a>                    <span class="c1"># if (neg_src_idx &gt; batch[src_type].num_nodes).any():  # pragma: no cover</span>
</span><span id="LightningProxModel-330"><a href="#LightningProxModel-330"><span class="linenos">330</span></a>                    <span class="c1">#     raise ValueError(</span>
</span><span id="LightningProxModel-331"><a href="#LightningProxModel-331"><span class="linenos">331</span></a>                    <span class="c1">#         f&quot;Negative sampling produced indices larger than the number of nodes in {src_type}. &quot;</span>
</span><span id="LightningProxModel-332"><a href="#LightningProxModel-332"><span class="linenos">332</span></a>                    <span class="c1">#         f&quot;Please check your data and the negative sampling parameters.&quot;</span>
</span><span id="LightningProxModel-333"><a href="#LightningProxModel-333"><span class="linenos">333</span></a>                    <span class="c1">#     )</span>
</span><span id="LightningProxModel-334"><a href="#LightningProxModel-334"><span class="linenos">334</span></a>                    <span class="n">neg_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
</span><span id="LightningProxModel-335"><a href="#LightningProxModel-335"><span class="linenos">335</span></a>                        <span class="p">[</span><span class="n">neg_src_idx</span><span class="p">,</span> <span class="n">neg_dst_idx</span><span class="p">]</span>
</span><span id="LightningProxModel-336"><a href="#LightningProxModel-336"><span class="linenos">336</span></a>                    <span class="p">)</span>
</span><span id="LightningProxModel-337"><a href="#LightningProxModel-337"><span class="linenos">337</span></a>            <span class="n">neg_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="LightningProxModel-338"><a href="#LightningProxModel-338"><span class="linenos">338</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-339"><a href="#LightningProxModel-339"><span class="linenos">339</span></a>                <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-340"><a href="#LightningProxModel-340"><span class="linenos">340</span></a>                <span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-341"><a href="#LightningProxModel-341"><span class="linenos">341</span></a>                <span class="n">scale_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-342"><a href="#LightningProxModel-342"><span class="linenos">342</span></a>                <span class="n">bias_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-343"><a href="#LightningProxModel-343"><span class="linenos">343</span></a>                <span class="n">std_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-344"><a href="#LightningProxModel-344"><span class="linenos">344</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-345"><a href="#LightningProxModel-345"><span class="linenos">345</span></a>
</span><span id="LightningProxModel-346"><a href="#LightningProxModel-346"><span class="linenos">346</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-347"><a href="#LightningProxModel-347"><span class="linenos">347</span></a>        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-348"><a href="#LightningProxModel-348"><span class="linenos">348</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">pos_dist</span> <span class="ow">in</span> <span class="n">pos_dist_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-349"><a href="#LightningProxModel-349"><span class="linenos">349</span></a>            <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel-350"><a href="#LightningProxModel-350"><span class="linenos">350</span></a>            <span class="n">pos_edge_weights</span> <span class="o">=</span> <span class="n">pos_edge_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel-351"><a href="#LightningProxModel-351"><span class="linenos">351</span></a>            <span class="n">pos_log_probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">pos_edge_weights</span><span class="p">)</span>
</span><span id="LightningProxModel-352"><a href="#LightningProxModel-352"><span class="linenos">352</span></a>            <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel-353"><a href="#LightningProxModel-353"><span class="linenos">353</span></a>                <span class="n">neg_log_probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">neg_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span>
</span><span id="LightningProxModel-354"><a href="#LightningProxModel-354"><span class="linenos">354</span></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-355"><a href="#LightningProxModel-355"><span class="linenos">355</span></a>                    <span class="k">if</span> <span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_dist</span> <span class="o">!=</span> <span class="s2">&quot;Beta&quot;</span>
</span><span id="LightningProxModel-356"><a href="#LightningProxModel-356"><span class="linenos">356</span></a>                    <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-357"><a href="#LightningProxModel-357"><span class="linenos">357</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-358"><a href="#LightningProxModel-358"><span class="linenos">358</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span> <span class="ow">and</span> <span class="n">src_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
</span><span id="LightningProxModel-359"><a href="#LightningProxModel-359"><span class="linenos">359</span></a>                <span class="n">pos_log_probs</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">]</span>
</span><span id="LightningProxModel-360"><a href="#LightningProxModel-360"><span class="linenos">360</span></a>                <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel-361"><a href="#LightningProxModel-361"><span class="linenos">361</span></a>                    <span class="n">neg_log_probs</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span><span class="p">[</span>
</span><span id="LightningProxModel-362"><a href="#LightningProxModel-362"><span class="linenos">362</span></a>                        <span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">neg_src_idx</span><span class="p">]</span>
</span><span id="LightningProxModel-363"><a href="#LightningProxModel-363"><span class="linenos">363</span></a>                    <span class="p">]</span>
</span><span id="LightningProxModel-364"><a href="#LightningProxModel-364"><span class="linenos">364</span></a>            <span class="n">pos_loss</span> <span class="o">=</span> <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel-365"><a href="#LightningProxModel-365"><span class="linenos">365</span></a>            <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel-366"><a href="#LightningProxModel-366"><span class="linenos">366</span></a>                <span class="n">neg_loss</span> <span class="o">=</span> <span class="n">neg_log_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel-367"><a href="#LightningProxModel-367"><span class="linenos">367</span></a>                <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_loss</span> <span class="o">+</span> <span class="n">neg_loss</span>
</span><span id="LightningProxModel-368"><a href="#LightningProxModel-368"><span class="linenos">368</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-369"><a href="#LightningProxModel-369"><span class="linenos">369</span></a>                <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_loss</span>
</span><span id="LightningProxModel-370"><a href="#LightningProxModel-370"><span class="linenos">370</span></a>
</span><span id="LightningProxModel-371"><a href="#LightningProxModel-371"><span class="linenos">371</span></a>            <span class="k">if</span> <span class="n">get_metric</span><span class="p">:</span>
</span><span id="LightningProxModel-372"><a href="#LightningProxModel-372"><span class="linenos">372</span></a>                <span class="k">if</span> <span class="n">edge_type</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="s2">&quot;expresses&quot;</span><span class="p">,</span> <span class="s2">&quot;gene&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-373"><a href="#LightningProxModel-373"><span class="linenos">373</span></a>                    <span class="c1"># import pdb; pdb.set_trace()</span>
</span><span id="LightningProxModel-374"><a href="#LightningProxModel-374"><span class="linenos">374</span></a>                    <span class="n">metric_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_reconstruction_gene_metrics</span><span class="p">(</span>
</span><span id="LightningProxModel-375"><a href="#LightningProxModel-375"><span class="linenos">375</span></a>                        <span class="n">pos_edge_weights</span><span class="p">,</span>
</span><span id="LightningProxModel-376"><a href="#LightningProxModel-376"><span class="linenos">376</span></a>                        <span class="n">pos_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
</span><span id="LightningProxModel-377"><a href="#LightningProxModel-377"><span class="linenos">377</span></a>                        <span class="n">pos_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">stddev</span><span class="p">,</span>
</span><span id="LightningProxModel-378"><a href="#LightningProxModel-378"><span class="linenos">378</span></a>                        <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
</span><span id="LightningProxModel-379"><a href="#LightningProxModel-379"><span class="linenos">379</span></a>                    <span class="p">)</span>
</span><span id="LightningProxModel-380"><a href="#LightningProxModel-380"><span class="linenos">380</span></a>                    <span class="c1"># plot the pos, neg and overall log p distribution</span>
</span><span id="LightningProxModel-381"><a href="#LightningProxModel-381"><span class="linenos">381</span></a>                    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="LightningProxModel-382"><a href="#LightningProxModel-382"><span class="linenos">382</span></a>                        <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel-383"><a href="#LightningProxModel-383"><span class="linenos">383</span></a>                            <span class="n">plot_nll_distributions</span><span class="p">(</span>
</span><span id="LightningProxModel-384"><a href="#LightningProxModel-384"><span class="linenos">384</span></a>                                <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel-385"><a href="#LightningProxModel-385"><span class="linenos">385</span></a>                                <span class="n">neg_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel-386"><a href="#LightningProxModel-386"><span class="linenos">386</span></a>                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cell_express_gene&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-387"><a href="#LightningProxModel-387"><span class="linenos">387</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-388"><a href="#LightningProxModel-388"><span class="linenos">388</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-389"><a href="#LightningProxModel-389"><span class="linenos">389</span></a>                            <span class="n">plot_nll_distributions</span><span class="p">(</span>
</span><span id="LightningProxModel-390"><a href="#LightningProxModel-390"><span class="linenos">390</span></a>                                <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel-391"><a href="#LightningProxModel-391"><span class="linenos">391</span></a>                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cell_express_gene&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-392"><a href="#LightningProxModel-392"><span class="linenos">392</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-393"><a href="#LightningProxModel-393"><span class="linenos">393</span></a>
</span><span id="LightningProxModel-394"><a href="#LightningProxModel-394"><span class="linenos">394</span></a>                <span class="k">elif</span> <span class="n">edge_type</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="s2">&quot;has_accessible&quot;</span><span class="p">,</span> <span class="s2">&quot;peak&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-395"><a href="#LightningProxModel-395"><span class="linenos">395</span></a>                    <span class="c1"># import pdb; pdb.set_trace()</span>
</span><span id="LightningProxModel-396"><a href="#LightningProxModel-396"><span class="linenos">396</span></a>                    <span class="k">if</span> <span class="n">get_metric</span><span class="p">:</span>
</span><span id="LightningProxModel-397"><a href="#LightningProxModel-397"><span class="linenos">397</span></a>                        <span class="n">neg_size</span> <span class="o">=</span> <span class="n">neg_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LightningProxModel-398"><a href="#LightningProxModel-398"><span class="linenos">398</span></a>                        <span class="n">ground_truth</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel-399"><a href="#LightningProxModel-399"><span class="linenos">399</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="LightningProxModel-400"><a href="#LightningProxModel-400"><span class="linenos">400</span></a>                                <span class="p">[</span>
</span><span id="LightningProxModel-401"><a href="#LightningProxModel-401"><span class="linenos">401</span></a>                                    <span class="n">pos_edge_weights</span><span class="p">,</span>
</span><span id="LightningProxModel-402"><a href="#LightningProxModel-402"><span class="linenos">402</span></a>                                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel-403"><a href="#LightningProxModel-403"><span class="linenos">403</span></a>                                        <span class="n">neg_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span>
</span><span id="LightningProxModel-404"><a href="#LightningProxModel-404"><span class="linenos">404</span></a>                                    <span class="p">),</span>
</span><span id="LightningProxModel-405"><a href="#LightningProxModel-405"><span class="linenos">405</span></a>                                <span class="p">],</span>
</span><span id="LightningProxModel-406"><a href="#LightningProxModel-406"><span class="linenos">406</span></a>                                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="LightningProxModel-407"><a href="#LightningProxModel-407"><span class="linenos">407</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-408"><a href="#LightningProxModel-408"><span class="linenos">408</span></a>                            <span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="LightningProxModel-409"><a href="#LightningProxModel-409"><span class="linenos">409</span></a>                            <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="LightningProxModel-410"><a href="#LightningProxModel-410"><span class="linenos">410</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-411"><a href="#LightningProxModel-411"><span class="linenos">411</span></a>                        <span class="n">pred</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel-412"><a href="#LightningProxModel-412"><span class="linenos">412</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="LightningProxModel-413"><a href="#LightningProxModel-413"><span class="linenos">413</span></a>                                <span class="p">[</span>
</span><span id="LightningProxModel-414"><a href="#LightningProxModel-414"><span class="linenos">414</span></a>                                    <span class="n">pos_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span>
</span><span id="LightningProxModel-415"><a href="#LightningProxModel-415"><span class="linenos">415</span></a>                                    <span class="n">neg_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span>
</span><span id="LightningProxModel-416"><a href="#LightningProxModel-416"><span class="linenos">416</span></a>                                <span class="p">],</span>
</span><span id="LightningProxModel-417"><a href="#LightningProxModel-417"><span class="linenos">417</span></a>                                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="LightningProxModel-418"><a href="#LightningProxModel-418"><span class="linenos">418</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel-419"><a href="#LightningProxModel-419"><span class="linenos">419</span></a>                            <span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="LightningProxModel-420"><a href="#LightningProxModel-420"><span class="linenos">420</span></a>                            <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="LightningProxModel-421"><a href="#LightningProxModel-421"><span class="linenos">421</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-422"><a href="#LightningProxModel-422"><span class="linenos">422</span></a>                        <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
</span><span id="LightningProxModel-423"><a href="#LightningProxModel-423"><span class="linenos">423</span></a>                        <span class="n">metric_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_classification_metrics</span><span class="p">(</span>
</span><span id="LightningProxModel-424"><a href="#LightningProxModel-424"><span class="linenos">424</span></a>                            <span class="n">ground_truth</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span>
</span><span id="LightningProxModel-425"><a href="#LightningProxModel-425"><span class="linenos">425</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-426"><a href="#LightningProxModel-426"><span class="linenos">426</span></a>                    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="LightningProxModel-427"><a href="#LightningProxModel-427"><span class="linenos">427</span></a>                        <span class="n">plot_nll_distributions</span><span class="p">(</span>
</span><span id="LightningProxModel-428"><a href="#LightningProxModel-428"><span class="linenos">428</span></a>                            <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel-429"><a href="#LightningProxModel-429"><span class="linenos">429</span></a>                            <span class="n">neg_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel-430"><a href="#LightningProxModel-430"><span class="linenos">430</span></a>                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cell_has_peak&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-431"><a href="#LightningProxModel-431"><span class="linenos">431</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-432"><a href="#LightningProxModel-432"><span class="linenos">432</span></a>
</span><span id="LightningProxModel-433"><a href="#LightningProxModel-433"><span class="linenos">433</span></a>        <span class="k">return</span> <span class="n">loss_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span><span id="LightningProxModel-434"><a href="#LightningProxModel-434"><span class="linenos">434</span></a>
</span><span id="LightningProxModel-435"><a href="#LightningProxModel-435"><span class="linenos">435</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-436"><a href="#LightningProxModel-436"><span class="linenos">436</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-437"><a href="#LightningProxModel-437"><span class="linenos">437</span></a>        <span class="n">mu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-438"><a href="#LightningProxModel-438"><span class="linenos">438</span></a>        <span class="n">logstd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-439"><a href="#LightningProxModel-439"><span class="linenos">439</span></a>        <span class="n">weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-440"><a href="#LightningProxModel-440"><span class="linenos">440</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel-441"><a href="#LightningProxModel-441"><span class="linenos">441</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes the KL loss, either for the passed arguments :obj:`mu`</span>
</span><span id="LightningProxModel-442"><a href="#LightningProxModel-442"><span class="linenos">442</span></a><span class="sd">        and :obj:`logstd`, or based on latent variables from last encoding.</span>
</span><span id="LightningProxModel-443"><a href="#LightningProxModel-443"><span class="linenos">443</span></a>
</span><span id="LightningProxModel-444"><a href="#LightningProxModel-444"><span class="linenos">444</span></a><span class="sd">        Args:</span>
</span><span id="LightningProxModel-445"><a href="#LightningProxModel-445"><span class="linenos">445</span></a><span class="sd">            mu (Tensor, optional): The latent space for :math:`\mu`. If set to</span>
</span><span id="LightningProxModel-446"><a href="#LightningProxModel-446"><span class="linenos">446</span></a><span class="sd">                :obj:`None`, uses the last computation of :math:`mu`.</span>
</span><span id="LightningProxModel-447"><a href="#LightningProxModel-447"><span class="linenos">447</span></a><span class="sd">                (default: :obj:`None`)</span>
</span><span id="LightningProxModel-448"><a href="#LightningProxModel-448"><span class="linenos">448</span></a><span class="sd">            logstd (Tensor, optional): The latent space for</span>
</span><span id="LightningProxModel-449"><a href="#LightningProxModel-449"><span class="linenos">449</span></a><span class="sd">                :math:`\log\sigma`.  If set to :obj:`None`, uses the last</span>
</span><span id="LightningProxModel-450"><a href="#LightningProxModel-450"><span class="linenos">450</span></a><span class="sd">                computation of :math:`\log\sigma^2`.(default: :obj:`None`)</span>
</span><span id="LightningProxModel-451"><a href="#LightningProxModel-451"><span class="linenos">451</span></a><span class="sd">            weight (Tensor, optional): The latent space for</span>
</span><span id="LightningProxModel-452"><a href="#LightningProxModel-452"><span class="linenos">452</span></a><span class="sd">                :math:`\log\sigma`.  If set to :obj:`None`, uses the last</span>
</span><span id="LightningProxModel-453"><a href="#LightningProxModel-453"><span class="linenos">453</span></a><span class="sd">                computation of :math:`\log\sigma^2`.(default: :obj:`None`)</span>
</span><span id="LightningProxModel-454"><a href="#LightningProxModel-454"><span class="linenos">454</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-455"><a href="#LightningProxModel-455"><span class="linenos">455</span></a>
</span><span id="LightningProxModel-456"><a href="#LightningProxModel-456"><span class="linenos">456</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">weighted_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
</span><span id="LightningProxModel-457"><a href="#LightningProxModel-457"><span class="linenos">457</span></a>            <span class="c1"># if not w.any():</span>
</span><span id="LightningProxModel-458"><a href="#LightningProxModel-458"><span class="linenos">458</span></a>            <span class="c1">#     return 0</span>
</span><span id="LightningProxModel-459"><a href="#LightningProxModel-459"><span class="linenos">459</span></a>            <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-460"><a href="#LightningProxModel-460"><span class="linenos">460</span></a>                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel-461"><a href="#LightningProxModel-461"><span class="linenos">461</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># / w.long().sum()</span>
</span><span id="LightningProxModel-462"><a href="#LightningProxModel-462"><span class="linenos">462</span></a>
</span><span id="LightningProxModel-463"><a href="#LightningProxModel-463"><span class="linenos">463</span></a>        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mu__</span> <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mu</span>
</span><span id="LightningProxModel-464"><a href="#LightningProxModel-464"><span class="linenos">464</span></a>        <span class="n">logstd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__logstd__</span> <span class="k">if</span> <span class="n">logstd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logstd</span>
</span><span id="LightningProxModel-465"><a href="#LightningProxModel-465"><span class="linenos">465</span></a>        <span class="n">kls</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">logstd</span> <span class="o">-</span> <span class="n">mu</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">logstd</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel-466"><a href="#LightningProxModel-466"><span class="linenos">466</span></a>        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">weighted_sum</span><span class="p">(</span><span class="n">kls</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
</span><span id="LightningProxModel-467"><a href="#LightningProxModel-467"><span class="linenos">467</span></a>
</span><span id="LightningProxModel-468"><a href="#LightningProxModel-468"><span class="linenos">468</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_kl_divergence</span><span class="p">(</span>
</span><span id="LightningProxModel-469"><a href="#LightningProxModel-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-470"><a href="#LightningProxModel-470"><span class="linenos">470</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-471"><a href="#LightningProxModel-471"><span class="linenos">471</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-472"><a href="#LightningProxModel-472"><span class="linenos">472</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-473"><a href="#LightningProxModel-473"><span class="linenos">473</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-474"><a href="#LightningProxModel-474"><span class="linenos">474</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel-475"><a href="#LightningProxModel-475"><span class="linenos">475</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sums KL divergence across relations.</span>
</span><span id="LightningProxModel-476"><a href="#LightningProxModel-476"><span class="linenos">476</span></a>
</span><span id="LightningProxModel-477"><a href="#LightningProxModel-477"><span class="linenos">477</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel-478"><a href="#LightningProxModel-478"><span class="linenos">478</span></a><span class="sd">            z_dict: encoded vector</span>
</span><span id="LightningProxModel-479"><a href="#LightningProxModel-479"><span class="linenos">479</span></a>
</span><span id="LightningProxModel-480"><a href="#LightningProxModel-480"><span class="linenos">480</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-481"><a href="#LightningProxModel-481"><span class="linenos">481</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-482"><a href="#LightningProxModel-482"><span class="linenos">482</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel-483"><a href="#LightningProxModel-483"><span class="linenos">483</span></a>            <span class="k">if</span> <span class="n">node_weights_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-484"><a href="#LightningProxModel-484"><span class="linenos">484</span></a>                <span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-485"><a href="#LightningProxModel-485"><span class="linenos">485</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-486"><a href="#LightningProxModel-486"><span class="linenos">486</span></a>                <span class="n">weight</span> <span class="o">=</span> <span class="n">node_weights_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="n">node_index_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]]</span>
</span><span id="LightningProxModel-487"><a href="#LightningProxModel-487"><span class="linenos">487</span></a>            <span class="n">loss_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-488"><a href="#LightningProxModel-488"><span class="linenos">488</span></a>                <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">weight</span>
</span><span id="LightningProxModel-489"><a href="#LightningProxModel-489"><span class="linenos">489</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-490"><a href="#LightningProxModel-490"><span class="linenos">490</span></a>        <span class="k">return</span> <span class="n">loss_dict</span>
</span><span id="LightningProxModel-491"><a href="#LightningProxModel-491"><span class="linenos">491</span></a>
</span><span id="LightningProxModel-492"><a href="#LightningProxModel-492"><span class="linenos">492</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-493"><a href="#LightningProxModel-493"><span class="linenos">493</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-494"><a href="#LightningProxModel-494"><span class="linenos">494</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-495"><a href="#LightningProxModel-495"><span class="linenos">495</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-496"><a href="#LightningProxModel-496"><span class="linenos">496</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-497"><a href="#LightningProxModel-497"><span class="linenos">497</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-498"><a href="#LightningProxModel-498"><span class="linenos">498</span></a>        <span class="n">nodetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-499"><a href="#LightningProxModel-499"><span class="linenos">499</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel-500"><a href="#LightningProxModel-500"><span class="linenos">500</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-501"><a href="#LightningProxModel-501"><span class="linenos">501</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel-502"><a href="#LightningProxModel-502"><span class="linenos">502</span></a><span class="sd">        mu_dict: mu of encoded batch</span>
</span><span id="LightningProxModel-503"><a href="#LightningProxModel-503"><span class="linenos">503</span></a><span class="sd">        logstd_dict: logstd of encoded batch</span>
</span><span id="LightningProxModel-504"><a href="#LightningProxModel-504"><span class="linenos">504</span></a><span class="sd">        node_index_dict: node index of the batch</span>
</span><span id="LightningProxModel-505"><a href="#LightningProxModel-505"><span class="linenos">505</span></a><span class="sd">        node_counts_dict: For entire dataset, counts how many times each node is used for KL div calculation. If None, assume no node has been used for the calculation.</span>
</span><span id="LightningProxModel-506"><a href="#LightningProxModel-506"><span class="linenos">506</span></a>
</span><span id="LightningProxModel-507"><a href="#LightningProxModel-507"><span class="linenos">507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-508"><a href="#LightningProxModel-508"><span class="linenos">508</span></a>        <span class="n">kl_div_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_kl_divergence</span><span class="p">(</span>
</span><span id="LightningProxModel-509"><a href="#LightningProxModel-509"><span class="linenos">509</span></a>            <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">,</span> <span class="n">node_index_dict</span><span class="p">,</span> <span class="n">node_weights_dict</span><span class="o">=</span><span class="n">node_weights_dict</span>
</span><span id="LightningProxModel-510"><a href="#LightningProxModel-510"><span class="linenos">510</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-511"><a href="#LightningProxModel-511"><span class="linenos">511</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-512"><a href="#LightningProxModel-512"><span class="linenos">512</span></a>        <span class="k">for</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">kl_div</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-513"><a href="#LightningProxModel-513"><span class="linenos">513</span></a>            <span class="k">if</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">:</span>
</span><span id="LightningProxModel-514"><a href="#LightningProxModel-514"><span class="linenos">514</span></a>                <span class="n">nodetype_weight</span> <span class="o">=</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel-515"><a href="#LightningProxModel-515"><span class="linenos">515</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-516"><a href="#LightningProxModel-516"><span class="linenos">516</span></a>                <span class="n">nodetype_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="LightningProxModel-517"><a href="#LightningProxModel-517"><span class="linenos">517</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">kl_div</span> <span class="o">*</span> <span class="n">nodetype_weight</span>
</span><span id="LightningProxModel-518"><a href="#LightningProxModel-518"><span class="linenos">518</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">,</span> <span class="s2">&quot;variant_emb_locs&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-519"><a href="#LightningProxModel-519"><span class="linenos">519</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-520"><a href="#LightningProxModel-520"><span class="linenos">520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">variant_emb_locs</span><span class="p">,</span>
</span><span id="LightningProxModel-521"><a href="#LightningProxModel-521"><span class="linenos">521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">variant_emb_logstd</span><span class="p">,</span>
</span><span id="LightningProxModel-522"><a href="#LightningProxModel-522"><span class="linenos">522</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-523"><a href="#LightningProxModel-523"><span class="linenos">523</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">bernoulli_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-524"><a href="#LightningProxModel-524"><span class="linenos">524</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">variant_emb_mask_logitp</span>
</span><span id="LightningProxModel-525"><a href="#LightningProxModel-525"><span class="linenos">525</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel-526"><a href="#LightningProxModel-526"><span class="linenos">526</span></a>        <span class="k">return</span> <span class="n">l</span>
</span><span id="LightningProxModel-527"><a href="#LightningProxModel-527"><span class="linenos">527</span></a>
</span><span id="LightningProxModel-528"><a href="#LightningProxModel-528"><span class="linenos">528</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-529"><a href="#LightningProxModel-529"><span class="linenos">529</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-530"><a href="#LightningProxModel-530"><span class="linenos">530</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel-531"><a href="#LightningProxModel-531"><span class="linenos">531</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-532"><a href="#LightningProxModel-532"><span class="linenos">532</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-533"><a href="#LightningProxModel-533"><span class="linenos">533</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-534"><a href="#LightningProxModel-534"><span class="linenos">534</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-535"><a href="#LightningProxModel-535"><span class="linenos">535</span></a>        <span class="c1"># num_neg_samples_fold: Optional[int] = 1,</span>
</span><span id="LightningProxModel-536"><a href="#LightningProxModel-536"><span class="linenos">536</span></a>        <span class="n">edgetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-537"><a href="#LightningProxModel-537"><span class="linenos">537</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-538"><a href="#LightningProxModel-538"><span class="linenos">538</span></a>        <span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-539"><a href="#LightningProxModel-539"><span class="linenos">539</span></a>    <span class="p">):</span>
</span><span id="LightningProxModel-540"><a href="#LightningProxModel-540"><span class="linenos">540</span></a>        <span class="n">nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_recon_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-541"><a href="#LightningProxModel-541"><span class="linenos">541</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-542"><a href="#LightningProxModel-542"><span class="linenos">542</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-543"><a href="#LightningProxModel-543"><span class="linenos">543</span></a>            <span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-544"><a href="#LightningProxModel-544"><span class="linenos">544</span></a>            <span class="n">pos_edge_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-545"><a href="#LightningProxModel-545"><span class="linenos">545</span></a>            <span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-546"><a href="#LightningProxModel-546"><span class="linenos">546</span></a>            <span class="c1"># num_neg_samples_fold,</span>
</span><span id="LightningProxModel-547"><a href="#LightningProxModel-547"><span class="linenos">547</span></a>            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
</span><span id="LightningProxModel-548"><a href="#LightningProxModel-548"><span class="linenos">548</span></a>            <span class="n">get_metric</span><span class="o">=</span><span class="n">get_metric</span><span class="p">,</span>
</span><span id="LightningProxModel-549"><a href="#LightningProxModel-549"><span class="linenos">549</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-550"><a href="#LightningProxModel-550"><span class="linenos">550</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-551"><a href="#LightningProxModel-551"><span class="linenos">551</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-552"><a href="#LightningProxModel-552"><span class="linenos">552</span></a>            <span class="k">if</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">:</span>
</span><span id="LightningProxModel-553"><a href="#LightningProxModel-553"><span class="linenos">553</span></a>                <span class="n">edgetype_weight</span> <span class="o">=</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel-554"><a href="#LightningProxModel-554"><span class="linenos">554</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-555"><a href="#LightningProxModel-555"><span class="linenos">555</span></a>                <span class="n">edgetype_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-556"><a href="#LightningProxModel-556"><span class="linenos">556</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">nll</span> <span class="o">*</span> <span class="n">edgetype_weight</span>
</span><span id="LightningProxModel-557"><a href="#LightningProxModel-557"><span class="linenos">557</span></a>        <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span><span id="LightningProxModel-558"><a href="#LightningProxModel-558"><span class="linenos">558</span></a>
</span><span id="LightningProxModel-559"><a href="#LightningProxModel-559"><span class="linenos">559</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel-560"><a href="#LightningProxModel-560"><span class="linenos">560</span></a>        <span class="n">edge_attr_type</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="LightningProxModel-561"><a href="#LightningProxModel-561"><span class="linenos">561</span></a>        <span class="n">edge_attr_type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">edge_attr_type</span><span class="p">)</span>
</span><span id="LightningProxModel-562"><a href="#LightningProxModel-562"><span class="linenos">562</span></a>        <span class="n">batch</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel-563"><a href="#LightningProxModel-563"><span class="linenos">563</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_type_subgraph</span><span class="p">([</span><span class="n">edge_attr_type</span><span class="p">])</span>
</span><span id="LightningProxModel-564"><a href="#LightningProxModel-564"><span class="linenos">564</span></a>            <span class="o">.</span><span class="n">edge_subgraph</span><span class="p">({</span><span class="n">edge_attr_type</span><span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)})</span>
</span><span id="LightningProxModel-565"><a href="#LightningProxModel-565"><span class="linenos">565</span></a>            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-566"><a href="#LightningProxModel-566"><span class="linenos">566</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-567"><a href="#LightningProxModel-567"><span class="linenos">567</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel-568"><a href="#LightningProxModel-568"><span class="linenos">568</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel-569"><a href="#LightningProxModel-569"><span class="linenos">569</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-570"><a href="#LightningProxModel-570"><span class="linenos">570</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-571"><a href="#LightningProxModel-571"><span class="linenos">571</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-572"><a href="#LightningProxModel-572"><span class="linenos">572</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-573"><a href="#LightningProxModel-573"><span class="linenos">573</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-574"><a href="#LightningProxModel-574"><span class="linenos">574</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-575"><a href="#LightningProxModel-575"><span class="linenos">575</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-576"><a href="#LightningProxModel-576"><span class="linenos">576</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span><span class="p">:</span>
</span><span id="LightningProxModel-577"><a href="#LightningProxModel-577"><span class="linenos">577</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-578"><a href="#LightningProxModel-578"><span class="linenos">578</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-579"><a href="#LightningProxModel-579"><span class="linenos">579</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-580"><a href="#LightningProxModel-580"><span class="linenos">580</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-581"><a href="#LightningProxModel-581"><span class="linenos">581</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-582"><a href="#LightningProxModel-582"><span class="linenos">582</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-583"><a href="#LightningProxModel-583"><span class="linenos">583</span></a>
</span><span id="LightningProxModel-584"><a href="#LightningProxModel-584"><span class="linenos">584</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">*=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="LightningProxModel-585"><a href="#LightningProxModel-585"><span class="linenos">585</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span>
</span><span id="LightningProxModel-586"><a href="#LightningProxModel-586"><span class="linenos">586</span></a>            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span><span class="p">)</span>
</span><span id="LightningProxModel-587"><a href="#LightningProxModel-587"><span class="linenos">587</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-588"><a href="#LightningProxModel-588"><span class="linenos">588</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="LightningProxModel-589"><a href="#LightningProxModel-589"><span class="linenos">589</span></a>
</span><span id="LightningProxModel-590"><a href="#LightningProxModel-590"><span class="linenos">590</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-591"><a href="#LightningProxModel-591"><span class="linenos">591</span></a>            <span class="s2">&quot;nll_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-592"><a href="#LightningProxModel-592"><span class="linenos">592</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span><span class="p">,</span>
</span><span id="LightningProxModel-593"><a href="#LightningProxModel-593"><span class="linenos">593</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel-594"><a href="#LightningProxModel-594"><span class="linenos">594</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-595"><a href="#LightningProxModel-595"><span class="linenos">595</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-596"><a href="#LightningProxModel-596"><span class="linenos">596</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-597"><a href="#LightningProxModel-597"><span class="linenos">597</span></a>        <span class="c1"># Log per-batch (step) NLL in addition to per-epoch aggregation</span>
</span><span id="LightningProxModel-598"><a href="#LightningProxModel-598"><span class="linenos">598</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-599"><a href="#LightningProxModel-599"><span class="linenos">599</span></a>            <span class="s2">&quot;nll_loss_step&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-600"><a href="#LightningProxModel-600"><span class="linenos">600</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span><span class="p">,</span>
</span><span id="LightningProxModel-601"><a href="#LightningProxModel-601"><span class="linenos">601</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel-602"><a href="#LightningProxModel-602"><span class="linenos">602</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-603"><a href="#LightningProxModel-603"><span class="linenos">603</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-604"><a href="#LightningProxModel-604"><span class="linenos">604</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-605"><a href="#LightningProxModel-605"><span class="linenos">605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-606"><a href="#LightningProxModel-606"><span class="linenos">606</span></a>            <span class="s2">&quot;kl_div_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-607"><a href="#LightningProxModel-607"><span class="linenos">607</span></a>            <span class="n">batch_kl_div_loss</span><span class="p">,</span>
</span><span id="LightningProxModel-608"><a href="#LightningProxModel-608"><span class="linenos">608</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel-609"><a href="#LightningProxModel-609"><span class="linenos">609</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-610"><a href="#LightningProxModel-610"><span class="linenos">610</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-611"><a href="#LightningProxModel-611"><span class="linenos">611</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-612"><a href="#LightningProxModel-612"><span class="linenos">612</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span> <span class="o">+</span> <span class="n">batch_kl_div_loss</span>
</span><span id="LightningProxModel-613"><a href="#LightningProxModel-613"><span class="linenos">613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-614"><a href="#LightningProxModel-614"><span class="linenos">614</span></a>            <span class="s2">&quot;loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-615"><a href="#LightningProxModel-615"><span class="linenos">615</span></a>            <span class="n">loss</span><span class="p">,</span>
</span><span id="LightningProxModel-616"><a href="#LightningProxModel-616"><span class="linenos">616</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel-617"><a href="#LightningProxModel-617"><span class="linenos">617</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-618"><a href="#LightningProxModel-618"><span class="linenos">618</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-619"><a href="#LightningProxModel-619"><span class="linenos">619</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-620"><a href="#LightningProxModel-620"><span class="linenos">620</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span><span id="LightningProxModel-621"><a href="#LightningProxModel-621"><span class="linenos">621</span></a>
</span><span id="LightningProxModel-622"><a href="#LightningProxModel-622"><span class="linenos">622</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel-623"><a href="#LightningProxModel-623"><span class="linenos">623</span></a>        <span class="n">edge_attr_type</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="LightningProxModel-624"><a href="#LightningProxModel-624"><span class="linenos">624</span></a>        <span class="n">edge_attr_type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">edge_attr_type</span><span class="p">)</span>
</span><span id="LightningProxModel-625"><a href="#LightningProxModel-625"><span class="linenos">625</span></a>        <span class="n">batch</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel-626"><a href="#LightningProxModel-626"><span class="linenos">626</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_type_subgraph</span><span class="p">([</span><span class="n">edge_attr_type</span><span class="p">])</span>
</span><span id="LightningProxModel-627"><a href="#LightningProxModel-627"><span class="linenos">627</span></a>            <span class="o">.</span><span class="n">edge_subgraph</span><span class="p">({</span><span class="n">edge_attr_type</span><span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)})</span>
</span><span id="LightningProxModel-628"><a href="#LightningProxModel-628"><span class="linenos">628</span></a>            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-629"><a href="#LightningProxModel-629"><span class="linenos">629</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-630"><a href="#LightningProxModel-630"><span class="linenos">630</span></a>
</span><span id="LightningProxModel-631"><a href="#LightningProxModel-631"><span class="linenos">631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="LightningProxModel-632"><a href="#LightningProxModel-632"><span class="linenos">632</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel-633"><a href="#LightningProxModel-633"><span class="linenos">633</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel-634"><a href="#LightningProxModel-634"><span class="linenos">634</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-635"><a href="#LightningProxModel-635"><span class="linenos">635</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-636"><a href="#LightningProxModel-636"><span class="linenos">636</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-637"><a href="#LightningProxModel-637"><span class="linenos">637</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-638"><a href="#LightningProxModel-638"><span class="linenos">638</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-639"><a href="#LightningProxModel-639"><span class="linenos">639</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-640"><a href="#LightningProxModel-640"><span class="linenos">640</span></a>            <span class="n">get_metric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-641"><a href="#LightningProxModel-641"><span class="linenos">641</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-642"><a href="#LightningProxModel-642"><span class="linenos">642</span></a>
</span><span id="LightningProxModel-643"><a href="#LightningProxModel-643"><span class="linenos">643</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span><span class="p">:</span>
</span><span id="LightningProxModel-644"><a href="#LightningProxModel-644"><span class="linenos">644</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-645"><a href="#LightningProxModel-645"><span class="linenos">645</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-646"><a href="#LightningProxModel-646"><span class="linenos">646</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-647"><a href="#LightningProxModel-647"><span class="linenos">647</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-648"><a href="#LightningProxModel-648"><span class="linenos">648</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-649"><a href="#LightningProxModel-649"><span class="linenos">649</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-650"><a href="#LightningProxModel-650"><span class="linenos">650</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-651"><a href="#LightningProxModel-651"><span class="linenos">651</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="LightningProxModel-652"><a href="#LightningProxModel-652"><span class="linenos">652</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span> <span class="o">+</span> <span class="n">batch_kl_div_loss</span>
</span><span id="LightningProxModel-653"><a href="#LightningProxModel-653"><span class="linenos">653</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-654"><a href="#LightningProxModel-654"><span class="linenos">654</span></a>            <span class="s2">&quot;val_nll_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-655"><a href="#LightningProxModel-655"><span class="linenos">655</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span><span class="p">,</span>
</span><span id="LightningProxModel-656"><a href="#LightningProxModel-656"><span class="linenos">656</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel-657"><a href="#LightningProxModel-657"><span class="linenos">657</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-658"><a href="#LightningProxModel-658"><span class="linenos">658</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-659"><a href="#LightningProxModel-659"><span class="linenos">659</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-660"><a href="#LightningProxModel-660"><span class="linenos">660</span></a>        <span class="c1"># Also log per-validation-step NLL (so we can monitor batch-level val NLL)</span>
</span><span id="LightningProxModel-661"><a href="#LightningProxModel-661"><span class="linenos">661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-662"><a href="#LightningProxModel-662"><span class="linenos">662</span></a>            <span class="s2">&quot;val_nll_loss_step&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-663"><a href="#LightningProxModel-663"><span class="linenos">663</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span><span class="p">,</span>
</span><span id="LightningProxModel-664"><a href="#LightningProxModel-664"><span class="linenos">664</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel-665"><a href="#LightningProxModel-665"><span class="linenos">665</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-666"><a href="#LightningProxModel-666"><span class="linenos">666</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-667"><a href="#LightningProxModel-667"><span class="linenos">667</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-668"><a href="#LightningProxModel-668"><span class="linenos">668</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-669"><a href="#LightningProxModel-669"><span class="linenos">669</span></a>            <span class="s2">&quot;val_nll_loss_monitored&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-670"><a href="#LightningProxModel-670"><span class="linenos">670</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span>
</span><span id="LightningProxModel-671"><a href="#LightningProxModel-671"><span class="linenos">671</span></a>            <span class="o">+</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="LightningProxModel-672"><a href="#LightningProxModel-672"><span class="linenos">672</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel-673"><a href="#LightningProxModel-673"><span class="linenos">673</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-674"><a href="#LightningProxModel-674"><span class="linenos">674</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-675"><a href="#LightningProxModel-675"><span class="linenos">675</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-676"><a href="#LightningProxModel-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-677"><a href="#LightningProxModel-677"><span class="linenos">677</span></a>            <span class="s2">&quot;val_kl_div_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-678"><a href="#LightningProxModel-678"><span class="linenos">678</span></a>            <span class="n">batch_kl_div_loss</span><span class="p">,</span>
</span><span id="LightningProxModel-679"><a href="#LightningProxModel-679"><span class="linenos">679</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel-680"><a href="#LightningProxModel-680"><span class="linenos">680</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-681"><a href="#LightningProxModel-681"><span class="linenos">681</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-682"><a href="#LightningProxModel-682"><span class="linenos">682</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-683"><a href="#LightningProxModel-683"><span class="linenos">683</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-684"><a href="#LightningProxModel-684"><span class="linenos">684</span></a>            <span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-685"><a href="#LightningProxModel-685"><span class="linenos">685</span></a>            <span class="n">loss</span><span class="p">,</span>
</span><span id="LightningProxModel-686"><a href="#LightningProxModel-686"><span class="linenos">686</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel-687"><a href="#LightningProxModel-687"><span class="linenos">687</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-688"><a href="#LightningProxModel-688"><span class="linenos">688</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-689"><a href="#LightningProxModel-689"><span class="linenos">689</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-690"><a href="#LightningProxModel-690"><span class="linenos">690</span></a>
</span><span id="LightningProxModel-691"><a href="#LightningProxModel-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="LightningProxModel-692"><a href="#LightningProxModel-692"><span class="linenos">692</span></a>
</span><span id="LightningProxModel-693"><a href="#LightningProxModel-693"><span class="linenos">693</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span><span id="LightningProxModel-694"><a href="#LightningProxModel-694"><span class="linenos">694</span></a>
</span><span id="LightningProxModel-695"><a href="#LightningProxModel-695"><span class="linenos">695</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mean_cell_neighbor_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
</span><span id="LightningProxModel-696"><a href="#LightningProxModel-696"><span class="linenos">696</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-697"><a href="#LightningProxModel-697"><span class="linenos">697</span></a><span class="sd">        Calculates the mean distance between each cell node and its k nearest neighbors.</span>
</span><span id="LightningProxModel-698"><a href="#LightningProxModel-698"><span class="linenos">698</span></a><span class="sd">        Returns a tensor of mean distances for each cell.</span>
</span><span id="LightningProxModel-699"><a href="#LightningProxModel-699"><span class="linenos">699</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-700"><a href="#LightningProxModel-700"><span class="linenos">700</span></a>        <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># (num_cells, latent_dim)</span>
</span><span id="LightningProxModel-701"><a href="#LightningProxModel-701"><span class="linenos">701</span></a>        <span class="c1"># Compute pairwise Euclidean distances</span>
</span><span id="LightningProxModel-702"><a href="#LightningProxModel-702"><span class="linenos">702</span></a>        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="n">cell_mu</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (num_cells, num_cells)</span>
</span><span id="LightningProxModel-703"><a href="#LightningProxModel-703"><span class="linenos">703</span></a>        <span class="c1"># Exclude self-distance by setting diagonal to infinity</span>
</span><span id="LightningProxModel-704"><a href="#LightningProxModel-704"><span class="linenos">704</span></a>        <span class="n">dist_matrix</span><span class="o">.</span><span class="n">fill_diagonal_</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</span><span id="LightningProxModel-705"><a href="#LightningProxModel-705"><span class="linenos">705</span></a>        <span class="c1"># Find k nearest neighbors for each cell</span>
</span><span id="LightningProxModel-706"><a href="#LightningProxModel-706"><span class="linenos">706</span></a>        <span class="n">knn_distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel-707"><a href="#LightningProxModel-707"><span class="linenos">707</span></a>        <span class="c1"># Mean distance to k nearest neighbors for each cell</span>
</span><span id="LightningProxModel-708"><a href="#LightningProxModel-708"><span class="linenos">708</span></a>        <span class="n">mean_distances</span> <span class="o">=</span> <span class="n">knn_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel-709"><a href="#LightningProxModel-709"><span class="linenos">709</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">mean_distances</span> <span class="o">/</span> <span class="n">mean_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="LightningProxModel-710"><a href="#LightningProxModel-710"><span class="linenos">710</span></a>        <span class="k">return</span> <span class="n">weights</span>  <span class="c1"># shape: (num_cells,)</span>
</span><span id="LightningProxModel-711"><a href="#LightningProxModel-711"><span class="linenos">711</span></a>
</span><span id="LightningProxModel-712"><a href="#LightningProxModel-712"><span class="linenos">712</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-713"><a href="#LightningProxModel-713"><span class="linenos">713</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightningProxModel-714"><a href="#LightningProxModel-714"><span class="linenos">714</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">is_last_batch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-715"><a href="#LightningProxModel-715"><span class="linenos">715</span></a>            <span class="n">hsic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">custom_train</span><span class="p">(</span>
</span><span id="LightningProxModel-716"><a href="#LightningProxModel-716"><span class="linenos">716</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span>
</span><span id="LightningProxModel-717"><a href="#LightningProxModel-717"><span class="linenos">717</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-718"><a href="#LightningProxModel-718"><span class="linenos">718</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;hsic_loss&quot;</span><span class="p">,</span> <span class="n">hsic_loss</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-719"><a href="#LightningProxModel-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-720"><a href="#LightningProxModel-720"><span class="linenos">720</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-721"><a href="#LightningProxModel-721"><span class="linenos">721</span></a>                <span class="s2">&quot;hsic_lr&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-722"><a href="#LightningProxModel-722"><span class="linenos">722</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel-723"><a href="#LightningProxModel-723"><span class="linenos">723</span></a>                <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-724"><a href="#LightningProxModel-724"><span class="linenos">724</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-725"><a href="#LightningProxModel-725"><span class="linenos">725</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span>
</span><span id="LightningProxModel-726"><a href="#LightningProxModel-726"><span class="linenos">726</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_cell_neighbor_distance</span><span class="p">(</span>
</span><span id="LightningProxModel-727"><a href="#LightningProxModel-727"><span class="linenos">727</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span>
</span><span id="LightningProxModel-728"><a href="#LightningProxModel-728"><span class="linenos">728</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-729"><a href="#LightningProxModel-729"><span class="linenos">729</span></a>
</span><span id="LightningProxModel-730"><a href="#LightningProxModel-730"><span class="linenos">730</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-731"><a href="#LightningProxModel-731"><span class="linenos">731</span></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</span><span id="LightningProxModel-732"><a href="#LightningProxModel-732"><span class="linenos">732</span></a>        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
</span><span id="LightningProxModel-733"><a href="#LightningProxModel-733"><span class="linenos">733</span></a>            <span class="n">optimizer</span><span class="p">,</span>
</span><span id="LightningProxModel-734"><a href="#LightningProxModel-734"><span class="linenos">734</span></a>            <span class="n">patience</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="LightningProxModel-735"><a href="#LightningProxModel-735"><span class="linenos">735</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-736"><a href="#LightningProxModel-736"><span class="linenos">736</span></a>        <span class="c1"># scheduler = CyclicLR(</span>
</span><span id="LightningProxModel-737"><a href="#LightningProxModel-737"><span class="linenos">737</span></a>        <span class="c1">#     optimizer,</span>
</span><span id="LightningProxModel-738"><a href="#LightningProxModel-738"><span class="linenos">738</span></a>        <span class="c1">#     self.learning_rate / 2,</span>
</span><span id="LightningProxModel-739"><a href="#LightningProxModel-739"><span class="linenos">739</span></a>        <span class="c1">#     self.learning_rate * 2,</span>
</span><span id="LightningProxModel-740"><a href="#LightningProxModel-740"><span class="linenos">740</span></a>        <span class="c1">#     step_size_up=10,</span>
</span><span id="LightningProxModel-741"><a href="#LightningProxModel-741"><span class="linenos">741</span></a>        <span class="c1">#     mode=&quot;triangular2&quot;,</span>
</span><span id="LightningProxModel-742"><a href="#LightningProxModel-742"><span class="linenos">742</span></a>        <span class="c1"># )</span>
</span><span id="LightningProxModel-743"><a href="#LightningProxModel-743"><span class="linenos">743</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">optimizer</span><span class="p">],</span> <span class="p">[</span>
</span><span id="LightningProxModel-744"><a href="#LightningProxModel-744"><span class="linenos">744</span></a>            <span class="p">{</span>
</span><span id="LightningProxModel-745"><a href="#LightningProxModel-745"><span class="linenos">745</span></a>                <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">scheduler</span><span class="p">,</span>
</span><span id="LightningProxModel-746"><a href="#LightningProxModel-746"><span class="linenos">746</span></a>                <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-747"><a href="#LightningProxModel-747"><span class="linenos">747</span></a>                <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel-748"><a href="#LightningProxModel-748"><span class="linenos">748</span></a>                <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="s2">&quot;val_nll_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-749"><a href="#LightningProxModel-749"><span class="linenos">749</span></a>                <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-750"><a href="#LightningProxModel-750"><span class="linenos">750</span></a>            <span class="p">}</span>
</span><span id="LightningProxModel-751"><a href="#LightningProxModel-751"><span class="linenos">751</span></a>        <span class="p">]</span>
</span><span id="LightningProxModel-752"><a href="#LightningProxModel-752"><span class="linenos">752</span></a>
</span><span id="LightningProxModel-753"><a href="#LightningProxModel-753"><span class="linenos">753</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">lr_scheduler_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
</span><span id="LightningProxModel-754"><a href="#LightningProxModel-754"><span class="linenos">754</span></a>        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-755"><a href="#LightningProxModel-755"><span class="linenos">755</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="LightningProxModel-756"><a href="#LightningProxModel-756"><span class="linenos">756</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-757"><a href="#LightningProxModel-757"><span class="linenos">757</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
</span><span id="LightningProxModel-758"><a href="#LightningProxModel-758"><span class="linenos">758</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-759"><a href="#LightningProxModel-759"><span class="linenos">759</span></a>            <span class="n">update_lr</span><span class="p">(</span>
</span><span id="LightningProxModel-760"><a href="#LightningProxModel-760"><span class="linenos">760</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span>
</span><span id="LightningProxModel-761"><a href="#LightningProxModel-761"><span class="linenos">761</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="LightningProxModel-762"><a href="#LightningProxModel-762"><span class="linenos">762</span></a>                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">lr_scheduler_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span>
</span><span id="LightningProxModel-763"><a href="#LightningProxModel-763"><span class="linenos">763</span></a>                    <span class="mi">0</span>
</span><span id="LightningProxModel-764"><a href="#LightningProxModel-764"><span class="linenos">764</span></a>                <span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel-765"><a href="#LightningProxModel-765"><span class="linenos">765</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-766"><a href="#LightningProxModel-766"><span class="linenos">766</span></a>
</span><span id="LightningProxModel-767"><a href="#LightningProxModel-767"><span class="linenos">767</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
</span><span id="LightningProxModel-768"><a href="#LightningProxModel-768"><span class="linenos">768</span></a>        <span class="c1"># Remove the argument from the checkpoint before it is saved</span>
</span><span id="LightningProxModel-769"><a href="#LightningProxModel-769"><span class="linenos">769</span></a>        <span class="n">checkpoint</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;train_data_dict&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Hooks to be used in LightningModule.</p>
</div>


                            <div id="LightningProxModel.__init__" class="classattr">
                                        <input id="LightningProxModel.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LightningProxModel</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span>,</span><span class="param">	encoder_class: torch.nn.modules.module.Module = &lt;class &#x27;<a href="encoders.html#TransEncoder">simba_plus.encoders.TransEncoder</a>&#x27;&gt;,</span><span class="param">	<span class="n">n_hidden_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>,</span><span class="param">	<span class="n">n_latent_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	decoder_class: torch.nn.modules.module.Module = &lt;class &#x27;<a href="decoders.html#RelationalEdgeDistributionDecoder">simba_plus.decoders.RelationalEdgeDistributionDecoder</a>&#x27;&gt;,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span>,</span><span class="param">	<span class="n">num_neg_samples_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">project_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">edgetype_specific_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">edgetype_specific_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">edgetype_specific_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">edge_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">hsic</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">n_no_kl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">n_count_nodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>,</span><span class="param">	<span class="n">n_kl_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">nll_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">val_nll_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span>,</span><span class="param">	<span class="n">node_weights_dict</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">nonneg</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">reweight_rarecell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">reweight_rarecell_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">positive_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">train_data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">val_data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="LightningProxModel.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.__init__-31"><a href="#LightningProxModel.__init__-31"><span class="linenos"> 31</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-32"><a href="#LightningProxModel.__init__-32"><span class="linenos"> 32</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-33"><a href="#LightningProxModel.__init__-33"><span class="linenos"> 33</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-34"><a href="#LightningProxModel.__init__-34"><span class="linenos"> 34</span></a>        <span class="n">encoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">TransEncoder</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-35"><a href="#LightningProxModel.__init__-35"><span class="linenos"> 35</span></a>        <span class="n">n_hidden_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-36"><a href="#LightningProxModel.__init__-36"><span class="linenos"> 36</span></a>        <span class="n">n_latent_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-37"><a href="#LightningProxModel.__init__-37"><span class="linenos"> 37</span></a>        <span class="n">decoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">RelationalEdgeDistributionDecoder</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-38"><a href="#LightningProxModel.__init__-38"><span class="linenos"> 38</span></a>        <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-39"><a href="#LightningProxModel.__init__-39"><span class="linenos"> 39</span></a>        <span class="n">num_neg_samples_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-40"><a href="#LightningProxModel.__init__-40"><span class="linenos"> 40</span></a>        <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-41"><a href="#LightningProxModel.__init__-41"><span class="linenos"> 41</span></a>        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-42"><a href="#LightningProxModel.__init__-42"><span class="linenos"> 42</span></a>        <span class="n">project_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-43"><a href="#LightningProxModel.__init__-43"><span class="linenos"> 43</span></a>        <span class="n">edgetype_specific_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-44"><a href="#LightningProxModel.__init__-44"><span class="linenos"> 44</span></a>        <span class="n">edgetype_specific_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-45"><a href="#LightningProxModel.__init__-45"><span class="linenos"> 45</span></a>        <span class="n">edgetype_specific_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-46"><a href="#LightningProxModel.__init__-46"><span class="linenos"> 46</span></a>        <span class="n">edge_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-47"><a href="#LightningProxModel.__init__-47"><span class="linenos"> 47</span></a>        <span class="n">hsic</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-48"><a href="#LightningProxModel.__init__-48"><span class="linenos"> 48</span></a>        <span class="n">n_no_kl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-49"><a href="#LightningProxModel.__init__-49"><span class="linenos"> 49</span></a>        <span class="n">n_count_nodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-50"><a href="#LightningProxModel.__init__-50"><span class="linenos"> 50</span></a>        <span class="n">n_kl_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-51"><a href="#LightningProxModel.__init__-51"><span class="linenos"> 51</span></a>        <span class="n">nll_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-52"><a href="#LightningProxModel.__init__-52"><span class="linenos"> 52</span></a>        <span class="n">val_nll_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-53"><a href="#LightningProxModel.__init__-53"><span class="linenos"> 53</span></a>        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-54"><a href="#LightningProxModel.__init__-54"><span class="linenos"> 54</span></a>        <span class="n">node_weights_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-55"><a href="#LightningProxModel.__init__-55"><span class="linenos"> 55</span></a>        <span class="n">nonneg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-56"><a href="#LightningProxModel.__init__-56"><span class="linenos"> 56</span></a>        <span class="n">reweight_rarecell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-57"><a href="#LightningProxModel.__init__-57"><span class="linenos"> 57</span></a>        <span class="n">reweight_rarecell_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-58"><a href="#LightningProxModel.__init__-58"><span class="linenos"> 58</span></a>        <span class="n">positive_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-59"><a href="#LightningProxModel.__init__-59"><span class="linenos"> 59</span></a>        <span class="n">train_data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-60"><a href="#LightningProxModel.__init__-60"><span class="linenos"> 60</span></a>        <span class="n">val_data_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-61"><a href="#LightningProxModel.__init__-61"><span class="linenos"> 61</span></a>    <span class="p">):</span>
</span><span id="LightningProxModel.__init__-62"><a href="#LightningProxModel.__init__-62"><span class="linenos"> 62</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-63"><a href="#LightningProxModel.__init__-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_hyperparameters</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-64"><a href="#LightningProxModel.__init__-64"><span class="linenos"> 64</span></a>        <span class="n">data</span><span class="o">.</span><span class="n">generate_ids</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-65"><a href="#LightningProxModel.__init__-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nonneg</span> <span class="o">=</span> <span class="n">nonneg</span>
</span><span id="LightningProxModel.__init__-66"><a href="#LightningProxModel.__init__-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="LightningProxModel.__init__-67"><a href="#LightningProxModel.__init__-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
</span><span id="LightningProxModel.__init__-68"><a href="#LightningProxModel.__init__-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder_class</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-69"><a href="#LightningProxModel.__init__-69"><span class="linenos"> 69</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-70"><a href="#LightningProxModel.__init__-70"><span class="linenos"> 70</span></a>            <span class="n">n_hidden_dims</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-71"><a href="#LightningProxModel.__init__-71"><span class="linenos"> 71</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-72"><a href="#LightningProxModel.__init__-72"><span class="linenos"> 72</span></a>            <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-73"><a href="#LightningProxModel.__init__-73"><span class="linenos"> 73</span></a>            <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-74"><a href="#LightningProxModel.__init__-74"><span class="linenos"> 74</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-75"><a href="#LightningProxModel.__init__-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder_class</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-76"><a href="#LightningProxModel.__init__-76"><span class="linenos"> 76</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-77"><a href="#LightningProxModel.__init__-77"><span class="linenos"> 77</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-78"><a href="#LightningProxModel.__init__-78"><span class="linenos"> 78</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-79"><a href="#LightningProxModel.__init__-79"><span class="linenos"> 79</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-80"><a href="#LightningProxModel.__init__-80"><span class="linenos"> 80</span></a>            <span class="n">project</span><span class="o">=</span><span class="n">project_decoder</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-81"><a href="#LightningProxModel.__init__-81"><span class="linenos"> 81</span></a>            <span class="n">edgetype_specific_bias</span><span class="o">=</span><span class="n">edgetype_specific_bias</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-82"><a href="#LightningProxModel.__init__-82"><span class="linenos"> 82</span></a>            <span class="n">edgetype_specific_scale</span><span class="o">=</span><span class="n">edgetype_specific_scale</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-83"><a href="#LightningProxModel.__init__-83"><span class="linenos"> 83</span></a>            <span class="n">edgetype_specific_std</span><span class="o">=</span><span class="n">edgetype_specific_std</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-84"><a href="#LightningProxModel.__init__-84"><span class="linenos"> 84</span></a>            <span class="n">positive_scale</span><span class="o">=</span><span class="n">positive_scale</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-85"><a href="#LightningProxModel.__init__-85"><span class="linenos"> 85</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-86"><a href="#LightningProxModel.__init__-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="o">=</span> <span class="n">hsic</span>
</span><span id="LightningProxModel.__init__-87"><a href="#LightningProxModel.__init__-87"><span class="linenos"> 87</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-88"><a href="#LightningProxModel.__init__-88"><span class="linenos"> 88</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-89"><a href="#LightningProxModel.__init__-89"><span class="linenos"> 89</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="LightningProxModel.__init__-90"><a href="#LightningProxModel.__init__-90"><span class="linenos"> 90</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-91"><a href="#LightningProxModel.__init__-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span> <span class="o">=</span> <span class="n">n_no_kl</span>
</span><span id="LightningProxModel.__init__-92"><a href="#LightningProxModel.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_count_nodes</span> <span class="o">=</span> <span class="n">n_count_nodes</span>
</span><span id="LightningProxModel.__init__-93"><a href="#LightningProxModel.__init__-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">=</span> <span class="n">n_kl_warmup</span>
</span><span id="LightningProxModel.__init__-94"><a href="#LightningProxModel.__init__-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span> <span class="o">=</span> <span class="n">nll_scale</span>
</span><span id="LightningProxModel.__init__-95"><a href="#LightningProxModel.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span> <span class="o">=</span> <span class="n">val_nll_scale</span>
</span><span id="LightningProxModel.__init__-96"><a href="#LightningProxModel.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightningProxModel.__init__-97"><a href="#LightningProxModel.__init__-97"><span class="linenos"> 97</span></a>            <span class="n">node_type</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">node_type</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">x_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-98"><a href="#LightningProxModel.__init__-98"><span class="linenos"> 98</span></a>        <span class="p">}</span>
</span><span id="LightningProxModel.__init__-99"><a href="#LightningProxModel.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_data_dict</span> <span class="o">=</span> <span class="n">train_data_dict</span>
</span><span id="LightningProxModel.__init__-100"><a href="#LightningProxModel.__init__-100"><span class="linenos">100</span></a>        <span class="k">if</span> <span class="n">train_data_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-101"><a href="#LightningProxModel.__init__-101"><span class="linenos">101</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_subgraph</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-102"><a href="#LightningProxModel.__init__-102"><span class="linenos">102</span></a>                <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">train_data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="LightningProxModel.__init__-103"><a href="#LightningProxModel.__init__-103"><span class="linenos">103</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-104"><a href="#LightningProxModel.__init__-104"><span class="linenos">104</span></a>            <span class="n">train_val_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.__init__-105"><a href="#LightningProxModel.__init__-105"><span class="linenos">105</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">train_data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel.__init__-106"><a href="#LightningProxModel.__init__-106"><span class="linenos">106</span></a>                <span class="n">train_val_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">train_data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">val_data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
</span><span id="LightningProxModel.__init__-107"><a href="#LightningProxModel.__init__-107"><span class="linenos">107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_val_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_subgraph</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-108"><a href="#LightningProxModel.__init__-108"><span class="linenos">108</span></a>                <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">train_val_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="LightningProxModel.__init__-109"><a href="#LightningProxModel.__init__-109"><span class="linenos">109</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-110"><a href="#LightningProxModel.__init__-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span> <span class="o">=</span> <span class="n">reweight_rarecell</span>
</span><span id="LightningProxModel.__init__-111"><a href="#LightningProxModel.__init__-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-112"><a href="#LightningProxModel.__init__-112"><span class="linenos">112</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-113"><a href="#LightningProxModel.__init__-113"><span class="linenos">113</span></a>            <span class="k">if</span> <span class="n">reweight_rarecell_neighbors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-114"><a href="#LightningProxModel.__init__-114"><span class="linenos">114</span></a>                <span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="LightningProxModel.__init__-115"><a href="#LightningProxModel.__init__-115"><span class="linenos">115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="n">reweight_rarecell_neighbors</span>
</span><span id="LightningProxModel.__init__-116"><a href="#LightningProxModel.__init__-116"><span class="linenos">116</span></a>        <span class="k">if</span> <span class="n">edge_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-117"><a href="#LightningProxModel.__init__-117"><span class="linenos">117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="LightningProxModel.__init__-118"><a href="#LightningProxModel.__init__-118"><span class="linenos">118</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-119"><a href="#LightningProxModel.__init__-119"><span class="linenos">119</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">edge_types</span>
</span><span id="LightningProxModel.__init__-120"><a href="#LightningProxModel.__init__-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightningProxModel.__init__-121"><a href="#LightningProxModel.__init__-121"><span class="linenos">121</span></a>            <span class="n">edgetype</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">num_edges</span>
</span><span id="LightningProxModel.__init__-122"><a href="#LightningProxModel.__init__-122"><span class="linenos">122</span></a>            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">)</span>  <span class="c1"># mean $ edges</span>
</span><span id="LightningProxModel.__init__-123"><a href="#LightningProxModel.__init__-123"><span class="linenos">123</span></a>            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">edgetype</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="LightningProxModel.__init__-124"><a href="#LightningProxModel.__init__-124"><span class="linenos">124</span></a>            <span class="k">for</span> <span class="n">edgetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="LightningProxModel.__init__-125"><a href="#LightningProxModel.__init__-125"><span class="linenos">125</span></a>        <span class="p">}</span>
</span><span id="LightningProxModel.__init__-126"><a href="#LightningProxModel.__init__-126"><span class="linenos">126</span></a>
</span><span id="LightningProxModel.__init__-127"><a href="#LightningProxModel.__init__-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="n">node_weights_dict</span>
</span><span id="LightningProxModel.__init__-128"><a href="#LightningProxModel.__init__-128"><span class="linenos">128</span></a>
</span><span id="LightningProxModel.__init__-129"><a href="#LightningProxModel.__init__-129"><span class="linenos">129</span></a>        <span class="c1"># Batch correction for RNA-seq data</span>
</span><span id="LightningProxModel.__init__-130"><a href="#LightningProxModel.__init__-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-131"><a href="#LightningProxModel.__init__-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-132"><a href="#LightningProxModel.__init__-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-133"><a href="#LightningProxModel.__init__-133"><span class="linenos">133</span></a>        <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-134"><a href="#LightningProxModel.__init__-134"><span class="linenos">134</span></a>            <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel.__init__-135"><a href="#LightningProxModel.__init__-135"><span class="linenos">135</span></a>            <span class="k">if</span> <span class="n">edgetype_specific_bias</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-136"><a href="#LightningProxModel.__init__-136"><span class="linenos">136</span></a>                <span class="n">src_bias_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-137"><a href="#LightningProxModel.__init__-137"><span class="linenos">137</span></a>                <span class="n">dst_bias_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-138"><a href="#LightningProxModel.__init__-138"><span class="linenos">138</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-139"><a href="#LightningProxModel.__init__-139"><span class="linenos">139</span></a>                <span class="n">src_bias_key</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="LightningProxModel.__init__-140"><a href="#LightningProxModel.__init__-140"><span class="linenos">140</span></a>                <span class="n">dst_bias_key</span> <span class="o">=</span> <span class="n">dst</span>
</span><span id="LightningProxModel.__init__-141"><a href="#LightningProxModel.__init__-141"><span class="linenos">141</span></a>            <span class="k">if</span> <span class="n">edgetype_specific_scale</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-142"><a href="#LightningProxModel.__init__-142"><span class="linenos">142</span></a>                <span class="n">src_scale_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-143"><a href="#LightningProxModel.__init__-143"><span class="linenos">143</span></a>                <span class="n">dst_scale_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-144"><a href="#LightningProxModel.__init__-144"><span class="linenos">144</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-145"><a href="#LightningProxModel.__init__-145"><span class="linenos">145</span></a>                <span class="n">src_scale_key</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="LightningProxModel.__init__-146"><a href="#LightningProxModel.__init__-146"><span class="linenos">146</span></a>                <span class="n">dst_scale_key</span> <span class="o">=</span> <span class="n">dst</span>
</span><span id="LightningProxModel.__init__-147"><a href="#LightningProxModel.__init__-147"><span class="linenos">147</span></a>            <span class="k">if</span> <span class="n">edgetype_specific_std</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-148"><a href="#LightningProxModel.__init__-148"><span class="linenos">148</span></a>                <span class="n">src_std_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-149"><a href="#LightningProxModel.__init__-149"><span class="linenos">149</span></a>                <span class="n">dst_std_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-150"><a href="#LightningProxModel.__init__-150"><span class="linenos">150</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-151"><a href="#LightningProxModel.__init__-151"><span class="linenos">151</span></a>                <span class="n">src_std_key</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="LightningProxModel.__init__-152"><a href="#LightningProxModel.__init__-152"><span class="linenos">152</span></a>                <span class="n">dst_std_key</span> <span class="o">=</span> <span class="n">dst</span>
</span><span id="LightningProxModel.__init__-153"><a href="#LightningProxModel.__init__-153"><span class="linenos">153</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-154"><a href="#LightningProxModel.__init__-154"><span class="linenos">154</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-155"><a href="#LightningProxModel.__init__-155"><span class="linenos">155</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-156"><a href="#LightningProxModel.__init__-156"><span class="linenos">156</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.__init__-157"><a href="#LightningProxModel.__init__-157"><span class="linenos">157</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-158"><a href="#LightningProxModel.__init__-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-159"><a href="#LightningProxModel.__init__-159"><span class="linenos">159</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-160"><a href="#LightningProxModel.__init__-160"><span class="linenos">160</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-161"><a href="#LightningProxModel.__init__-161"><span class="linenos">161</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.__init__-162"><a href="#LightningProxModel.__init__-162"><span class="linenos">162</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-163"><a href="#LightningProxModel.__init__-163"><span class="linenos">163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">src_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-164"><a href="#LightningProxModel.__init__-164"><span class="linenos">164</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-165"><a href="#LightningProxModel.__init__-165"><span class="linenos">165</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-166"><a href="#LightningProxModel.__init__-166"><span class="linenos">166</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.__init__-167"><a href="#LightningProxModel.__init__-167"><span class="linenos">167</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-168"><a href="#LightningProxModel.__init__-168"><span class="linenos">168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">dst_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-169"><a href="#LightningProxModel.__init__-169"><span class="linenos">169</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-170"><a href="#LightningProxModel.__init__-170"><span class="linenos">170</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-171"><a href="#LightningProxModel.__init__-171"><span class="linenos">171</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.__init__-172"><a href="#LightningProxModel.__init__-172"><span class="linenos">172</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-173"><a href="#LightningProxModel.__init__-173"><span class="linenos">173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_std_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-174"><a href="#LightningProxModel.__init__-174"><span class="linenos">174</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-175"><a href="#LightningProxModel.__init__-175"><span class="linenos">175</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-176"><a href="#LightningProxModel.__init__-176"><span class="linenos">176</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.__init__-177"><a href="#LightningProxModel.__init__-177"><span class="linenos">177</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-178"><a href="#LightningProxModel.__init__-178"><span class="linenos">178</span></a>
</span><span id="LightningProxModel.__init__-179"><a href="#LightningProxModel.__init__-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_std_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-180"><a href="#LightningProxModel.__init__-180"><span class="linenos">180</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-181"><a href="#LightningProxModel.__init__-181"><span class="linenos">181</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-182"><a href="#LightningProxModel.__init__-182"><span class="linenos">182</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.__init__-183"><a href="#LightningProxModel.__init__-183"><span class="linenos">183</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-184"><a href="#LightningProxModel.__init__-184"><span class="linenos">184</span></a>
</span><span id="LightningProxModel.__init__-185"><a href="#LightningProxModel.__init__-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel.__init__-186"><a href="#LightningProxModel.__init__-186"><span class="linenos">186</span></a>                <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="LightningProxModel.__init__-187"><a href="#LightningProxModel.__init__-187"><span class="linenos">187</span></a>                <span class="n">batch_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;peak&quot;</span><span class="p">]</span>
</span><span id="LightningProxModel.__init__-188"><a href="#LightningProxModel.__init__-188"><span class="linenos">188</span></a>                <span class="k">for</span> <span class="n">batch_feature</span> <span class="ow">in</span> <span class="n">batch_features</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-189"><a href="#LightningProxModel.__init__-189"><span class="linenos">189</span></a>                    <span class="k">if</span> <span class="n">batch_feature</span> <span class="o">==</span> <span class="n">src</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-190"><a href="#LightningProxModel.__init__-190"><span class="linenos">190</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">src_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-191"><a href="#LightningProxModel.__init__-191"><span class="linenos">191</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-192"><a href="#LightningProxModel.__init__-192"><span class="linenos">192</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel.__init__-193"><a href="#LightningProxModel.__init__-193"><span class="linenos">193</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-194"><a href="#LightningProxModel.__init__-194"><span class="linenos">194</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-195"><a href="#LightningProxModel.__init__-195"><span class="linenos">195</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-196"><a href="#LightningProxModel.__init__-196"><span class="linenos">196</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-197"><a href="#LightningProxModel.__init__-197"><span class="linenos">197</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">batch_feature</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel.__init__-198"><a href="#LightningProxModel.__init__-198"><span class="linenos">198</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel.__init__-199"><a href="#LightningProxModel.__init__-199"><span class="linenos">199</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-200"><a href="#LightningProxModel.__init__-200"><span class="linenos">200</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-201"><a href="#LightningProxModel.__init__-201"><span class="linenos">201</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-202"><a href="#LightningProxModel.__init__-202"><span class="linenos">202</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-203"><a href="#LightningProxModel.__init__-203"><span class="linenos">203</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">batch_feature</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel.__init__-204"><a href="#LightningProxModel.__init__-204"><span class="linenos">204</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel.__init__-205"><a href="#LightningProxModel.__init__-205"><span class="linenos">205</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-206"><a href="#LightningProxModel.__init__-206"><span class="linenos">206</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-207"><a href="#LightningProxModel.__init__-207"><span class="linenos">207</span></a>                    <span class="k">if</span> <span class="n">batch_feature</span> <span class="o">==</span> <span class="n">dst</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-208"><a href="#LightningProxModel.__init__-208"><span class="linenos">208</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">[</span><span class="n">dst_scale_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-209"><a href="#LightningProxModel.__init__-209"><span class="linenos">209</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-210"><a href="#LightningProxModel.__init__-210"><span class="linenos">210</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel.__init__-211"><a href="#LightningProxModel.__init__-211"><span class="linenos">211</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel.__init__-212"><a href="#LightningProxModel.__init__-212"><span class="linenos">212</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-213"><a href="#LightningProxModel.__init__-213"><span class="linenos">213</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-214"><a href="#LightningProxModel.__init__-214"><span class="linenos">214</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-215"><a href="#LightningProxModel.__init__-215"><span class="linenos">215</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-216"><a href="#LightningProxModel.__init__-216"><span class="linenos">216</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel.__init__-217"><a href="#LightningProxModel.__init__-217"><span class="linenos">217</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel.__init__-218"><a href="#LightningProxModel.__init__-218"><span class="linenos">218</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-219"><a href="#LightningProxModel.__init__-219"><span class="linenos">219</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-220"><a href="#LightningProxModel.__init__-220"><span class="linenos">220</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_bias_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-221"><a href="#LightningProxModel.__init__-221"><span class="linenos">221</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-222"><a href="#LightningProxModel.__init__-222"><span class="linenos">222</span></a>                                <span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">),</span>
</span><span id="LightningProxModel.__init__-223"><a href="#LightningProxModel.__init__-223"><span class="linenos">223</span></a>                                <span class="c1"># device=self.device,</span>
</span><span id="LightningProxModel.__init__-224"><a href="#LightningProxModel.__init__-224"><span class="linenos">224</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-225"><a href="#LightningProxModel.__init__-225"><span class="linenos">225</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-226"><a href="#LightningProxModel.__init__-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span> <span class="o">=</span> <span class="n">num_neg_samples_fold</span>
</span><span id="LightningProxModel.__init__-227"><a href="#LightningProxModel.__init__-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Attributes:
    prepare_data_per_node:
        If True, each LOCAL_RANK=0 will call prepare data.
        Otherwise only NODE_RANK=0, LOCAL_RANK=0 will prepare data.
    allow_zero_length_dataloader_with_multiple_devices:
        If True, dataloader with zero length within local rank is allowed.
        Default value is False.</p>
</div>


                            </div>
                            <div id="LightningProxModel.nonneg" class="classattr">
                                <div class="attr variable">
            <span class="name">nonneg</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.nonneg"></a>
    
    

                            </div>
                            <div id="LightningProxModel.data" class="classattr">
                                <div class="attr variable">
            <span class="name">data</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.data"></a>
    
    

                            </div>
                            <div id="LightningProxModel.learning_rate" class="classattr">
                                <div class="attr variable">
            <span class="name">learning_rate</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.learning_rate"></a>
    
    

                            </div>
                            <div id="LightningProxModel.encoder" class="classattr">
                                <div class="attr variable">
            <span class="name">encoder</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.encoder"></a>
    
    

                            </div>
                            <div id="LightningProxModel.decoder" class="classattr">
                                <div class="attr variable">
            <span class="name">decoder</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.decoder"></a>
    
    

                            </div>
                            <div id="LightningProxModel.hsic" class="classattr">
                                <div class="attr variable">
            <span class="name">hsic</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.hsic"></a>
    
    

                            </div>
                            <div id="LightningProxModel.n_no_kl" class="classattr">
                                <div class="attr variable">
            <span class="name">n_no_kl</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.n_no_kl"></a>
    
    

                            </div>
                            <div id="LightningProxModel.n_count_nodes" class="classattr">
                                <div class="attr variable">
            <span class="name">n_count_nodes</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.n_count_nodes"></a>
    
    

                            </div>
                            <div id="LightningProxModel.n_kl_warmup" class="classattr">
                                <div class="attr variable">
            <span class="name">n_kl_warmup</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.n_kl_warmup"></a>
    
    

                            </div>
                            <div id="LightningProxModel.nll_scale" class="classattr">
                                <div class="attr variable">
            <span class="name">nll_scale</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.nll_scale"></a>
    
    

                            </div>
                            <div id="LightningProxModel.val_nll_scale" class="classattr">
                                <div class="attr variable">
            <span class="name">val_nll_scale</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.val_nll_scale"></a>
    
    

                            </div>
                            <div id="LightningProxModel.num_nodes_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">num_nodes_dict</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.num_nodes_dict"></a>
    
    

                            </div>
                            <div id="LightningProxModel.train_data_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">train_data_dict</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.train_data_dict"></a>
    
    

                            </div>
                            <div id="LightningProxModel.reweight_rarecell" class="classattr">
                                <div class="attr variable">
            <span class="name">reweight_rarecell</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.reweight_rarecell"></a>
    
    

                            </div>
                            <div id="LightningProxModel.edgetype_loss_weight_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">edgetype_loss_weight_dict</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.edgetype_loss_weight_dict"></a>
    
    

                            </div>
                            <div id="LightningProxModel.node_weights_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">node_weights_dict</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.node_weights_dict"></a>
    
    

                            </div>
                            <div id="LightningProxModel.bias_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">bias_dict</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.bias_dict"></a>
    
    

                            </div>
                            <div id="LightningProxModel.scale_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">scale_dict</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.scale_dict"></a>
    
    

                            </div>
                            <div id="LightningProxModel.std_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">std_dict</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.std_dict"></a>
    
    

                            </div>
                            <div id="LightningProxModel.num_neg_samples_fold" class="classattr">
                                <div class="attr variable">
            <span class="name">num_neg_samples_fold</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.num_neg_samples_fold"></a>
    
    

                            </div>
                            <div id="LightningProxModel.validation_step_outputs" class="classattr">
                                <div class="attr variable">
            <span class="name">validation_step_outputs</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.validation_step_outputs"></a>
    
    

                            </div>
                            <div id="LightningProxModel.on_train_start" class="classattr">
                                        <input id="LightningProxModel.on_train_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_start</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_train_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_train_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_train_start-229"><a href="#LightningProxModel.on_train_start-229"><span class="linenos">229</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel.on_train_start-230"><a href="#LightningProxModel.on_train_start-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightningProxModel.on_train_start-231"><a href="#LightningProxModel.on_train_start-231"><span class="linenos">231</span></a>            <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="LightningProxModel.on_train_start-232"><a href="#LightningProxModel.on_train_start-232"><span class="linenos">232</span></a>        <span class="p">}</span>
</span><span id="LightningProxModel.on_train_start-233"><a href="#LightningProxModel.on_train_start-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.on_train_start-234"><a href="#LightningProxModel.on_train_start-234"><span class="linenos">234</span></a>            <span class="n">update_lr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Called at the beginning of training after sanity check.</p>
</div>


                            </div>
                            <div id="LightningProxModel.encode" class="classattr">
                                        <input id="LightningProxModel.encode-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">encode</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.encode-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.encode"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.encode-236"><a href="#LightningProxModel.encode-236"><span class="linenos">236</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel.encode-237"><a href="#LightningProxModel.encode-237"><span class="linenos">237</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Runs the encoder and computes node-wise latent variables.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.encode-238"><a href="#LightningProxModel.encode-238"><span class="linenos">238</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Runs the encoder and computes node-wise latent variables.</p>
</div>


                            </div>
                            <div id="LightningProxModel.reparametrize" class="classattr">
                                        <input id="LightningProxModel.reparametrize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reparametrize</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.reparametrize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.reparametrize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.reparametrize-240"><a href="#LightningProxModel.reparametrize-240"><span class="linenos">240</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparametrize</span><span class="p">(</span>
</span><span id="LightningProxModel.reparametrize-241"><a href="#LightningProxModel.reparametrize-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.reparametrize-242"><a href="#LightningProxModel.reparametrize-242"><span class="linenos">242</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.reparametrize-243"><a href="#LightningProxModel.reparametrize-243"><span class="linenos">243</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.reparametrize-244"><a href="#LightningProxModel.reparametrize-244"><span class="linenos">244</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel.reparametrize-245"><a href="#LightningProxModel.reparametrize-245"><span class="linenos">245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate random z from mu, logstd&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.reparametrize-246"><a href="#LightningProxModel.reparametrize-246"><span class="linenos">246</span></a>        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.reparametrize-247"><a href="#LightningProxModel.reparametrize-247"><span class="linenos">247</span></a>        <span class="k">assert</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">logstd_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="LightningProxModel.reparametrize-248"><a href="#LightningProxModel.reparametrize-248"><span class="linenos">248</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel.reparametrize-249"><a href="#LightningProxModel.reparametrize-249"><span class="linenos">249</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="LightningProxModel.reparametrize-250"><a href="#LightningProxModel.reparametrize-250"><span class="linenos">250</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span>
</span><span id="LightningProxModel.reparametrize-251"><a href="#LightningProxModel.reparametrize-251"><span class="linenos">251</span></a>                    <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel.reparametrize-252"><a href="#LightningProxModel.reparametrize-252"><span class="linenos">252</span></a>                <span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span>
</span><span id="LightningProxModel.reparametrize-253"><a href="#LightningProxModel.reparametrize-253"><span class="linenos">253</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.reparametrize-254"><a href="#LightningProxModel.reparametrize-254"><span class="linenos">254</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel.reparametrize-255"><a href="#LightningProxModel.reparametrize-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonneg</span><span class="p">:</span>
</span><span id="LightningProxModel.reparametrize-256"><a href="#LightningProxModel.reparametrize-256"><span class="linenos">256</span></a>            <span class="n">transf</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="LightningProxModel.reparametrize-257"><a href="#LightningProxModel.reparametrize-257"><span class="linenos">257</span></a>            <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">transf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="LightningProxModel.reparametrize-258"><a href="#LightningProxModel.reparametrize-258"><span class="linenos">258</span></a>        <span class="k">return</span> <span class="n">out_dict</span>
</span></pre></div>


            <div class="docstring"><p>Generate random z from mu, logstd</p>
</div>


                            </div>
                            <div id="LightningProxModel.project" class="classattr">
                                        <input id="LightningProxModel.project-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">project</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span>,</span><span class="param">	<span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">edge_type</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.project-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.project"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.project-260"><a href="#LightningProxModel.project-260"><span class="linenos">260</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span>
</span><span id="LightningProxModel.project-261"><a href="#LightningProxModel.project-261"><span class="linenos">261</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span> <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">edge_type</span><span class="p">:</span> <span class="n">EdgeType</span>
</span><span id="LightningProxModel.project-262"><a href="#LightningProxModel.project-262"><span class="linenos">262</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel.project-263"><a href="#LightningProxModel.project-263"><span class="linenos">263</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Projects all node in z_dict of edge_type to edge-type-specific space.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.project-264"><a href="#LightningProxModel.project-264"><span class="linenos">264</span></a>        <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel.project-265"><a href="#LightningProxModel.project-265"><span class="linenos">265</span></a>        <span class="n">src_z</span> <span class="o">=</span> <span class="n">z_dict</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span>
</span><span id="LightningProxModel.project-266"><a href="#LightningProxModel.project-266"><span class="linenos">266</span></a>        <span class="n">dst_z</span> <span class="o">=</span> <span class="n">z_dict</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span>
</span><span id="LightningProxModel.project-267"><a href="#LightningProxModel.project-267"><span class="linenos">267</span></a>        <span class="k">if</span> <span class="n">src_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">add_covariate</span><span class="p">:</span>
</span><span id="LightningProxModel.project-268"><a href="#LightningProxModel.project-268"><span class="linenos">268</span></a>            <span class="n">src_z</span> <span class="o">=</span> <span class="n">add_cov_to_latent</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">src_type</span><span class="p">],</span> <span class="n">src_z</span><span class="p">)</span>
</span><span id="LightningProxModel.project-269"><a href="#LightningProxModel.project-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">dst_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">add_covariate</span><span class="p">:</span>
</span><span id="LightningProxModel.project-270"><a href="#LightningProxModel.project-270"><span class="linenos">270</span></a>            <span class="n">dst_z</span> <span class="o">=</span> <span class="n">add_cov_to_latent</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dst_type</span><span class="p">],</span> <span class="n">dst_z</span><span class="p">)</span>
</span><span id="LightningProxModel.project-271"><a href="#LightningProxModel.project-271"><span class="linenos">271</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">src_z</span><span class="p">,</span> <span class="n">dst_z</span><span class="p">,</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Projects all node in z_dict of edge_type to edge-type-specific space.</p>
</div>


                            </div>
                            <div id="LightningProxModel.relational_recon_loss" class="classattr">
                                        <input id="LightningProxModel.relational_recon_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">relational_recon_loss</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span>,</span><span class="param">	<span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">neg_sample</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">plot</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.relational_recon_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.relational_recon_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.relational_recon_loss-273"><a href="#LightningProxModel.relational_recon_loss-273"><span class="linenos">273</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_recon_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-274"><a href="#LightningProxModel.relational_recon_loss-274"><span class="linenos">274</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-275"><a href="#LightningProxModel.relational_recon_loss-275"><span class="linenos">275</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-276"><a href="#LightningProxModel.relational_recon_loss-276"><span class="linenos">276</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-277"><a href="#LightningProxModel.relational_recon_loss-277"><span class="linenos">277</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-278"><a href="#LightningProxModel.relational_recon_loss-278"><span class="linenos">278</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-279"><a href="#LightningProxModel.relational_recon_loss-279"><span class="linenos">279</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-280"><a href="#LightningProxModel.relational_recon_loss-280"><span class="linenos">280</span></a>        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-281"><a href="#LightningProxModel.relational_recon_loss-281"><span class="linenos">281</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-282"><a href="#LightningProxModel.relational_recon_loss-282"><span class="linenos">282</span></a>        <span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-283"><a href="#LightningProxModel.relational_recon_loss-283"><span class="linenos">283</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="LightningProxModel.relational_recon_loss-284"><a href="#LightningProxModel.relational_recon_loss-284"><span class="linenos">284</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate reconstruction loss by maximizing log_prob of observing edge weight in pos_edge_index_dict and 0 weight in neg_edge_index_dict</span>
</span><span id="LightningProxModel.relational_recon_loss-285"><a href="#LightningProxModel.relational_recon_loss-285"><span class="linenos">285</span></a>
</span><span id="LightningProxModel.relational_recon_loss-286"><a href="#LightningProxModel.relational_recon_loss-286"><span class="linenos">286</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel.relational_recon_loss-287"><a href="#LightningProxModel.relational_recon_loss-287"><span class="linenos">287</span></a><span class="sd">        z_dict: encoded vector</span>
</span><span id="LightningProxModel.relational_recon_loss-288"><a href="#LightningProxModel.relational_recon_loss-288"><span class="linenos">288</span></a><span class="sd">        pos_edge_index_dict: Dictionary of Tensors with shape (2, n_pos_edges)</span>
</span><span id="LightningProxModel.relational_recon_loss-289"><a href="#LightningProxModel.relational_recon_loss-289"><span class="linenos">289</span></a><span class="sd">        pos_edge_weight_dict: Dictionary of Tensors with shape (n_pos_edges,) encoding the weight of each edges.</span>
</span><span id="LightningProxModel.relational_recon_loss-290"><a href="#LightningProxModel.relational_recon_loss-290"><span class="linenos">290</span></a><span class="sd">        neg_edge_index_dict: Dictionary of Tensors with shape (2, n_neg_edges) to be used as negative edges</span>
</span><span id="LightningProxModel.relational_recon_loss-291"><a href="#LightningProxModel.relational_recon_loss-291"><span class="linenos">291</span></a><span class="sd">        num_neg_samples: If neg_edge_index is None and</span>
</span><span id="LightningProxModel.relational_recon_loss-292"><a href="#LightningProxModel.relational_recon_loss-292"><span class="linenos">292</span></a><span class="sd">            num_neg_samples is None, This number of negative edges are sampled. Otherwise, the same number as the positive edges are sample.</span>
</span><span id="LightningProxModel.relational_recon_loss-293"><a href="#LightningProxModel.relational_recon_loss-293"><span class="linenos">293</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel.relational_recon_loss-294"><a href="#LightningProxModel.relational_recon_loss-294"><span class="linenos">294</span></a>        <span class="c1"># import pdb; pdb.set_trace()</span>
</span><span id="LightningProxModel.relational_recon_loss-295"><a href="#LightningProxModel.relational_recon_loss-295"><span class="linenos">295</span></a>        <span class="n">pos_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-296"><a href="#LightningProxModel.relational_recon_loss-296"><span class="linenos">296</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-297"><a href="#LightningProxModel.relational_recon_loss-297"><span class="linenos">297</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-298"><a href="#LightningProxModel.relational_recon_loss-298"><span class="linenos">298</span></a>            <span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-299"><a href="#LightningProxModel.relational_recon_loss-299"><span class="linenos">299</span></a>            <span class="n">scale_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-300"><a href="#LightningProxModel.relational_recon_loss-300"><span class="linenos">300</span></a>            <span class="n">bias_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-301"><a href="#LightningProxModel.relational_recon_loss-301"><span class="linenos">301</span></a>            <span class="n">std_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-302"><a href="#LightningProxModel.relational_recon_loss-302"><span class="linenos">302</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-303"><a href="#LightningProxModel.relational_recon_loss-303"><span class="linenos">303</span></a>        <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-304"><a href="#LightningProxModel.relational_recon_loss-304"><span class="linenos">304</span></a>            <span class="k">if</span> <span class="n">neg_edge_index_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-305"><a href="#LightningProxModel.relational_recon_loss-305"><span class="linenos">305</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-306"><a href="#LightningProxModel.relational_recon_loss-306"><span class="linenos">306</span></a>                    <span class="n">pos_idx_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span>
</span><span id="LightningProxModel.relational_recon_loss-307"><a href="#LightningProxModel.relational_recon_loss-307"><span class="linenos">307</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-308"><a href="#LightningProxModel.relational_recon_loss-308"><span class="linenos">308</span></a>                    <span class="n">pos_idx_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_val_data</span>
</span><span id="LightningProxModel.relational_recon_loss-309"><a href="#LightningProxModel.relational_recon_loss-309"><span class="linenos">309</span></a>                <span class="n">neg_edge_index_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.relational_recon_loss-310"><a href="#LightningProxModel.relational_recon_loss-310"><span class="linenos">310</span></a>
</span><span id="LightningProxModel.relational_recon_loss-311"><a href="#LightningProxModel.relational_recon_loss-311"><span class="linenos">311</span></a>                <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">pos_edge_index</span> <span class="ow">in</span> <span class="n">pos_edge_index_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel.relational_recon_loss-312"><a href="#LightningProxModel.relational_recon_loss-312"><span class="linenos">312</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_edge_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-313"><a href="#LightningProxModel.relational_recon_loss-313"><span class="linenos">313</span></a>                        <span class="k">continue</span>
</span><span id="LightningProxModel.relational_recon_loss-314"><a href="#LightningProxModel.relational_recon_loss-314"><span class="linenos">314</span></a>                    <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel.relational_recon_loss-315"><a href="#LightningProxModel.relational_recon_loss-315"><span class="linenos">315</span></a>                    <span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-316"><a href="#LightningProxModel.relational_recon_loss-316"><span class="linenos">316</span></a>                        <span class="n">neg_src_idx</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-317"><a href="#LightningProxModel.relational_recon_loss-317"><span class="linenos">317</span></a>                        <span class="n">neg_dst_idx</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-318"><a href="#LightningProxModel.relational_recon_loss-318"><span class="linenos">318</span></a>                    <span class="p">)</span> <span class="o">=</span> <span class="n">negative_sampling</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-319"><a href="#LightningProxModel.relational_recon_loss-319"><span class="linenos">319</span></a>                        <span class="n">pos_idx_data</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-320"><a href="#LightningProxModel.relational_recon_loss-320"><span class="linenos">320</span></a>                        <span class="n">num_nodes</span><span class="o">=</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-321"><a href="#LightningProxModel.relational_recon_loss-321"><span class="linenos">321</span></a>                            <span class="n">pos_idx_data</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-322"><a href="#LightningProxModel.relational_recon_loss-322"><span class="linenos">322</span></a>                            <span class="n">pos_idx_data</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-323"><a href="#LightningProxModel.relational_recon_loss-323"><span class="linenos">323</span></a>                        <span class="p">),</span>
</span><span id="LightningProxModel.relational_recon_loss-324"><a href="#LightningProxModel.relational_recon_loss-324"><span class="linenos">324</span></a>                        <span class="c1"># num_neg_samples_fold=self.num_neg_samples_fold,</span>
</span><span id="LightningProxModel.relational_recon_loss-325"><a href="#LightningProxModel.relational_recon_loss-325"><span class="linenos">325</span></a>                        <span class="n">num_neg_samples</span><span class="o">=</span><span class="n">pos_edge_index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-326"><a href="#LightningProxModel.relational_recon_loss-326"><span class="linenos">326</span></a>                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-327"><a href="#LightningProxModel.relational_recon_loss-327"><span class="linenos">327</span></a>                        <span class="c1"># method=&quot;dense&quot;,</span>
</span><span id="LightningProxModel.relational_recon_loss-328"><a href="#LightningProxModel.relational_recon_loss-328"><span class="linenos">328</span></a>                    <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-329"><a href="#LightningProxModel.relational_recon_loss-329"><span class="linenos">329</span></a>                    <span class="c1"># if (neg_src_idx &gt; batch[src_type].num_nodes).any():  # pragma: no cover</span>
</span><span id="LightningProxModel.relational_recon_loss-330"><a href="#LightningProxModel.relational_recon_loss-330"><span class="linenos">330</span></a>                    <span class="c1">#     raise ValueError(</span>
</span><span id="LightningProxModel.relational_recon_loss-331"><a href="#LightningProxModel.relational_recon_loss-331"><span class="linenos">331</span></a>                    <span class="c1">#         f&quot;Negative sampling produced indices larger than the number of nodes in {src_type}. &quot;</span>
</span><span id="LightningProxModel.relational_recon_loss-332"><a href="#LightningProxModel.relational_recon_loss-332"><span class="linenos">332</span></a>                    <span class="c1">#         f&quot;Please check your data and the negative sampling parameters.&quot;</span>
</span><span id="LightningProxModel.relational_recon_loss-333"><a href="#LightningProxModel.relational_recon_loss-333"><span class="linenos">333</span></a>                    <span class="c1">#     )</span>
</span><span id="LightningProxModel.relational_recon_loss-334"><a href="#LightningProxModel.relational_recon_loss-334"><span class="linenos">334</span></a>                    <span class="n">neg_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-335"><a href="#LightningProxModel.relational_recon_loss-335"><span class="linenos">335</span></a>                        <span class="p">[</span><span class="n">neg_src_idx</span><span class="p">,</span> <span class="n">neg_dst_idx</span><span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-336"><a href="#LightningProxModel.relational_recon_loss-336"><span class="linenos">336</span></a>                    <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-337"><a href="#LightningProxModel.relational_recon_loss-337"><span class="linenos">337</span></a>            <span class="n">neg_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-338"><a href="#LightningProxModel.relational_recon_loss-338"><span class="linenos">338</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-339"><a href="#LightningProxModel.relational_recon_loss-339"><span class="linenos">339</span></a>                <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-340"><a href="#LightningProxModel.relational_recon_loss-340"><span class="linenos">340</span></a>                <span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-341"><a href="#LightningProxModel.relational_recon_loss-341"><span class="linenos">341</span></a>                <span class="n">scale_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-342"><a href="#LightningProxModel.relational_recon_loss-342"><span class="linenos">342</span></a>                <span class="n">bias_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-343"><a href="#LightningProxModel.relational_recon_loss-343"><span class="linenos">343</span></a>                <span class="n">std_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-344"><a href="#LightningProxModel.relational_recon_loss-344"><span class="linenos">344</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-345"><a href="#LightningProxModel.relational_recon_loss-345"><span class="linenos">345</span></a>
</span><span id="LightningProxModel.relational_recon_loss-346"><a href="#LightningProxModel.relational_recon_loss-346"><span class="linenos">346</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.relational_recon_loss-347"><a href="#LightningProxModel.relational_recon_loss-347"><span class="linenos">347</span></a>        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.relational_recon_loss-348"><a href="#LightningProxModel.relational_recon_loss-348"><span class="linenos">348</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">pos_dist</span> <span class="ow">in</span> <span class="n">pos_dist_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel.relational_recon_loss-349"><a href="#LightningProxModel.relational_recon_loss-349"><span class="linenos">349</span></a>            <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel.relational_recon_loss-350"><a href="#LightningProxModel.relational_recon_loss-350"><span class="linenos">350</span></a>            <span class="n">pos_edge_weights</span> <span class="o">=</span> <span class="n">pos_edge_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-351"><a href="#LightningProxModel.relational_recon_loss-351"><span class="linenos">351</span></a>            <span class="n">pos_log_probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">pos_edge_weights</span><span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-352"><a href="#LightningProxModel.relational_recon_loss-352"><span class="linenos">352</span></a>            <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-353"><a href="#LightningProxModel.relational_recon_loss-353"><span class="linenos">353</span></a>                <span class="n">neg_log_probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">neg_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-354"><a href="#LightningProxModel.relational_recon_loss-354"><span class="linenos">354</span></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-355"><a href="#LightningProxModel.relational_recon_loss-355"><span class="linenos">355</span></a>                    <span class="k">if</span> <span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_dist</span> <span class="o">!=</span> <span class="s2">&quot;Beta&quot;</span>
</span><span id="LightningProxModel.relational_recon_loss-356"><a href="#LightningProxModel.relational_recon_loss-356"><span class="linenos">356</span></a>                    <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-357"><a href="#LightningProxModel.relational_recon_loss-357"><span class="linenos">357</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-358"><a href="#LightningProxModel.relational_recon_loss-358"><span class="linenos">358</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span> <span class="ow">and</span> <span class="n">src_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-359"><a href="#LightningProxModel.relational_recon_loss-359"><span class="linenos">359</span></a>                <span class="n">pos_log_probs</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-360"><a href="#LightningProxModel.relational_recon_loss-360"><span class="linenos">360</span></a>                <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-361"><a href="#LightningProxModel.relational_recon_loss-361"><span class="linenos">361</span></a>                    <span class="n">neg_log_probs</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span><span class="p">[</span>
</span><span id="LightningProxModel.relational_recon_loss-362"><a href="#LightningProxModel.relational_recon_loss-362"><span class="linenos">362</span></a>                        <span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">neg_src_idx</span><span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-363"><a href="#LightningProxModel.relational_recon_loss-363"><span class="linenos">363</span></a>                    <span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-364"><a href="#LightningProxModel.relational_recon_loss-364"><span class="linenos">364</span></a>            <span class="n">pos_loss</span> <span class="o">=</span> <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel.relational_recon_loss-365"><a href="#LightningProxModel.relational_recon_loss-365"><span class="linenos">365</span></a>            <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-366"><a href="#LightningProxModel.relational_recon_loss-366"><span class="linenos">366</span></a>                <span class="n">neg_loss</span> <span class="o">=</span> <span class="n">neg_log_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel.relational_recon_loss-367"><a href="#LightningProxModel.relational_recon_loss-367"><span class="linenos">367</span></a>                <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_loss</span> <span class="o">+</span> <span class="n">neg_loss</span>
</span><span id="LightningProxModel.relational_recon_loss-368"><a href="#LightningProxModel.relational_recon_loss-368"><span class="linenos">368</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-369"><a href="#LightningProxModel.relational_recon_loss-369"><span class="linenos">369</span></a>                <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_loss</span>
</span><span id="LightningProxModel.relational_recon_loss-370"><a href="#LightningProxModel.relational_recon_loss-370"><span class="linenos">370</span></a>
</span><span id="LightningProxModel.relational_recon_loss-371"><a href="#LightningProxModel.relational_recon_loss-371"><span class="linenos">371</span></a>            <span class="k">if</span> <span class="n">get_metric</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-372"><a href="#LightningProxModel.relational_recon_loss-372"><span class="linenos">372</span></a>                <span class="k">if</span> <span class="n">edge_type</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="s2">&quot;expresses&quot;</span><span class="p">,</span> <span class="s2">&quot;gene&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel.relational_recon_loss-373"><a href="#LightningProxModel.relational_recon_loss-373"><span class="linenos">373</span></a>                    <span class="c1"># import pdb; pdb.set_trace()</span>
</span><span id="LightningProxModel.relational_recon_loss-374"><a href="#LightningProxModel.relational_recon_loss-374"><span class="linenos">374</span></a>                    <span class="n">metric_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_reconstruction_gene_metrics</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-375"><a href="#LightningProxModel.relational_recon_loss-375"><span class="linenos">375</span></a>                        <span class="n">pos_edge_weights</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-376"><a href="#LightningProxModel.relational_recon_loss-376"><span class="linenos">376</span></a>                        <span class="n">pos_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-377"><a href="#LightningProxModel.relational_recon_loss-377"><span class="linenos">377</span></a>                        <span class="n">pos_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">stddev</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-378"><a href="#LightningProxModel.relational_recon_loss-378"><span class="linenos">378</span></a>                        <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-379"><a href="#LightningProxModel.relational_recon_loss-379"><span class="linenos">379</span></a>                    <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-380"><a href="#LightningProxModel.relational_recon_loss-380"><span class="linenos">380</span></a>                    <span class="c1"># plot the pos, neg and overall log p distribution</span>
</span><span id="LightningProxModel.relational_recon_loss-381"><a href="#LightningProxModel.relational_recon_loss-381"><span class="linenos">381</span></a>                    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-382"><a href="#LightningProxModel.relational_recon_loss-382"><span class="linenos">382</span></a>                        <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-383"><a href="#LightningProxModel.relational_recon_loss-383"><span class="linenos">383</span></a>                            <span class="n">plot_nll_distributions</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-384"><a href="#LightningProxModel.relational_recon_loss-384"><span class="linenos">384</span></a>                                <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel.relational_recon_loss-385"><a href="#LightningProxModel.relational_recon_loss-385"><span class="linenos">385</span></a>                                <span class="n">neg_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel.relational_recon_loss-386"><a href="#LightningProxModel.relational_recon_loss-386"><span class="linenos">386</span></a>                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cell_express_gene&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-387"><a href="#LightningProxModel.relational_recon_loss-387"><span class="linenos">387</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-388"><a href="#LightningProxModel.relational_recon_loss-388"><span class="linenos">388</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-389"><a href="#LightningProxModel.relational_recon_loss-389"><span class="linenos">389</span></a>                            <span class="n">plot_nll_distributions</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-390"><a href="#LightningProxModel.relational_recon_loss-390"><span class="linenos">390</span></a>                                <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel.relational_recon_loss-391"><a href="#LightningProxModel.relational_recon_loss-391"><span class="linenos">391</span></a>                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cell_express_gene&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-392"><a href="#LightningProxModel.relational_recon_loss-392"><span class="linenos">392</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-393"><a href="#LightningProxModel.relational_recon_loss-393"><span class="linenos">393</span></a>
</span><span id="LightningProxModel.relational_recon_loss-394"><a href="#LightningProxModel.relational_recon_loss-394"><span class="linenos">394</span></a>                <span class="k">elif</span> <span class="n">edge_type</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="s2">&quot;has_accessible&quot;</span><span class="p">,</span> <span class="s2">&quot;peak&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel.relational_recon_loss-395"><a href="#LightningProxModel.relational_recon_loss-395"><span class="linenos">395</span></a>                    <span class="c1"># import pdb; pdb.set_trace()</span>
</span><span id="LightningProxModel.relational_recon_loss-396"><a href="#LightningProxModel.relational_recon_loss-396"><span class="linenos">396</span></a>                    <span class="k">if</span> <span class="n">get_metric</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-397"><a href="#LightningProxModel.relational_recon_loss-397"><span class="linenos">397</span></a>                        <span class="n">neg_size</span> <span class="o">=</span> <span class="n">neg_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-398"><a href="#LightningProxModel.relational_recon_loss-398"><span class="linenos">398</span></a>                        <span class="n">ground_truth</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-399"><a href="#LightningProxModel.relational_recon_loss-399"><span class="linenos">399</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-400"><a href="#LightningProxModel.relational_recon_loss-400"><span class="linenos">400</span></a>                                <span class="p">[</span>
</span><span id="LightningProxModel.relational_recon_loss-401"><a href="#LightningProxModel.relational_recon_loss-401"><span class="linenos">401</span></a>                                    <span class="n">pos_edge_weights</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-402"><a href="#LightningProxModel.relational_recon_loss-402"><span class="linenos">402</span></a>                                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-403"><a href="#LightningProxModel.relational_recon_loss-403"><span class="linenos">403</span></a>                                        <span class="n">neg_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span>
</span><span id="LightningProxModel.relational_recon_loss-404"><a href="#LightningProxModel.relational_recon_loss-404"><span class="linenos">404</span></a>                                    <span class="p">),</span>
</span><span id="LightningProxModel.relational_recon_loss-405"><a href="#LightningProxModel.relational_recon_loss-405"><span class="linenos">405</span></a>                                <span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-406"><a href="#LightningProxModel.relational_recon_loss-406"><span class="linenos">406</span></a>                                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-407"><a href="#LightningProxModel.relational_recon_loss-407"><span class="linenos">407</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-408"><a href="#LightningProxModel.relational_recon_loss-408"><span class="linenos">408</span></a>                            <span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="LightningProxModel.relational_recon_loss-409"><a href="#LightningProxModel.relational_recon_loss-409"><span class="linenos">409</span></a>                            <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="LightningProxModel.relational_recon_loss-410"><a href="#LightningProxModel.relational_recon_loss-410"><span class="linenos">410</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-411"><a href="#LightningProxModel.relational_recon_loss-411"><span class="linenos">411</span></a>                        <span class="n">pred</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-412"><a href="#LightningProxModel.relational_recon_loss-412"><span class="linenos">412</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-413"><a href="#LightningProxModel.relational_recon_loss-413"><span class="linenos">413</span></a>                                <span class="p">[</span>
</span><span id="LightningProxModel.relational_recon_loss-414"><a href="#LightningProxModel.relational_recon_loss-414"><span class="linenos">414</span></a>                                    <span class="n">pos_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-415"><a href="#LightningProxModel.relational_recon_loss-415"><span class="linenos">415</span></a>                                    <span class="n">neg_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-416"><a href="#LightningProxModel.relational_recon_loss-416"><span class="linenos">416</span></a>                                <span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-417"><a href="#LightningProxModel.relational_recon_loss-417"><span class="linenos">417</span></a>                                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-418"><a href="#LightningProxModel.relational_recon_loss-418"><span class="linenos">418</span></a>                            <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-419"><a href="#LightningProxModel.relational_recon_loss-419"><span class="linenos">419</span></a>                            <span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="LightningProxModel.relational_recon_loss-420"><a href="#LightningProxModel.relational_recon_loss-420"><span class="linenos">420</span></a>                            <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="LightningProxModel.relational_recon_loss-421"><a href="#LightningProxModel.relational_recon_loss-421"><span class="linenos">421</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-422"><a href="#LightningProxModel.relational_recon_loss-422"><span class="linenos">422</span></a>                        <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-423"><a href="#LightningProxModel.relational_recon_loss-423"><span class="linenos">423</span></a>                        <span class="n">metric_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_classification_metrics</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-424"><a href="#LightningProxModel.relational_recon_loss-424"><span class="linenos">424</span></a>                            <span class="n">ground_truth</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span>
</span><span id="LightningProxModel.relational_recon_loss-425"><a href="#LightningProxModel.relational_recon_loss-425"><span class="linenos">425</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-426"><a href="#LightningProxModel.relational_recon_loss-426"><span class="linenos">426</span></a>                    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-427"><a href="#LightningProxModel.relational_recon_loss-427"><span class="linenos">427</span></a>                        <span class="n">plot_nll_distributions</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-428"><a href="#LightningProxModel.relational_recon_loss-428"><span class="linenos">428</span></a>                            <span class="n">pos_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel.relational_recon_loss-429"><a href="#LightningProxModel.relational_recon_loss-429"><span class="linenos">429</span></a>                            <span class="n">neg_log_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span><span id="LightningProxModel.relational_recon_loss-430"><a href="#LightningProxModel.relational_recon_loss-430"><span class="linenos">430</span></a>                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cell_has_peak&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-431"><a href="#LightningProxModel.relational_recon_loss-431"><span class="linenos">431</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-432"><a href="#LightningProxModel.relational_recon_loss-432"><span class="linenos">432</span></a>
</span><span id="LightningProxModel.relational_recon_loss-433"><a href="#LightningProxModel.relational_recon_loss-433"><span class="linenos">433</span></a>        <span class="k">return</span> <span class="n">loss_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span></pre></div>


            <div class="docstring"><p>Calculate reconstruction loss by maximizing log_prob of observing edge weight in pos_edge_index_dict and 0 weight in neg_edge_index_dict</p>

<p>Args
z_dict: encoded vector
pos_edge_index_dict: Dictionary of Tensors with shape (2, n_pos_edges)
pos_edge_weight_dict: Dictionary of Tensors with shape (n_pos_edges,) encoding the weight of each edges.
neg_edge_index_dict: Dictionary of Tensors with shape (2, n_neg_edges) to be used as negative edges
num_neg_samples: If neg_edge_index is None and
    num_neg_samples is None, This number of negative edges are sampled. Otherwise, the same number as the positive edges are sample.</p>
</div>


                            </div>
                            <div id="LightningProxModel.relational_kl_divergence" class="classattr">
                                        <input id="LightningProxModel.relational_kl_divergence-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">relational_kl_divergence</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.relational_kl_divergence-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.relational_kl_divergence"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.relational_kl_divergence-468"><a href="#LightningProxModel.relational_kl_divergence-468"><span class="linenos">468</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_kl_divergence</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_kl_divergence-469"><a href="#LightningProxModel.relational_kl_divergence-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_kl_divergence-470"><a href="#LightningProxModel.relational_kl_divergence-470"><span class="linenos">470</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_kl_divergence-471"><a href="#LightningProxModel.relational_kl_divergence-471"><span class="linenos">471</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_kl_divergence-472"><a href="#LightningProxModel.relational_kl_divergence-472"><span class="linenos">472</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_kl_divergence-473"><a href="#LightningProxModel.relational_kl_divergence-473"><span class="linenos">473</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_kl_divergence-474"><a href="#LightningProxModel.relational_kl_divergence-474"><span class="linenos">474</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel.relational_kl_divergence-475"><a href="#LightningProxModel.relational_kl_divergence-475"><span class="linenos">475</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sums KL divergence across relations.</span>
</span><span id="LightningProxModel.relational_kl_divergence-476"><a href="#LightningProxModel.relational_kl_divergence-476"><span class="linenos">476</span></a>
</span><span id="LightningProxModel.relational_kl_divergence-477"><a href="#LightningProxModel.relational_kl_divergence-477"><span class="linenos">477</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel.relational_kl_divergence-478"><a href="#LightningProxModel.relational_kl_divergence-478"><span class="linenos">478</span></a><span class="sd">            z_dict: encoded vector</span>
</span><span id="LightningProxModel.relational_kl_divergence-479"><a href="#LightningProxModel.relational_kl_divergence-479"><span class="linenos">479</span></a>
</span><span id="LightningProxModel.relational_kl_divergence-480"><a href="#LightningProxModel.relational_kl_divergence-480"><span class="linenos">480</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel.relational_kl_divergence-481"><a href="#LightningProxModel.relational_kl_divergence-481"><span class="linenos">481</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.relational_kl_divergence-482"><a href="#LightningProxModel.relational_kl_divergence-482"><span class="linenos">482</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel.relational_kl_divergence-483"><a href="#LightningProxModel.relational_kl_divergence-483"><span class="linenos">483</span></a>            <span class="k">if</span> <span class="n">node_weights_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_kl_divergence-484"><a href="#LightningProxModel.relational_kl_divergence-484"><span class="linenos">484</span></a>                <span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.relational_kl_divergence-485"><a href="#LightningProxModel.relational_kl_divergence-485"><span class="linenos">485</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_kl_divergence-486"><a href="#LightningProxModel.relational_kl_divergence-486"><span class="linenos">486</span></a>                <span class="n">weight</span> <span class="o">=</span> <span class="n">node_weights_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="n">node_index_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]]</span>
</span><span id="LightningProxModel.relational_kl_divergence-487"><a href="#LightningProxModel.relational_kl_divergence-487"><span class="linenos">487</span></a>            <span class="n">loss_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_kl_divergence-488"><a href="#LightningProxModel.relational_kl_divergence-488"><span class="linenos">488</span></a>                <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">weight</span>
</span><span id="LightningProxModel.relational_kl_divergence-489"><a href="#LightningProxModel.relational_kl_divergence-489"><span class="linenos">489</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.relational_kl_divergence-490"><a href="#LightningProxModel.relational_kl_divergence-490"><span class="linenos">490</span></a>        <span class="k">return</span> <span class="n">loss_dict</span>
</span></pre></div>


            <div class="docstring"><p>Sums KL divergence across relations.</p>

<p>Args
    z_dict: encoded vector</p>
</div>


                            </div>
                            <div id="LightningProxModel.kl_div_loss" class="classattr">
                                        <input id="LightningProxModel.kl_div_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kl_div_loss</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">nodetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.kl_div_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.kl_div_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.kl_div_loss-492"><a href="#LightningProxModel.kl_div_loss-492"><span class="linenos">492</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.kl_div_loss-493"><a href="#LightningProxModel.kl_div_loss-493"><span class="linenos">493</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.kl_div_loss-494"><a href="#LightningProxModel.kl_div_loss-494"><span class="linenos">494</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.kl_div_loss-495"><a href="#LightningProxModel.kl_div_loss-495"><span class="linenos">495</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.kl_div_loss-496"><a href="#LightningProxModel.kl_div_loss-496"><span class="linenos">496</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.kl_div_loss-497"><a href="#LightningProxModel.kl_div_loss-497"><span class="linenos">497</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.kl_div_loss-498"><a href="#LightningProxModel.kl_div_loss-498"><span class="linenos">498</span></a>        <span class="n">nodetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.kl_div_loss-499"><a href="#LightningProxModel.kl_div_loss-499"><span class="linenos">499</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel.kl_div_loss-500"><a href="#LightningProxModel.kl_div_loss-500"><span class="linenos">500</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.kl_div_loss-501"><a href="#LightningProxModel.kl_div_loss-501"><span class="linenos">501</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel.kl_div_loss-502"><a href="#LightningProxModel.kl_div_loss-502"><span class="linenos">502</span></a><span class="sd">        mu_dict: mu of encoded batch</span>
</span><span id="LightningProxModel.kl_div_loss-503"><a href="#LightningProxModel.kl_div_loss-503"><span class="linenos">503</span></a><span class="sd">        logstd_dict: logstd of encoded batch</span>
</span><span id="LightningProxModel.kl_div_loss-504"><a href="#LightningProxModel.kl_div_loss-504"><span class="linenos">504</span></a><span class="sd">        node_index_dict: node index of the batch</span>
</span><span id="LightningProxModel.kl_div_loss-505"><a href="#LightningProxModel.kl_div_loss-505"><span class="linenos">505</span></a><span class="sd">        node_counts_dict: For entire dataset, counts how many times each node is used for KL div calculation. If None, assume no node has been used for the calculation.</span>
</span><span id="LightningProxModel.kl_div_loss-506"><a href="#LightningProxModel.kl_div_loss-506"><span class="linenos">506</span></a>
</span><span id="LightningProxModel.kl_div_loss-507"><a href="#LightningProxModel.kl_div_loss-507"><span class="linenos">507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel.kl_div_loss-508"><a href="#LightningProxModel.kl_div_loss-508"><span class="linenos">508</span></a>        <span class="n">kl_div_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_kl_divergence</span><span class="p">(</span>
</span><span id="LightningProxModel.kl_div_loss-509"><a href="#LightningProxModel.kl_div_loss-509"><span class="linenos">509</span></a>            <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">,</span> <span class="n">node_index_dict</span><span class="p">,</span> <span class="n">node_weights_dict</span><span class="o">=</span><span class="n">node_weights_dict</span>
</span><span id="LightningProxModel.kl_div_loss-510"><a href="#LightningProxModel.kl_div_loss-510"><span class="linenos">510</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.kl_div_loss-511"><a href="#LightningProxModel.kl_div_loss-511"><span class="linenos">511</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.kl_div_loss-512"><a href="#LightningProxModel.kl_div_loss-512"><span class="linenos">512</span></a>        <span class="k">for</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">kl_div</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel.kl_div_loss-513"><a href="#LightningProxModel.kl_div_loss-513"><span class="linenos">513</span></a>            <span class="k">if</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">:</span>
</span><span id="LightningProxModel.kl_div_loss-514"><a href="#LightningProxModel.kl_div_loss-514"><span class="linenos">514</span></a>                <span class="n">nodetype_weight</span> <span class="o">=</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel.kl_div_loss-515"><a href="#LightningProxModel.kl_div_loss-515"><span class="linenos">515</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.kl_div_loss-516"><a href="#LightningProxModel.kl_div_loss-516"><span class="linenos">516</span></a>                <span class="n">nodetype_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="LightningProxModel.kl_div_loss-517"><a href="#LightningProxModel.kl_div_loss-517"><span class="linenos">517</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">kl_div</span> <span class="o">*</span> <span class="n">nodetype_weight</span>
</span><span id="LightningProxModel.kl_div_loss-518"><a href="#LightningProxModel.kl_div_loss-518"><span class="linenos">518</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">,</span> <span class="s2">&quot;variant_emb_locs&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel.kl_div_loss-519"><a href="#LightningProxModel.kl_div_loss-519"><span class="linenos">519</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.kl_div_loss-520"><a href="#LightningProxModel.kl_div_loss-520"><span class="linenos">520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">variant_emb_locs</span><span class="p">,</span>
</span><span id="LightningProxModel.kl_div_loss-521"><a href="#LightningProxModel.kl_div_loss-521"><span class="linenos">521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">variant_emb_logstd</span><span class="p">,</span>
</span><span id="LightningProxModel.kl_div_loss-522"><a href="#LightningProxModel.kl_div_loss-522"><span class="linenos">522</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.kl_div_loss-523"><a href="#LightningProxModel.kl_div_loss-523"><span class="linenos">523</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">bernoulli_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.kl_div_loss-524"><a href="#LightningProxModel.kl_div_loss-524"><span class="linenos">524</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">variant_emb_mask_logitp</span>
</span><span id="LightningProxModel.kl_div_loss-525"><a href="#LightningProxModel.kl_div_loss-525"><span class="linenos">525</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel.kl_div_loss-526"><a href="#LightningProxModel.kl_div_loss-526"><span class="linenos">526</span></a>        <span class="k">return</span> <span class="n">l</span>
</span></pre></div>


            <div class="docstring"><p>Args
mu_dict: mu of encoded batch
logstd_dict: logstd of encoded batch
node_index_dict: node index of the batch
node_counts_dict: For entire dataset, counts how many times each node is used for KL div calculation. If None, assume no node has been used for the calculation.</p>
</div>


                            </div>
                            <div id="LightningProxModel.nll_loss" class="classattr">
                                        <input id="LightningProxModel.nll_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nll_loss</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span>,</span><span class="param">	<span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">edgetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">plot</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.nll_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.nll_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.nll_loss-528"><a href="#LightningProxModel.nll_loss-528"><span class="linenos">528</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.nll_loss-529"><a href="#LightningProxModel.nll_loss-529"><span class="linenos">529</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-530"><a href="#LightningProxModel.nll_loss-530"><span class="linenos">530</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-531"><a href="#LightningProxModel.nll_loss-531"><span class="linenos">531</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.nll_loss-532"><a href="#LightningProxModel.nll_loss-532"><span class="linenos">532</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.nll_loss-533"><a href="#LightningProxModel.nll_loss-533"><span class="linenos">533</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.nll_loss-534"><a href="#LightningProxModel.nll_loss-534"><span class="linenos">534</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-535"><a href="#LightningProxModel.nll_loss-535"><span class="linenos">535</span></a>        <span class="c1"># num_neg_samples_fold: Optional[int] = 1,</span>
</span><span id="LightningProxModel.nll_loss-536"><a href="#LightningProxModel.nll_loss-536"><span class="linenos">536</span></a>        <span class="n">edgetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-537"><a href="#LightningProxModel.nll_loss-537"><span class="linenos">537</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-538"><a href="#LightningProxModel.nll_loss-538"><span class="linenos">538</span></a>        <span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-539"><a href="#LightningProxModel.nll_loss-539"><span class="linenos">539</span></a>    <span class="p">):</span>
</span><span id="LightningProxModel.nll_loss-540"><a href="#LightningProxModel.nll_loss-540"><span class="linenos">540</span></a>        <span class="n">nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_recon_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.nll_loss-541"><a href="#LightningProxModel.nll_loss-541"><span class="linenos">541</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-542"><a href="#LightningProxModel.nll_loss-542"><span class="linenos">542</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-543"><a href="#LightningProxModel.nll_loss-543"><span class="linenos">543</span></a>            <span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-544"><a href="#LightningProxModel.nll_loss-544"><span class="linenos">544</span></a>            <span class="n">pos_edge_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-545"><a href="#LightningProxModel.nll_loss-545"><span class="linenos">545</span></a>            <span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-546"><a href="#LightningProxModel.nll_loss-546"><span class="linenos">546</span></a>            <span class="c1"># num_neg_samples_fold,</span>
</span><span id="LightningProxModel.nll_loss-547"><a href="#LightningProxModel.nll_loss-547"><span class="linenos">547</span></a>            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-548"><a href="#LightningProxModel.nll_loss-548"><span class="linenos">548</span></a>            <span class="n">get_metric</span><span class="o">=</span><span class="n">get_metric</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-549"><a href="#LightningProxModel.nll_loss-549"><span class="linenos">549</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.nll_loss-550"><a href="#LightningProxModel.nll_loss-550"><span class="linenos">550</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.nll_loss-551"><a href="#LightningProxModel.nll_loss-551"><span class="linenos">551</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel.nll_loss-552"><a href="#LightningProxModel.nll_loss-552"><span class="linenos">552</span></a>            <span class="k">if</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">:</span>
</span><span id="LightningProxModel.nll_loss-553"><a href="#LightningProxModel.nll_loss-553"><span class="linenos">553</span></a>                <span class="n">edgetype_weight</span> <span class="o">=</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel.nll_loss-554"><a href="#LightningProxModel.nll_loss-554"><span class="linenos">554</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.nll_loss-555"><a href="#LightningProxModel.nll_loss-555"><span class="linenos">555</span></a>                <span class="n">edgetype_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.nll_loss-556"><a href="#LightningProxModel.nll_loss-556"><span class="linenos">556</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">nll</span> <span class="o">*</span> <span class="n">edgetype_weight</span>
</span><span id="LightningProxModel.nll_loss-557"><a href="#LightningProxModel.nll_loss-557"><span class="linenos">557</span></a>        <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span></pre></div>


    

                            </div>
                            <div id="LightningProxModel.training_step" class="classattr">
                                        <input id="LightningProxModel.training_step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">training_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">batch</span>, </span><span class="param"><span class="n">batch_idx</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.training_step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.training_step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.training_step-559"><a href="#LightningProxModel.training_step-559"><span class="linenos">559</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel.training_step-560"><a href="#LightningProxModel.training_step-560"><span class="linenos">560</span></a>        <span class="n">edge_attr_type</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="LightningProxModel.training_step-561"><a href="#LightningProxModel.training_step-561"><span class="linenos">561</span></a>        <span class="n">edge_attr_type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">edge_attr_type</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-562"><a href="#LightningProxModel.training_step-562"><span class="linenos">562</span></a>        <span class="n">batch</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel.training_step-563"><a href="#LightningProxModel.training_step-563"><span class="linenos">563</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_type_subgraph</span><span class="p">([</span><span class="n">edge_attr_type</span><span class="p">])</span>
</span><span id="LightningProxModel.training_step-564"><a href="#LightningProxModel.training_step-564"><span class="linenos">564</span></a>            <span class="o">.</span><span class="n">edge_subgraph</span><span class="p">({</span><span class="n">edge_attr_type</span><span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)})</span>
</span><span id="LightningProxModel.training_step-565"><a href="#LightningProxModel.training_step-565"><span class="linenos">565</span></a>            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-566"><a href="#LightningProxModel.training_step-566"><span class="linenos">566</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.training_step-567"><a href="#LightningProxModel.training_step-567"><span class="linenos">567</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-568"><a href="#LightningProxModel.training_step-568"><span class="linenos">568</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-569"><a href="#LightningProxModel.training_step-569"><span class="linenos">569</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-570"><a href="#LightningProxModel.training_step-570"><span class="linenos">570</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-571"><a href="#LightningProxModel.training_step-571"><span class="linenos">571</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-572"><a href="#LightningProxModel.training_step-572"><span class="linenos">572</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-573"><a href="#LightningProxModel.training_step-573"><span class="linenos">573</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-574"><a href="#LightningProxModel.training_step-574"><span class="linenos">574</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-575"><a href="#LightningProxModel.training_step-575"><span class="linenos">575</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.training_step-576"><a href="#LightningProxModel.training_step-576"><span class="linenos">576</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-577"><a href="#LightningProxModel.training_step-577"><span class="linenos">577</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-578"><a href="#LightningProxModel.training_step-578"><span class="linenos">578</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-579"><a href="#LightningProxModel.training_step-579"><span class="linenos">579</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-580"><a href="#LightningProxModel.training_step-580"><span class="linenos">580</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-581"><a href="#LightningProxModel.training_step-581"><span class="linenos">581</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-582"><a href="#LightningProxModel.training_step-582"><span class="linenos">582</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.training_step-583"><a href="#LightningProxModel.training_step-583"><span class="linenos">583</span></a>
</span><span id="LightningProxModel.training_step-584"><a href="#LightningProxModel.training_step-584"><span class="linenos">584</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">*=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-585"><a href="#LightningProxModel.training_step-585"><span class="linenos">585</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span>
</span><span id="LightningProxModel.training_step-586"><a href="#LightningProxModel.training_step-586"><span class="linenos">586</span></a>            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-587"><a href="#LightningProxModel.training_step-587"><span class="linenos">587</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-588"><a href="#LightningProxModel.training_step-588"><span class="linenos">588</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="LightningProxModel.training_step-589"><a href="#LightningProxModel.training_step-589"><span class="linenos">589</span></a>
</span><span id="LightningProxModel.training_step-590"><a href="#LightningProxModel.training_step-590"><span class="linenos">590</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-591"><a href="#LightningProxModel.training_step-591"><span class="linenos">591</span></a>            <span class="s2">&quot;nll_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-592"><a href="#LightningProxModel.training_step-592"><span class="linenos">592</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-593"><a href="#LightningProxModel.training_step-593"><span class="linenos">593</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel.training_step-594"><a href="#LightningProxModel.training_step-594"><span class="linenos">594</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-595"><a href="#LightningProxModel.training_step-595"><span class="linenos">595</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-596"><a href="#LightningProxModel.training_step-596"><span class="linenos">596</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.training_step-597"><a href="#LightningProxModel.training_step-597"><span class="linenos">597</span></a>        <span class="c1"># Log per-batch (step) NLL in addition to per-epoch aggregation</span>
</span><span id="LightningProxModel.training_step-598"><a href="#LightningProxModel.training_step-598"><span class="linenos">598</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-599"><a href="#LightningProxModel.training_step-599"><span class="linenos">599</span></a>            <span class="s2">&quot;nll_loss_step&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-600"><a href="#LightningProxModel.training_step-600"><span class="linenos">600</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-601"><a href="#LightningProxModel.training_step-601"><span class="linenos">601</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel.training_step-602"><a href="#LightningProxModel.training_step-602"><span class="linenos">602</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-603"><a href="#LightningProxModel.training_step-603"><span class="linenos">603</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-604"><a href="#LightningProxModel.training_step-604"><span class="linenos">604</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.training_step-605"><a href="#LightningProxModel.training_step-605"><span class="linenos">605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-606"><a href="#LightningProxModel.training_step-606"><span class="linenos">606</span></a>            <span class="s2">&quot;kl_div_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-607"><a href="#LightningProxModel.training_step-607"><span class="linenos">607</span></a>            <span class="n">batch_kl_div_loss</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-608"><a href="#LightningProxModel.training_step-608"><span class="linenos">608</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel.training_step-609"><a href="#LightningProxModel.training_step-609"><span class="linenos">609</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-610"><a href="#LightningProxModel.training_step-610"><span class="linenos">610</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-611"><a href="#LightningProxModel.training_step-611"><span class="linenos">611</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.training_step-612"><a href="#LightningProxModel.training_step-612"><span class="linenos">612</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_scale</span> <span class="o">+</span> <span class="n">batch_kl_div_loss</span>
</span><span id="LightningProxModel.training_step-613"><a href="#LightningProxModel.training_step-613"><span class="linenos">613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-614"><a href="#LightningProxModel.training_step-614"><span class="linenos">614</span></a>            <span class="s2">&quot;loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-615"><a href="#LightningProxModel.training_step-615"><span class="linenos">615</span></a>            <span class="n">loss</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-616"><a href="#LightningProxModel.training_step-616"><span class="linenos">616</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel.training_step-617"><a href="#LightningProxModel.training_step-617"><span class="linenos">617</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-618"><a href="#LightningProxModel.training_step-618"><span class="linenos">618</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-619"><a href="#LightningProxModel.training_step-619"><span class="linenos">619</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.training_step-620"><a href="#LightningProxModel.training_step-620"><span class="linenos">620</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span></pre></div>


            <div class="docstring"><p>Here you compute and return the training loss and some additional metrics for e.g. the progress bar or
logger.</p>

<p>Args:
    batch: The output of your data iterable, normally a <code>~torch.utils.data.DataLoader</code>.
    batch_idx: The index of this batch.
    dataloader_idx: The index of the dataloader that produced this batch.
        (only if multiple dataloaders used)</p>

<p>Return:
    - <code>~torch.Tensor</code> - The loss tensor
    - <code>dict</code> - A dictionary which can include any keys, but must include the key <code>'loss'</code> in the case of
      automatic optimization.
    - <code>None</code> - In automatic optimization, this will skip to the next batch (but is not supported for
      multi-GPU, TPU, or DeepSpeed). For manual optimization, this has no special meaning, as returning
      the loss is not required.</p>

<p>In this step you'd normally do the forward pass and calculate the loss for a batch.
You can also do fancier things like multiple forward passes or something model specific.</p>

<p>Example::</p>

<pre><code>def training_step(self, batch, batch_idx):
    x, y, z = batch
    out = self.encoder(x)
    loss = self.loss(out, x)
    return loss
</code></pre>

<p>To use multiple optimizers, you can switch to 'manual optimization' and control their stepping:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">automatic_optimization</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># Multiple optimizers (e.g.: GANs)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">opt1</span><span class="p">,</span> <span class="n">opt2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizers</span><span class="p">()</span>

    <span class="c1"># do training_step with encoder</span>
    <span class="o">...</span>
    <span class="n">opt1</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="c1"># do training_step with decoder</span>
    <span class="o">...</span>
    <span class="n">opt2</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</code></pre>
</div>

<p>Note:
    When <code>accumulate_grad_batches</code> &gt; 1, the loss returned here will be automatically
    normalized by <code>accumulate_grad_batches</code> internally.</p>
</div>


                            </div>
                            <div id="LightningProxModel.validation_step" class="classattr">
                                        <input id="LightningProxModel.validation_step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">validation_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">batch</span>, </span><span class="param"><span class="n">batch_idx</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.validation_step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.validation_step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.validation_step-622"><a href="#LightningProxModel.validation_step-622"><span class="linenos">622</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel.validation_step-623"><a href="#LightningProxModel.validation_step-623"><span class="linenos">623</span></a>        <span class="n">edge_attr_type</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="LightningProxModel.validation_step-624"><a href="#LightningProxModel.validation_step-624"><span class="linenos">624</span></a>        <span class="n">edge_attr_type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">edge_attr_type</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-625"><a href="#LightningProxModel.validation_step-625"><span class="linenos">625</span></a>        <span class="n">batch</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel.validation_step-626"><a href="#LightningProxModel.validation_step-626"><span class="linenos">626</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">edge_type_subgraph</span><span class="p">([</span><span class="n">edge_attr_type</span><span class="p">])</span>
</span><span id="LightningProxModel.validation_step-627"><a href="#LightningProxModel.validation_step-627"><span class="linenos">627</span></a>            <span class="o">.</span><span class="n">edge_subgraph</span><span class="p">({</span><span class="n">edge_attr_type</span><span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)})</span>
</span><span id="LightningProxModel.validation_step-628"><a href="#LightningProxModel.validation_step-628"><span class="linenos">628</span></a>            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-629"><a href="#LightningProxModel.validation_step-629"><span class="linenos">629</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-630"><a href="#LightningProxModel.validation_step-630"><span class="linenos">630</span></a>
</span><span id="LightningProxModel.validation_step-631"><a href="#LightningProxModel.validation_step-631"><span class="linenos">631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="LightningProxModel.validation_step-632"><a href="#LightningProxModel.validation_step-632"><span class="linenos">632</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-633"><a href="#LightningProxModel.validation_step-633"><span class="linenos">633</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-634"><a href="#LightningProxModel.validation_step-634"><span class="linenos">634</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-635"><a href="#LightningProxModel.validation_step-635"><span class="linenos">635</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-636"><a href="#LightningProxModel.validation_step-636"><span class="linenos">636</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-637"><a href="#LightningProxModel.validation_step-637"><span class="linenos">637</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-638"><a href="#LightningProxModel.validation_step-638"><span class="linenos">638</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-639"><a href="#LightningProxModel.validation_step-639"><span class="linenos">639</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-640"><a href="#LightningProxModel.validation_step-640"><span class="linenos">640</span></a>            <span class="n">get_metric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-641"><a href="#LightningProxModel.validation_step-641"><span class="linenos">641</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-642"><a href="#LightningProxModel.validation_step-642"><span class="linenos">642</span></a>
</span><span id="LightningProxModel.validation_step-643"><a href="#LightningProxModel.validation_step-643"><span class="linenos">643</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_no_kl</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-644"><a href="#LightningProxModel.validation_step-644"><span class="linenos">644</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-645"><a href="#LightningProxModel.validation_step-645"><span class="linenos">645</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-646"><a href="#LightningProxModel.validation_step-646"><span class="linenos">646</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-647"><a href="#LightningProxModel.validation_step-647"><span class="linenos">647</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-648"><a href="#LightningProxModel.validation_step-648"><span class="linenos">648</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-649"><a href="#LightningProxModel.validation_step-649"><span class="linenos">649</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-650"><a href="#LightningProxModel.validation_step-650"><span class="linenos">650</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-651"><a href="#LightningProxModel.validation_step-651"><span class="linenos">651</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="LightningProxModel.validation_step-652"><a href="#LightningProxModel.validation_step-652"><span class="linenos">652</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span> <span class="o">+</span> <span class="n">batch_kl_div_loss</span>
</span><span id="LightningProxModel.validation_step-653"><a href="#LightningProxModel.validation_step-653"><span class="linenos">653</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-654"><a href="#LightningProxModel.validation_step-654"><span class="linenos">654</span></a>            <span class="s2">&quot;val_nll_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-655"><a href="#LightningProxModel.validation_step-655"><span class="linenos">655</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-656"><a href="#LightningProxModel.validation_step-656"><span class="linenos">656</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel.validation_step-657"><a href="#LightningProxModel.validation_step-657"><span class="linenos">657</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-658"><a href="#LightningProxModel.validation_step-658"><span class="linenos">658</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-659"><a href="#LightningProxModel.validation_step-659"><span class="linenos">659</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-660"><a href="#LightningProxModel.validation_step-660"><span class="linenos">660</span></a>        <span class="c1"># Also log per-validation-step NLL (so we can monitor batch-level val NLL)</span>
</span><span id="LightningProxModel.validation_step-661"><a href="#LightningProxModel.validation_step-661"><span class="linenos">661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-662"><a href="#LightningProxModel.validation_step-662"><span class="linenos">662</span></a>            <span class="s2">&quot;val_nll_loss_step&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-663"><a href="#LightningProxModel.validation_step-663"><span class="linenos">663</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-664"><a href="#LightningProxModel.validation_step-664"><span class="linenos">664</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel.validation_step-665"><a href="#LightningProxModel.validation_step-665"><span class="linenos">665</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-666"><a href="#LightningProxModel.validation_step-666"><span class="linenos">666</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-667"><a href="#LightningProxModel.validation_step-667"><span class="linenos">667</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-668"><a href="#LightningProxModel.validation_step-668"><span class="linenos">668</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-669"><a href="#LightningProxModel.validation_step-669"><span class="linenos">669</span></a>            <span class="s2">&quot;val_nll_loss_monitored&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-670"><a href="#LightningProxModel.validation_step-670"><span class="linenos">670</span></a>            <span class="n">batch_nll_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_nll_scale</span>
</span><span id="LightningProxModel.validation_step-671"><a href="#LightningProxModel.validation_step-671"><span class="linenos">671</span></a>            <span class="o">+</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_kl_warmup</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="LightningProxModel.validation_step-672"><a href="#LightningProxModel.validation_step-672"><span class="linenos">672</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel.validation_step-673"><a href="#LightningProxModel.validation_step-673"><span class="linenos">673</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-674"><a href="#LightningProxModel.validation_step-674"><span class="linenos">674</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-675"><a href="#LightningProxModel.validation_step-675"><span class="linenos">675</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-676"><a href="#LightningProxModel.validation_step-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-677"><a href="#LightningProxModel.validation_step-677"><span class="linenos">677</span></a>            <span class="s2">&quot;val_kl_div_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-678"><a href="#LightningProxModel.validation_step-678"><span class="linenos">678</span></a>            <span class="n">batch_kl_div_loss</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-679"><a href="#LightningProxModel.validation_step-679"><span class="linenos">679</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel.validation_step-680"><a href="#LightningProxModel.validation_step-680"><span class="linenos">680</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-681"><a href="#LightningProxModel.validation_step-681"><span class="linenos">681</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-682"><a href="#LightningProxModel.validation_step-682"><span class="linenos">682</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-683"><a href="#LightningProxModel.validation_step-683"><span class="linenos">683</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-684"><a href="#LightningProxModel.validation_step-684"><span class="linenos">684</span></a>            <span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-685"><a href="#LightningProxModel.validation_step-685"><span class="linenos">685</span></a>            <span class="n">loss</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-686"><a href="#LightningProxModel.validation_step-686"><span class="linenos">686</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
</span><span id="LightningProxModel.validation_step-687"><a href="#LightningProxModel.validation_step-687"><span class="linenos">687</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-688"><a href="#LightningProxModel.validation_step-688"><span class="linenos">688</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-689"><a href="#LightningProxModel.validation_step-689"><span class="linenos">689</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-690"><a href="#LightningProxModel.validation_step-690"><span class="linenos">690</span></a>
</span><span id="LightningProxModel.validation_step-691"><a href="#LightningProxModel.validation_step-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-692"><a href="#LightningProxModel.validation_step-692"><span class="linenos">692</span></a>
</span><span id="LightningProxModel.validation_step-693"><a href="#LightningProxModel.validation_step-693"><span class="linenos">693</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span></pre></div>


            <div class="docstring"><p>Operates on a single batch of data from the validation set. In this step you'd might generate examples or
calculate anything of interest like accuracy.</p>

<p>Args:
    batch: The output of your data iterable, normally a <code>~torch.utils.data.DataLoader</code>.
    batch_idx: The index of this batch.
    dataloader_idx: The index of the dataloader that produced this batch.
        (only if multiple dataloaders used)</p>

<p>Return:
    - <code>~torch.Tensor</code> - The loss tensor
    - <code>dict</code> - A dictionary. Can include any keys, but must include the key <code>'loss'</code>.
    - <code>None</code> - Skip to the next batch.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># if you have one val dataloader:</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span> <span class="o">...</span>


<span class="c1"># if you have multiple val dataloaders:</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataloader_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="o">...</span>
</code></pre>
</div>

<p>Examples::</p>

<pre><code># CASE 1: A single validation dataset
def validation_step(self, batch, batch_idx):
    x, y = batch

    # implement your own
    out = self(x)
    loss = self.loss(out, y)

    # log 6 example images
    # or generated text... or whatever
    sample_imgs = x[:6]
    grid = torchvision.utils.make_grid(sample_imgs)
    self.logger.experiment.add_image('example_images', grid, 0)

    # calculate acc
    labels_hat = torch.argmax(out, dim=1)
    val_acc = torch.sum(y == labels_hat).item() / (len(y) * 1.0)

    # log the outputs!
    self.log_dict({'val_loss': loss, 'val_acc': val_acc})
</code></pre>

<p>If you pass in multiple val dataloaders, <code><a href="#LightningProxModel.validation_step">validation_step()</a></code> will have an additional argument. We recommend
setting the default value of 0 so that you can quickly switch between single and multiple dataloaders.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># CASE 2: multiple validation dataloaders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataloader_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="c1"># dataloader_idx tells you which dataset this is.</span>
    <span class="o">...</span>
</code></pre>
</div>

<p>Note:
    If you don't need to validate you don't need to implement this method.</p>

<p>Note:
    When the <code><a href="#LightningProxModel.validation_step">validation_step()</a></code> is called, the model has been put in eval mode
    and PyTorch gradients have been disabled. At the end of validation,
    the model goes back to training mode and gradients are enabled.</p>
</div>


                            </div>
                            <div id="LightningProxModel.mean_cell_neighbor_distance" class="classattr">
                                        <input id="LightningProxModel.mean_cell_neighbor_distance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mean_cell_neighbor_distance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">k</span><span class="o">=</span><span class="mi">50</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.mean_cell_neighbor_distance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.mean_cell_neighbor_distance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.mean_cell_neighbor_distance-695"><a href="#LightningProxModel.mean_cell_neighbor_distance-695"><span class="linenos">695</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mean_cell_neighbor_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-696"><a href="#LightningProxModel.mean_cell_neighbor_distance-696"><span class="linenos">696</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-697"><a href="#LightningProxModel.mean_cell_neighbor_distance-697"><span class="linenos">697</span></a><span class="sd">        Calculates the mean distance between each cell node and its k nearest neighbors.</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-698"><a href="#LightningProxModel.mean_cell_neighbor_distance-698"><span class="linenos">698</span></a><span class="sd">        Returns a tensor of mean distances for each cell.</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-699"><a href="#LightningProxModel.mean_cell_neighbor_distance-699"><span class="linenos">699</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-700"><a href="#LightningProxModel.mean_cell_neighbor_distance-700"><span class="linenos">700</span></a>        <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># (num_cells, latent_dim)</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-701"><a href="#LightningProxModel.mean_cell_neighbor_distance-701"><span class="linenos">701</span></a>        <span class="c1"># Compute pairwise Euclidean distances</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-702"><a href="#LightningProxModel.mean_cell_neighbor_distance-702"><span class="linenos">702</span></a>        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="n">cell_mu</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (num_cells, num_cells)</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-703"><a href="#LightningProxModel.mean_cell_neighbor_distance-703"><span class="linenos">703</span></a>        <span class="c1"># Exclude self-distance by setting diagonal to infinity</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-704"><a href="#LightningProxModel.mean_cell_neighbor_distance-704"><span class="linenos">704</span></a>        <span class="n">dist_matrix</span><span class="o">.</span><span class="n">fill_diagonal_</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-705"><a href="#LightningProxModel.mean_cell_neighbor_distance-705"><span class="linenos">705</span></a>        <span class="c1"># Find k nearest neighbors for each cell</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-706"><a href="#LightningProxModel.mean_cell_neighbor_distance-706"><span class="linenos">706</span></a>        <span class="n">knn_distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-707"><a href="#LightningProxModel.mean_cell_neighbor_distance-707"><span class="linenos">707</span></a>        <span class="c1"># Mean distance to k nearest neighbors for each cell</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-708"><a href="#LightningProxModel.mean_cell_neighbor_distance-708"><span class="linenos">708</span></a>        <span class="n">mean_distances</span> <span class="o">=</span> <span class="n">knn_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-709"><a href="#LightningProxModel.mean_cell_neighbor_distance-709"><span class="linenos">709</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">mean_distances</span> <span class="o">/</span> <span class="n">mean_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-710"><a href="#LightningProxModel.mean_cell_neighbor_distance-710"><span class="linenos">710</span></a>        <span class="k">return</span> <span class="n">weights</span>  <span class="c1"># shape: (num_cells,)</span>
</span></pre></div>


            <div class="docstring"><p>Calculates the mean distance between each cell node and its k nearest neighbors.
Returns a tensor of mean distances for each cell.</p>
</div>


                            </div>
                            <div id="LightningProxModel.on_train_epoch_start" class="classattr">
                                        <input id="LightningProxModel.on_train_epoch_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_epoch_start</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_train_epoch_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_train_epoch_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_train_epoch_start-712"><a href="#LightningProxModel.on_train_epoch_start-712"><span class="linenos">712</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel.on_train_epoch_start-713"><a href="#LightningProxModel.on_train_epoch_start-713"><span class="linenos">713</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightningProxModel.on_train_epoch_start-714"><a href="#LightningProxModel.on_train_epoch_start-714"><span class="linenos">714</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">is_last_batch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.on_train_epoch_start-715"><a href="#LightningProxModel.on_train_epoch_start-715"><span class="linenos">715</span></a>            <span class="n">hsic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">custom_train</span><span class="p">(</span>
</span><span id="LightningProxModel.on_train_epoch_start-716"><a href="#LightningProxModel.on_train_epoch_start-716"><span class="linenos">716</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span>
</span><span id="LightningProxModel.on_train_epoch_start-717"><a href="#LightningProxModel.on_train_epoch_start-717"><span class="linenos">717</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.on_train_epoch_start-718"><a href="#LightningProxModel.on_train_epoch_start-718"><span class="linenos">718</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;hsic_loss&quot;</span><span class="p">,</span> <span class="n">hsic_loss</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.on_train_epoch_start-719"><a href="#LightningProxModel.on_train_epoch_start-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.on_train_epoch_start-720"><a href="#LightningProxModel.on_train_epoch_start-720"><span class="linenos">720</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel.on_train_epoch_start-721"><a href="#LightningProxModel.on_train_epoch_start-721"><span class="linenos">721</span></a>                <span class="s2">&quot;hsic_lr&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.on_train_epoch_start-722"><a href="#LightningProxModel.on_train_epoch_start-722"><span class="linenos">722</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel.on_train_epoch_start-723"><a href="#LightningProxModel.on_train_epoch_start-723"><span class="linenos">723</span></a>                <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.on_train_epoch_start-724"><a href="#LightningProxModel.on_train_epoch_start-724"><span class="linenos">724</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.on_train_epoch_start-725"><a href="#LightningProxModel.on_train_epoch_start-725"><span class="linenos">725</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span>
</span><span id="LightningProxModel.on_train_epoch_start-726"><a href="#LightningProxModel.on_train_epoch_start-726"><span class="linenos">726</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_cell_neighbor_distance</span><span class="p">(</span>
</span><span id="LightningProxModel.on_train_epoch_start-727"><a href="#LightningProxModel.on_train_epoch_start-727"><span class="linenos">727</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span>
</span><span id="LightningProxModel.on_train_epoch_start-728"><a href="#LightningProxModel.on_train_epoch_start-728"><span class="linenos">728</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Called in the training loop at the very beginning of the epoch.</p>
</div>


                            </div>
                            <div id="LightningProxModel.configure_optimizers" class="classattr">
                                        <input id="LightningProxModel.configure_optimizers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">configure_optimizers</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.configure_optimizers-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.configure_optimizers"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.configure_optimizers-730"><a href="#LightningProxModel.configure_optimizers-730"><span class="linenos">730</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel.configure_optimizers-731"><a href="#LightningProxModel.configure_optimizers-731"><span class="linenos">731</span></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</span><span id="LightningProxModel.configure_optimizers-732"><a href="#LightningProxModel.configure_optimizers-732"><span class="linenos">732</span></a>        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
</span><span id="LightningProxModel.configure_optimizers-733"><a href="#LightningProxModel.configure_optimizers-733"><span class="linenos">733</span></a>            <span class="n">optimizer</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-734"><a href="#LightningProxModel.configure_optimizers-734"><span class="linenos">734</span></a>            <span class="n">patience</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-735"><a href="#LightningProxModel.configure_optimizers-735"><span class="linenos">735</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.configure_optimizers-736"><a href="#LightningProxModel.configure_optimizers-736"><span class="linenos">736</span></a>        <span class="c1"># scheduler = CyclicLR(</span>
</span><span id="LightningProxModel.configure_optimizers-737"><a href="#LightningProxModel.configure_optimizers-737"><span class="linenos">737</span></a>        <span class="c1">#     optimizer,</span>
</span><span id="LightningProxModel.configure_optimizers-738"><a href="#LightningProxModel.configure_optimizers-738"><span class="linenos">738</span></a>        <span class="c1">#     self.learning_rate / 2,</span>
</span><span id="LightningProxModel.configure_optimizers-739"><a href="#LightningProxModel.configure_optimizers-739"><span class="linenos">739</span></a>        <span class="c1">#     self.learning_rate * 2,</span>
</span><span id="LightningProxModel.configure_optimizers-740"><a href="#LightningProxModel.configure_optimizers-740"><span class="linenos">740</span></a>        <span class="c1">#     step_size_up=10,</span>
</span><span id="LightningProxModel.configure_optimizers-741"><a href="#LightningProxModel.configure_optimizers-741"><span class="linenos">741</span></a>        <span class="c1">#     mode=&quot;triangular2&quot;,</span>
</span><span id="LightningProxModel.configure_optimizers-742"><a href="#LightningProxModel.configure_optimizers-742"><span class="linenos">742</span></a>        <span class="c1"># )</span>
</span><span id="LightningProxModel.configure_optimizers-743"><a href="#LightningProxModel.configure_optimizers-743"><span class="linenos">743</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">optimizer</span><span class="p">],</span> <span class="p">[</span>
</span><span id="LightningProxModel.configure_optimizers-744"><a href="#LightningProxModel.configure_optimizers-744"><span class="linenos">744</span></a>            <span class="p">{</span>
</span><span id="LightningProxModel.configure_optimizers-745"><a href="#LightningProxModel.configure_optimizers-745"><span class="linenos">745</span></a>                <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">scheduler</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-746"><a href="#LightningProxModel.configure_optimizers-746"><span class="linenos">746</span></a>                <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-747"><a href="#LightningProxModel.configure_optimizers-747"><span class="linenos">747</span></a>                <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-748"><a href="#LightningProxModel.configure_optimizers-748"><span class="linenos">748</span></a>                <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="s2">&quot;val_nll_loss&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-749"><a href="#LightningProxModel.configure_optimizers-749"><span class="linenos">749</span></a>                <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-750"><a href="#LightningProxModel.configure_optimizers-750"><span class="linenos">750</span></a>            <span class="p">}</span>
</span><span id="LightningProxModel.configure_optimizers-751"><a href="#LightningProxModel.configure_optimizers-751"><span class="linenos">751</span></a>        <span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Choose what optimizers and learning-rate schedulers to use in your optimization. Normally you'd need one.
But in the case of GANs or similar you might have multiple. Optimization with multiple optimizers only works in
the manual optimization mode.</p>

<p>Return:
    Any of these 6 options.</p>

<pre><code>- **Single optimizer**.
- **List or Tuple** of optimizers.
- **Two lists** - The first list has multiple optimizers, and the second has multiple LR schedulers
  (or multiple ``lr_scheduler_config``).
- **Dictionary**, with an ``"optimizer"`` key, and (optionally) a ``"lr_scheduler"``
  key whose value is a single LR scheduler or ``lr_scheduler_config``.
- **None** - Fit will run without any optimizer.
</code></pre>

<p>The <code>lr_scheduler_config</code> is a dictionary which contains the scheduler and its associated configuration.
The default configuration is shown below.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">lr_scheduler_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># REQUIRED: The scheduler instance</span>
    <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">lr_scheduler</span><span class="p">,</span>
    <span class="c1"># The unit of the scheduler&#39;s step size, could also be &#39;step&#39;.</span>
    <span class="c1"># &#39;epoch&#39; updates the scheduler on epoch end whereas &#39;step&#39;</span>
    <span class="c1"># updates it after a optimizer update.</span>
    <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
    <span class="c1"># How many epochs/steps should pass between calls to</span>
    <span class="c1"># `scheduler.step()`. 1 corresponds to updating the learning</span>
    <span class="c1"># rate after every epoch/step.</span>
    <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="c1"># Metric to monitor for schedulers like `ReduceLROnPlateau`</span>
    <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
    <span class="c1"># If set to `True`, will enforce that the value specified &#39;monitor&#39;</span>
    <span class="c1"># is available when the scheduler is updated, thus stopping</span>
    <span class="c1"># training if not found. If set to `False`, it will only produce a warning</span>
    <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="c1"># If using the `LearningRateMonitor` callback to monitor the</span>
    <span class="c1"># learning rate progress, this keyword can be used to specify</span>
    <span class="c1"># a custom logged name</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">}</span>
</code></pre>
</div>

<p>When there are schedulers in which the <code>.step()</code> method is conditioned on a value, such as the
<code>torch.optim.lr_scheduler.ReduceLROnPlateau</code> scheduler, Lightning requires that the
<code>lr_scheduler_config</code> contains the keyword <code>"monitor"</code> set to the metric name that the scheduler
should be conditioned on.</p>

<p>.. testcode::</p>

<pre><code># The ReduceLROnPlateau scheduler requires a monitor
def configure_optimizers(self):
    optimizer = Adam(...)
    return {
        "optimizer": optimizer,
        "lr_scheduler": {
            "scheduler": ReduceLROnPlateau(optimizer, ...),
            "monitor": "metric_to_track",
            "frequency": "indicates how often the metric is updated",
            # If "monitor" references validation metrics, then "frequency" should be set to a
            # multiple of "trainer.check_val_every_n_epoch".
        },
    }


# In the case of two optimizers, only one using the ReduceLROnPlateau scheduler
def configure_optimizers(self):
    optimizer1 = Adam(...)
    optimizer2 = SGD(...)
    scheduler1 = ReduceLROnPlateau(optimizer1, ...)
    scheduler2 = LambdaLR(optimizer2, ...)
    return (
        {
            "optimizer": optimizer1,
            "lr_scheduler": {
                "scheduler": scheduler1,
                "monitor": "metric_to_track",
            },
        },
        {"optimizer": optimizer2, "lr_scheduler": scheduler2},
    )
</code></pre>

<p>Metrics can be made available to monitor by simply logging it using
<code>self.log('metric_to_track', metric_val)</code> in your <code>~lightning.pytorch.core.LightningModule</code>.</p>

<p>Note:
    Some things to know:</p>

<pre><code>- Lightning calls ``.backward()`` and ``.step()`` automatically in case of automatic optimization.
- If a learning rate scheduler is specified in ``configure_optimizers()`` with key
  ``"interval"`` (default "epoch") in the scheduler configuration, Lightning will call
  the scheduler's ``.step()`` method automatically in case of automatic optimization.
- If you use 16-bit precision (``precision=16``), Lightning will automatically handle the optimizer.
- If you use `torch.optim.LBFGS`, Lightning handles the closure function automatically for you.
- If you use multiple optimizers, you will have to switch to 'manual optimization' mode and step them
  yourself.
- If you need to control how often the optimizer steps, override the `optimizer_step()` hook.
</code></pre>
</div>


                            </div>
                            <div id="LightningProxModel.lr_scheduler_step" class="classattr">
                                        <input id="LightningProxModel.lr_scheduler_step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">lr_scheduler_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">scheduler</span>, </span><span class="param"><span class="n">metric</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.lr_scheduler_step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.lr_scheduler_step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.lr_scheduler_step-753"><a href="#LightningProxModel.lr_scheduler_step-753"><span class="linenos">753</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">lr_scheduler_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
</span><span id="LightningProxModel.lr_scheduler_step-754"><a href="#LightningProxModel.lr_scheduler_step-754"><span class="linenos">754</span></a>        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.lr_scheduler_step-755"><a href="#LightningProxModel.lr_scheduler_step-755"><span class="linenos">755</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="LightningProxModel.lr_scheduler_step-756"><a href="#LightningProxModel.lr_scheduler_step-756"><span class="linenos">756</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.lr_scheduler_step-757"><a href="#LightningProxModel.lr_scheduler_step-757"><span class="linenos">757</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
</span><span id="LightningProxModel.lr_scheduler_step-758"><a href="#LightningProxModel.lr_scheduler_step-758"><span class="linenos">758</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.lr_scheduler_step-759"><a href="#LightningProxModel.lr_scheduler_step-759"><span class="linenos">759</span></a>            <span class="n">update_lr</span><span class="p">(</span>
</span><span id="LightningProxModel.lr_scheduler_step-760"><a href="#LightningProxModel.lr_scheduler_step-760"><span class="linenos">760</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span>
</span><span id="LightningProxModel.lr_scheduler_step-761"><a href="#LightningProxModel.lr_scheduler_step-761"><span class="linenos">761</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="LightningProxModel.lr_scheduler_step-762"><a href="#LightningProxModel.lr_scheduler_step-762"><span class="linenos">762</span></a>                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">lr_scheduler_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span>
</span><span id="LightningProxModel.lr_scheduler_step-763"><a href="#LightningProxModel.lr_scheduler_step-763"><span class="linenos">763</span></a>                    <span class="mi">0</span>
</span><span id="LightningProxModel.lr_scheduler_step-764"><a href="#LightningProxModel.lr_scheduler_step-764"><span class="linenos">764</span></a>                <span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel.lr_scheduler_step-765"><a href="#LightningProxModel.lr_scheduler_step-765"><span class="linenos">765</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Override this method to adjust the default way the <code>~lightning.pytorch.trainer.trainer.Trainer</code> calls
each scheduler. By default, Lightning calls <code>step()</code> and as shown in the example for each scheduler based on
its <code>interval</code>.</p>

<p>Args:
    scheduler: Learning rate scheduler.
    metric: Value of the monitor used for schedulers like <code>ReduceLROnPlateau</code>.</p>

<p>Examples::</p>

<pre><code># DEFAULT
def lr_scheduler_step(self, scheduler, metric):
    if metric is None:
        scheduler.step()
    else:
        scheduler.step(metric)

# Alternative way to update schedulers if it requires an epoch value
def lr_scheduler_step(self, scheduler, metric):
    scheduler.step(epoch=self.current_epoch)
</code></pre>
</div>


                            </div>
                            <div id="LightningProxModel.on_save_checkpoint" class="classattr">
                                        <input id="LightningProxModel.on_save_checkpoint-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_save_checkpoint</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">checkpoint</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_save_checkpoint-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_save_checkpoint"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_save_checkpoint-767"><a href="#LightningProxModel.on_save_checkpoint-767"><span class="linenos">767</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
</span><span id="LightningProxModel.on_save_checkpoint-768"><a href="#LightningProxModel.on_save_checkpoint-768"><span class="linenos">768</span></a>        <span class="c1"># Remove the argument from the checkpoint before it is saved</span>
</span><span id="LightningProxModel.on_save_checkpoint-769"><a href="#LightningProxModel.on_save_checkpoint-769"><span class="linenos">769</span></a>        <span class="n">checkpoint</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;train_data_dict&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Called by Lightning when saving a checkpoint to give you a chance to store anything else you might want to
save.</p>

<p>Args:
    checkpoint: The full checkpoint dictionary before it gets dumped to a file.
        Implementations of this hook can insert additional data into this dictionary.</p>

<p>Example::</p>

<pre><code>def on_save_checkpoint(self, checkpoint):
    # 99% of use cases you don't need to implement this method
    checkpoint['something_cool_i_want_to_save'] = my_cool_pickable_object
</code></pre>

<p>Note:
    Lightning saves all aspects of training (epoch, global step, etc...)
    including amp scaling.
    There is no need for you to store anything about training.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>